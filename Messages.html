<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>Mirai - Messages | mirai</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Mirai Project">
    <link rel="preload" href="/assets/css/0.styles.8a53cc28.css" as="style"><link rel="preload" href="/assets/js/app.9a24769f.js" as="script"><link rel="preload" href="/assets/js/2.182961f2.js" as="script"><link rel="preload" href="/assets/js/15.587bf681.js" as="script"><link rel="preload" href="/assets/js/3.71802cfc.js" as="script"><link rel="prefetch" href="/assets/js/10.d0ea5246.js"><link rel="prefetch" href="/assets/js/11.3487e977.js"><link rel="prefetch" href="/assets/js/12.a48eb973.js"><link rel="prefetch" href="/assets/js/13.704b3b01.js"><link rel="prefetch" href="/assets/js/14.91ee9d3d.js"><link rel="prefetch" href="/assets/js/16.31f8d50e.js"><link rel="prefetch" href="/assets/js/17.34c3c55a.js"><link rel="prefetch" href="/assets/js/18.9f0441e9.js"><link rel="prefetch" href="/assets/js/19.0f5579f9.js"><link rel="prefetch" href="/assets/js/20.af9d0560.js"><link rel="prefetch" href="/assets/js/21.1f5cbf3d.js"><link rel="prefetch" href="/assets/js/22.f2c1ad27.js"><link rel="prefetch" href="/assets/js/23.7455dc27.js"><link rel="prefetch" href="/assets/js/24.1f8c9cc9.js"><link rel="prefetch" href="/assets/js/25.34896e09.js"><link rel="prefetch" href="/assets/js/26.c7db9a2e.js"><link rel="prefetch" href="/assets/js/27.bb67f043.js"><link rel="prefetch" href="/assets/js/28.d381eb07.js"><link rel="prefetch" href="/assets/js/29.c6e57520.js"><link rel="prefetch" href="/assets/js/30.7fb7a639.js"><link rel="prefetch" href="/assets/js/31.5e922da3.js"><link rel="prefetch" href="/assets/js/32.09fec57f.js"><link rel="prefetch" href="/assets/js/33.74801ad6.js"><link rel="prefetch" href="/assets/js/34.7d454a51.js"><link rel="prefetch" href="/assets/js/4.0cbccfd1.js"><link rel="prefetch" href="/assets/js/5.74981209.js"><link rel="prefetch" href="/assets/js/6.f38e9957.js"><link rel="prefetch" href="/assets/js/7.909bf9fb.js"><link rel="prefetch" href="/assets/js/8.2b58c2f0.js"><link rel="prefetch" href="/assets/js/9.12a4bbdb.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8a53cc28.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="sidebar-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-5 ant-col-xl-5 ant-col-xxl-4"><a href="/" class="router-link-active home-link"><img src="https://raw.githubusercontent.com/mamoe/mirai/dev/docs/mirai.png" alt="mirai" class="logo"> <span class="site-name">mirai</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-19 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-submenu-selected"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          mirai-core
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          mirai-console
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <a href="https://github.com/mamoe/mirai" target="_blank" rel="noopener noreferrer" class="repo-link"><i aria-label="icon: github" class="anticon anticon-github"><svg viewBox="64 64 896 896" focusable="false" data-icon="github" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></i></a></nav></div></div> <!----></header> <aside class="sidebar"><!----> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Mirai - Messages</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Messages.html#目录" title="目录" class="sidebar-link">目录</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Messages.html#消息系统" title="消息系统" class="sidebar-link">消息系统</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Messages.html#消息类型" title="消息类型" class="sidebar-link">消息类型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Messages.html#内容" title="内容" class="sidebar-link">内容</a></li><li class="sidebar-sub-header"><a href="/Messages.html#元数据" title="元数据" class="sidebar-link">元数据</a></li></ul></li><li><a href="/Messages.html#消息元素" title="消息元素" class="sidebar-link">消息元素</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Messages.html#用法" title="用法" class="sidebar-link">用法</a></li></ul></li><li><a href="/Messages.html#消息链" title="消息链" class="sidebar-link">消息链</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Messages.html#发送消息" title="发送消息" class="sidebar-link">发送消息</a></li><li class="sidebar-sub-header"><a href="/Messages.html#构造消息链" title="构造消息链" class="sidebar-link">构造消息链</a></li><li class="sidebar-sub-header"><a href="/Messages.html#作为字符串处理消息" title="作为字符串处理消息" class="sidebar-link">作为字符串处理消息</a></li><li class="sidebar-sub-header"><a href="/Messages.html#元素唯一性" title="元素唯一性" class="sidebar-link">元素唯一性</a></li><li class="sidebar-sub-header"><a href="/Messages.html#获取消息链中的消息元素" title="获取消息链中的消息元素" class="sidebar-link">获取消息链中的消息元素</a></li><li class="sidebar-sub-header"><a href="/Messages.html#序列化" title="序列化" class="sidebar-link">序列化</a></li></ul></li><li><a href="/Messages.html#mirai-码" title="Mirai 码" class="sidebar-link">Mirai 码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Messages.html#转义规则" title="转义规则" class="sidebar-link">转义规则</a></li><li class="sidebar-sub-header"><a href="/Messages.html#组成约定" title="组成约定" class="sidebar-link">组成约定</a></li><li class="sidebar-sub-header"><a href="/Messages.html#消息链的-mirai-码" title="消息链的 mirai 码" class="sidebar-link">消息链的 mirai 码</a></li><li class="sidebar-sub-header"><a href="/Messages.html#由-codablemessage-取得-mirai-码字符串" title="由 CodableMessage 取得 mirai 码字符串" class="sidebar-link">由 CodableMessage 取得 mirai 码字符串</a></li><li class="sidebar-sub-header"><a href="/Messages.html#由-mirai-码字符串取得-messagechain-实例" title="由 mirai 码字符串取得 MessageChain 实例" class="sidebar-link">由 mirai 码字符串取得 MessageChain 实例</a></li><li class="sidebar-sub-header"><a href="/Messages.html#转义字符串" title="转义字符串" class="sidebar-link">转义字符串</a></li></ul></li></ul></section></li></ul></aside> <main class="page"> <div class="theme-antdocs-content content__default"><h1 id="mirai-messages"><a href="#mirai-messages" class="header-anchor">#</a> Mirai - Messages</h1> <h2 id="目录"><a href="#目录" class="header-anchor">#</a> 目录</h2> <ul><li><a href="#%E6%B6%88%E6%81%AF%E7%B3%BB%E7%BB%9F">消息系统</a></li> <li><a href="#%E6%B6%88%E6%81%AF%E7%B1%BB%E5%9E%8B">消息类型</a></li> <li><a href="#%E6%B6%88%E6%81%AF%E5%85%83%E7%B4%A0">消息元素</a></li> <li><a href="#%E6%B6%88%E6%81%AF%E9%93%BE">消息链</a> <ul><li><a href="#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF">发送消息</a></li> <li><a href="#%E6%9E%84%E9%80%A0%E6%B6%88%E6%81%AF%E9%93%BE">构造消息链</a></li> <li><a href="#%E5%85%83%E7%B4%A0%E5%94%AF%E4%B8%80%E6%80%A7">元素唯一性</a></li> <li><a href="#%E8%8E%B7%E5%8F%96%E6%B6%88%E6%81%AF%E9%93%BE%E4%B8%AD%E7%9A%84%E6%B6%88%E6%81%AF%E5%85%83%E7%B4%A0">获取消息链中的消息元素</a></li></ul></li> <li><a href="#mirai-%E7%A0%81">Mirai 码</a> <ul><li><a href="#%E8%BD%AC%E4%B9%89%E8%A7%84%E5%88%99">转义规则</a></li> <li><a href="#%E6%B6%88%E6%81%AF%E9%93%BE%E7%9A%84-mirai-%E7%A0%81">消息链的 mirai 码</a></li> <li><a href="#%E7%94%B1-codablemessage-%E5%8F%96%E5%BE%97-mirai-%E7%A0%81%E5%AD%97%E7%AC%A6%E4%B8%B2">由 <code>CodableMessage</code> 取得 mirai 码字符串</a></li> <li><a href="#%E7%94%B1-mirai-%E7%A0%81%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8F%96%E5%BE%97-messagechain-%E5%AE%9E%E4%BE%8B">由 mirai 码字符串取得 <code>MessageChain</code> 实例</a></li></ul></li></ul> <h2 id="消息系统"><a href="#消息系统" class="header-anchor">#</a> 消息系统</h2> <p>在 Contacts 章节提到，要发送消息，使用 <code>Contact.sendMessage(Message)</code>。<code>Message</code> 架构如下图所示。</p> <p><a href="https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoiY2xhc3NEaWFncmFtXG5cbmNsYXNzIE1lc3NhZ2VDaGFpblxuTWVzc2FnZUNoYWluIDogTGlzdH5TaW5nbGVNZXNzYWdlflxuXG5NZXNzYWdlPHwtLU1lc3NhZ2VDaGFpblxuTWVzc2FnZTx8LS1TaW5nbGVNZXNzYWdlXG5cbk1lc3NhZ2VDaGFpbiBvLS0gU2luZ2xlTWVzc2FnZVxuXG5TaW5nbGVNZXNzYWdlPHwtLU1lc3NhZ2VDb250ZW50XG5TaW5nbGVNZXNzYWdlPHwtLU1lc3NhZ2VNZXRhZGF0YVxuXG4iLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ" target="_blank" rel="noopener noreferrer"><img src="https://mermaid.ink/img/eyJjb2RlIjoiY2xhc3NEaWFncmFtXG5cbmNsYXNzIE1lc3NhZ2VDaGFpblxuTWVzc2FnZUNoYWluIDogTGlzdH5TaW5nbGVNZXNzYWdlflxuXG5NZXNzYWdlPHwtLU1lc3NhZ2VDaGFpblxuTWVzc2FnZTx8LS1TaW5nbGVNZXNzYWdlXG5cbk1lc3NhZ2VDaGFpbiBvLS0gU2luZ2xlTWVzc2FnZVxuXG5TaW5nbGVNZXNzYWdlPHwtLU1lc3NhZ2VDb250ZW50XG5TaW5nbGVNZXNzYWdlPHwtLU1lc3NhZ2VNZXRhZGF0YVxuXG4iLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ" alt=""><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><code>SingleMessage</code> 表示单个消息元素。<br> <code>MessageChain</code>（消息链） 是 <code>List&lt;SingleMessage&gt;</code>。主动发送的消息和从服务器接收消息都是 <code>MessageChain</code>。</p> <blockquote><p>回到 <a href="#%E7%9B%AE%E5%BD%95">目录</a></p></blockquote> <h2 id="消息类型"><a href="#消息类型" class="header-anchor">#</a> 消息类型</h2> <p>Mirai 支持富文本消息。</p> <p><em>单个消息元素（<code>SingleMessage</code>）</em> 分为 <em>内容（<code>MessageContent</code>）</em> 和 <em>元数据（<code>MessageMetadata</code>）</em>。</p> <p>实践中，消息内容和消息元数据会混合存在于消息链中。</p> <h3 id="内容"><a href="#内容" class="header-anchor">#</a> 内容</h3> <p><em>内容（<code>MessageContent</code>）</em> 即为 <em>纯文本</em>、<em>提及某人</em>、<em>图片</em>、<em>语音</em> 和 <em>音乐分享</em> 等<strong>有内容</strong>的数据，一条消息中必须包含内容才能发送。</p> <h3 id="元数据"><a href="#元数据" class="header-anchor">#</a> 元数据</h3> <p><em>元数据（<code>MessageMetadata</code>）</em> 包含 <em>来源</em>、<em>引用回复</em> 和 <em>秀图标识</em> 等。</p> <ul><li><em>消息来源</em>（<code>MessageSource</code>）存在于每条消息中，包含唯一识别信息，用于撤回和引用回复的定位。</li> <li><em>引用回复</em>（<code>QuoteReply</code>）若存在，则会在客户端中解析为本条消息引用了另一条消息。</li> <li><em>秀图标识</em>（<code>ShowImageFlag</code>）若存在，则表明这条消息中的图片是以秀图发送（QQ 的一个功能）。</li></ul> <p>元数据与内容的区分就在于，一条消息没有元数据也能显示，但一条消息不能没有内容。<strong>元数据是消息的属性</strong>。</p> <blockquote><p>回到 <a href="#%E7%9B%AE%E5%BD%95">目录</a></p></blockquote> <h2 id="消息元素"><a href="#消息元素" class="header-anchor">#</a> 消息元素</h2> <p>Mirai 支持多种消息类型。</p> <p>消息拥有三种转换到字符串的表示方式。</p> <table><thead><tr><th style="text-align:left;">方法</th> <th style="text-align:left;">解释</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>serializeToMiraiCode()</code></td> <td style="text-align:left;">对应的 Mirai 码. 消息的一种序列化方式，格式为 <code>[mirai:TYPE:PROP]</code>，其中 <code>TYPE</code> 为消息类型, <code>PROP</code> 为属性</td></tr> <tr><td style="text-align:left;"><code>contentToSting()</code></td> <td style="text-align:left;">QQ 对话框中以纯文本方式会显示的消息内容。无法用纯文字表示的消息会丢失信息，如任何图片都是 <code>[图片]</code></td></tr> <tr><td style="text-align:left;"><code>toString()</code></td> <td style="text-align:left;">Java 对象的 <code>toString()</code>，会尽可能包含多的信息用于调试作用，<strong>行为可能不确定</strong></td></tr></tbody></table> <p>各类型消息元素及其 <code>contentToString()</code> 如下表格所示。</p> <table><thead><tr><th style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/SingleMessage.kt"><code>MessageContent</code></a> 类型</th> <th style="text-align:left;">解释</th> <th style="text-align:left;"><code>contentToString()</code></th> <th style="text-align:center;">最低支持的版本</th></tr></thead> <tbody><tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/PlainText.kt"><code>PlainText</code></a></td> <td style="text-align:left;">纯文本</td> <td style="text-align:left;"><code>$content</code></td> <td style="text-align:center;">2.0</td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/Image.kt"><code>Image</code></a></td> <td style="text-align:left;">自定义图片</td> <td style="text-align:left;"><code>[图片]</code></td> <td style="text-align:center;">2.0</td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/At.kt"><code>At</code></a></td> <td style="text-align:left;">提及某人</td> <td style="text-align:left;"><code>@$target</code></td> <td style="text-align:center;">2.0</td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/AtAll.kt"><code>AtAll</code></a></td> <td style="text-align:left;">提及全体成员</td> <td style="text-align:left;"><code>@全体成员</code></td> <td style="text-align:center;">2.0</td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/Face.kt"><code>Face</code></a></td> <td style="text-align:left;">原生表情</td> <td style="text-align:left;"><code>[表情对应的中文名]</code></td> <td style="text-align:center;">2.0</td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/FlashImage.kt"><code>FlashImage</code></a></td> <td style="text-align:left;">闪照</td> <td style="text-align:left;"><code>[闪照]</code></td> <td style="text-align:center;">2.0</td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/PokeMessage.kt"><code>PokeMessage</code></a></td> <td style="text-align:left;">戳一戳消息（消息非动作）</td> <td style="text-align:left;"><code>[戳一戳]</code></td> <td style="text-align:center;">2.0</td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/VipFace.kt"><code>VipFace</code></a></td> <td style="text-align:left;">VIP 表情</td> <td style="text-align:left;"><code>[${kind.name}]x$count</code></td> <td style="text-align:center;">2.0</td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/RichMessage.kt"><code>LightApp</code></a></td> <td style="text-align:left;">小程序</td> <td style="text-align:left;"><code>$content</code></td> <td style="text-align:center;">2.0</td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/Voice.kt"><code>Voice</code></a></td> <td style="text-align:left;">语音</td> <td style="text-align:left;"><code>[语音消息]</code></td> <td style="text-align:center;">2.0</td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/MarketFace.kt"><code>MarketFace</code></a></td> <td style="text-align:left;">商城表情</td> <td style="text-align:left;"><code>[表情对应的中文名]</code></td> <td style="text-align:center;">2.0</td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/ForwardMessage.kt"><code>ForwardMessage</code></a></td> <td style="text-align:left;">合并转发</td> <td style="text-align:left;"><code>[转发消息]</code></td> <td style="text-align:center;">2.0  <em><sup>(1)</sup></em></td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/RichMessage.kt"><code>SimpleServiceMessage</code></a></td> <td style="text-align:left;">（不稳定）服务消息</td> <td style="text-align:left;"><code>$content</code></td> <td style="text-align:center;">2.0</td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/MusicShare.kt"><code>MusicShare</code></a></td> <td style="text-align:left;">音乐分享</td> <td style="text-align:left;"><code>[分享]曲名</code></td> <td style="text-align:center;">2.1</td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/Dice.kt"><code>Dice</code></a></td> <td style="text-align:left;">骰子</td> <td style="text-align:left;"><code>[骰子:$value]</code></td> <td style="text-align:center;">2.5</td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/FileMessage.kt"><code>FileMessage</code></a></td> <td style="text-align:left;">文件消息</td> <td style="text-align:left;"><code>[文件]文件名称</code></td> <td style="text-align:center;">2.5</td></tr></tbody></table> <blockquote><p><em>(1)</em>: <a href="../mirai-core-api/src/commonMain/kotlin/message/data/ForwardMessage.kt"><code>ForwardMessage</code></a> 在 2.0 支持发送, 在 2.3 支持接收</p></blockquote> <table><thead><tr><th style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/SingleMessage.kt"><code>MessageMetadata</code></a> 类型</th> <th style="text-align:left;">解释</th> <th style="text-align:center;">最低支持的版本</th></tr></thead> <tbody><tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/MessageSource.kt"><code>MessageSource</code></a></td> <td style="text-align:left;">消息来源元数据</td> <td style="text-align:center;">2.0</td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/QuoteReply.kt"><code>QuoteReply</code></a></td> <td style="text-align:left;">引用回复</td> <td style="text-align:center;">2.0</td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/ShowImageFlag.kt"><code>ShowImageFlag</code></a></td> <td style="text-align:left;">秀图标识</td> <td style="text-align:center;">2.2</td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/RichMessageOrigin.kt"><code>RichMessageOrigin</code></a></td> <td style="text-align:left;">富文本消息源</td> <td style="text-align:center;">2.3</td></tr></tbody></table> <h3 id="用法"><a href="#用法" class="header-anchor">#</a> 用法</h3> <p>只需要得到各种类型 <code>Message</code> 的实例就可以使用，可以直接发送（<code>Contact.sendMessage</code>）也可以连接到消息链中（<code>Message.plus</code>）。</p> <p>可在上文表格中找到需要的类型并在源码内文档获取更多实践上的帮助。</p> <blockquote><p>回到 <a href="#%E7%9B%AE%E5%BD%95">目录</a></p></blockquote> <h2 id="消息链"><a href="#消息链" class="header-anchor">#</a> 消息链</h2> <p>前文已经介绍消息链，这里简略介绍消息链的使用。详细的使用请查看源码内注释。</p> <h3 id="发送消息"><a href="#发送消息" class="header-anchor">#</a> 发送消息</h3> <p>在 <a href="/Contacts.html">Contacts 章节</a> 提到，要发送消息使用 <code>Contact.sendMessage</code>。<code>Contact.sendMessage</code> 的定义是：</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token operator">:</span> Message<span class="token punctuation">)</span><span class="token operator">:</span> MessageReceipt<span class="token operator">&lt;</span>Contact<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>要发送字符串消息，使用：（第一部分是 Kotlin，随后是 Java，下同）</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code>contact<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Hello!&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code>contact<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Hello!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>发送字符串实际上是在发送纯文本消息。上面的代码相当于：</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code>contact<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token function">PlainText</span><span class="token punctuation">(</span><span class="token string">&quot;Hello!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code>contact<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PlainText</span><span class="token punctuation">(</span><span class="token string">&quot;Hello!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>要发送多元素消息，可将消息使用 <code>plus</code> 操作连接：</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code>contact<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token function">PlainText</span><span class="token punctuation">(</span><span class="token string">&quot;你要的图片是&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">Image</span><span class="token punctuation">(</span><span class="token string">&quot;{f8f1ab55-bf8e-4236-b55e-955848d7069f}.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 一个纯文本加一个图片</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code>contact<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PlainText</span><span class="token punctuation">(</span><span class="token string">&quot;你要的图片是：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plus</span><span class="token punctuation">(</span><span class="token class-name">Image</span><span class="token punctuation">.</span><span class="token function">fromId</span><span class="token punctuation">(</span><span class="token string">&quot;{f8f1ab55-bf8e-4236-b55e-955848d7069f}.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 一个纯文本加一个图片</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="构造消息链"><a href="#构造消息链" class="header-anchor">#</a> 构造消息链</h3> <p>更复杂的消息则需要构造为消息链。</p> <h4 id="在-kotlin-构造消息链"><a href="#在-kotlin-构造消息链" class="header-anchor">#</a> 在 Kotlin 构造消息链</h4> <table><thead><tr><th style="text-align:left;">定义</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>fun Iterable&lt;Messaged&gt;.toMessageChain(): MessageChain</code></td></tr> <tr><td style="text-align:left;"><code>fun Sequence&lt;Messaged&gt;.toMessageChain(): MessageChain</code></td></tr> <tr><td style="text-align:left;"><code>fun Array&lt;Message&gt;.toMessageChain(): MessageChain</code></td></tr> <tr><td style="text-align:left;"><code>fun Message.toMessageChain(): MessageChain</code></td></tr> <tr><td style="text-align:left;"><code>fun messageChainOf(vararg Message): MessageChain</code></td></tr> <tr><td style="text-align:left;"><code>fun Message.plus(tail: Message): MessageChain</code></td></tr></tbody></table> <p>可以使用如上表格所示的方法构造，或使用 DSL builder。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>class MessageChainBuilder : MutableList&lt;SingleMessage&gt;, Appendable {
    operator fun Message.unaryPlus()
    operator fun String.unaryPlus()
    fun add(vararg messages: Message)
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> chain <span class="token operator">=</span> buildMessageChain <span class="token punctuation">{</span>
    <span class="token operator">+</span><span class="token function">PlainText</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
    <span class="token operator">+</span>AtAll
    <span class="token operator">+</span><span class="token function">Image</span><span class="token punctuation">(</span><span class="token string">&quot;/f8f1ab55-bf8e-4236-b55e-955848d7069f&quot;</span><span class="token punctuation">)</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token function">At</span><span class="token punctuation">(</span><span class="token number">123456</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// chain 结果是包含 PlainText, AtAll, Image, At 的 MessageChain</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="在-java-构造消息链"><a href="#在-java-构造消息链" class="header-anchor">#</a> 在 Java 构造消息链</h4> <table><thead><tr><th style="text-align:left;">定义</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>public static MessageChain newChain(Iterable&lt;Message&gt; iterable)</code></td></tr> <tr><td style="text-align:left;"><code>public static MessageChain newChain(Message iterable...)</code></td></tr> <tr><td style="text-align:left;"><code>public static MessageChain newChain(Iterator&lt;Message&gt; iterable...)</code></td></tr></tbody></table> <p>方法都位于 <code>net.mamoe.mirai.message.data.MessageUtils</code>。</p> <p>使用 <code>newChain</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">MessageChain</span> chain <span class="token operator">=</span> <span class="token class-name">MessageUtils</span><span class="token punctuation">.</span><span class="token function">newChain</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PlainText</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Image</span><span class="token punctuation">.</span><span class="token function">fromId</span><span class="token punctuation">(</span><span class="token string">&quot;{f8f1ab55-bf8e-4236-b55e-955848d7069f}.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用 <code>MessageChainBuilder</code>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">MessageChain</span> chain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChainBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PlainText</span><span class="token punctuation">(</span><span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 会被构造成 PlainText 再添加, 相当于上一行</span>
    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">AtAll</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">Image</span><span class="token punctuation">.</span><span class="token function">fromId</span><span class="token punctuation">(</span><span class="token string">&quot;{f8f1ab55-bf8e-4236-b55e-955848d7069f}.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>该示例中 <code>+</code> 是位于 <code>MessageChainBuilder</code> 的 <code>Message.unaryPlus</code> 扩展。使用 <code>+</code> 和使用 <code>add</code> 是相等的。</p> <h3 id="作为字符串处理消息"><a href="#作为字符串处理消息" class="header-anchor">#</a> 作为字符串处理消息</h3> <p>通常要把消息作为字符串处理，在 Kotlin 使用 <code>message.content</code> 或在 Java 使用 <code>message.contentToString()</code>。</p> <p>获取到的字符串表示只包含各 <a href="../mirai-core-api/src/commonMain/kotlin/message/data/SingleMessage.kt"><code>MessageContent</code></a> 以官方风格显示的消息内容。如 <code>&quot;你本次测试的成绩是[图片]&quot;</code>、<code>[语音]</code>、<code>[微笑]</code></p> <h3 id="元素唯一性"><a href="#元素唯一性" class="header-anchor">#</a> 元素唯一性</h3> <p>部分元素只能单一存在于消息链中。这样的元素实现接口 <a href="../mirai-core-api/src/commonMain/kotlin/message/data/ConstrainSingle.kt"><code>ConstrainSingle</code></a>。</p> <p>唯一的元素例如 <em>消息元数据</em> <a href="../mirai-core-api/src/commonMain/kotlin/message/data/MessageSource.kt"><code>MessageSource</code></a>，在连接时，新的（右侧）元素会替换旧的（左侧）元素。如：</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> source1<span class="token operator">:</span> MessageSource
<span class="token keyword">val</span> source2<span class="token operator">:</span> MessageSource

<span class="token keyword">val</span> chain<span class="token operator">:</span> MessageChain <span class="token operator">=</span> source1 <span class="token operator">+</span> source2
<span class="token comment">// 结果 chain 只包含一个元素，即右侧的 source2。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>元素唯一性的识别基于 <a href="../mirai-core-api/src/commonMain/kotlin/message/data/MessageKey.kt"><code>MessageKey</code></a>。<a href="../mirai-core-api/src/commonMain/kotlin/message/data/MessageKey.kt"><code>MessageKey</code></a> 拥有多态机制。元素替换时会替换。如 <a href="../mirai-core-api/src/commonMain/kotlin/message/data/HummerMessage.kt"><code>HummerMessage</code></a> 的继承关系</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>              MessageContent
                    ↑
              HummerMessage
                    ↑
       +------------+-------------+------------+
       |            |             |            |
 PokeMessage     VipFace      FlashImage      ...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>当连接一个 <a href="../mirai-core-api/src/commonMain/kotlin/message/data/VipFace.kt"><code>VipFace</code></a> 到一个 <a href="../mirai-core-api/src/commonMain/kotlin/message/data/MessageChain.kt"><code>MessageChain</code></a> 时，由于 <a href="../mirai-core-api/src/commonMain/kotlin/message/data/VipFace.kt"><code>VipFace</code></a> 最上层为 <code>MessageContent</code>，消息链中第一个 <code>MessageContent</code> 会被（保留顺序地）替换为 <a href="../mirai-core-api/src/commonMain/kotlin/message/data/VipFace.kt"><code>VipFace</code></a>，其他所有 <code>MessageContent</code> 都会被删除。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> chain <span class="token operator">=</span> <span class="token function">messageChainOf</span><span class="token punctuation">(</span>quoteReply<span class="token punctuation">,</span> plainText<span class="token punctuation">,</span> at<span class="token punctuation">,</span> atAll<span class="token punctuation">)</span> <span class="token comment">// quoteReply 是 MessageMetadata, 其他三个都是 MessageContent</span>
<span class="token keyword">val</span> result <span class="token operator">=</span> chain <span class="token operator">+</span> <span class="token function">VipFace</span><span class="token punctuation">(</span>VipFace<span class="token punctuation">.</span>AiXin<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// VipFace 是 ConstrainSingle，最上层键为 MessageContent，因此替换所有的 MessageContent</span>
<span class="token comment">// 结果为 [quoteReply, VipFace]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="获取消息链中的消息元素"><a href="#获取消息链中的消息元素" class="header-anchor">#</a> 获取消息链中的消息元素</h3> <h4 id="a-筛选-list"><a href="#a-筛选-list" class="header-anchor">#</a> A. 筛选 List</h4> <p><a href="../mirai-core-api/src/commonMain/kotlin/message/data/MessageChain.kt"><code>MessageChain</code></a> 继承接口 <code>List&lt;SingleMessage&gt;</code>。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> image<span class="token operator">:</span> Image<span class="token operator">?</span> <span class="token operator">=</span> chain<span class="token punctuation">.</span>filterIsInstance<span class="token operator">&lt;</span>Image<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">firstOrNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Image</span> image <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Image</span><span class="token punctuation">)</span> chain<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Image</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token operator">::</span><span class="token function">isInstance</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在 Kotlin 要获取第一个指定类型实例还可以使用快捷扩展。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> image<span class="token operator">:</span> Image<span class="token operator">?</span> <span class="token operator">=</span> chain<span class="token punctuation">.</span>findIsInstance<span class="token operator">&lt;</span>Image<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> image<span class="token operator">:</span> Image <span class="token operator">=</span> chain<span class="token punctuation">.</span>firstIsInstance<span class="token operator">&lt;</span>Image<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 不存在时 NoSuchElementException</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="b-获取唯一消息"><a href="#b-获取唯一消息" class="header-anchor">#</a> B. 获取唯一消息</h4> <p>如果要获取 <code>ConstrainSingle</code> 的消息元素，可以快速通过键获得。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> quote<span class="token operator">:</span> QuoteReply<span class="token operator">?</span> <span class="token operator">=</span> chain<span class="token punctuation">[</span>QuoteReply<span class="token punctuation">]</span> <span class="token comment">// 类似 Map.get</span>
<span class="token keyword">val</span> quote<span class="token operator">:</span> QuoteReply <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">getOrFail</span><span class="token punctuation">(</span>QuoteReply<span class="token punctuation">)</span> <span class="token comment">// 不存在时 NoSuchElementException</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">QuoteReply</span> quote <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">QuoteReply<span class="token punctuation">.</span>Key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>这是因为 <code>MessageKey</code> 一般都以消息元素的 <code>companion object</code> 实现</p></blockquote> <h4 id="c-使用属性委托"><a href="#c-使用属性委托" class="header-anchor">#</a> C. 使用属性委托</h4> <p>可在 Kotlin 使用属性委托。这样的方法与上述方法在性能上等价。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> image<span class="token operator">:</span> Image <span class="token keyword">by</span> chain <span class="token comment">// 不存在时 NoSuchElementException</span>
<span class="token keyword">val</span> image<span class="token operator">:</span> Image<span class="token operator">?</span> <span class="token keyword">by</span> chain<span class="token punctuation">.</span><span class="token function">orNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> image<span class="token operator">:</span> Image<span class="token operator">?</span> <span class="token keyword">by</span> chain<span class="token punctuation">.</span><span class="token function">orElse</span> <span class="token punctuation">{</span> <span class="token comment">/* 返回一个 Image */</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="序列化"><a href="#序列化" class="header-anchor">#</a> 序列化</h3> <p>消息可以序列化为 JSON 字符串，使用 <code>MessageChain.serializeToJsonString</code> 和 <code>MessageChain.deserializeFromJsonString</code>。</p> <h2 id="mirai-码"><a href="#mirai-码" class="header-anchor">#</a> Mirai 码</h2> <p>实现了接口 <code>CodableMessage</code> 的消息类型支持 mirai 码表示。</p> <h3 id="转义规则"><a href="#转义规则" class="header-anchor">#</a> 转义规则</h3> <p>mirai 码内的属性字符串会被转义。</p> <table><thead><tr><th style="text-align:center;">原字符</th> <th style="text-align:center;">转义结果字符</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>[</code></td> <td style="text-align:center;"><code>\[</code></td></tr> <tr><td style="text-align:center;"><code>]</code></td> <td style="text-align:center;"><code>\]</code></td></tr> <tr><td style="text-align:center;"><code>:</code></td> <td style="text-align:center;"><code>\:</code></td></tr> <tr><td style="text-align:center;"><code>,</code></td> <td style="text-align:center;"><code>\,</code></td></tr> <tr><td style="text-align:center;"><code>\</code></td> <td style="text-align:center;"><code>\\</code></td></tr> <tr><td style="text-align:center;"><em>换行符 \n</em></td> <td style="text-align:center;"><code>\n</code></td></tr> <tr><td style="text-align:center;"><em>换行符 \r</em></td> <td style="text-align:center;"><code>\r</code></td></tr></tbody></table> <h3 id="组成约定"><a href="#组成约定" class="header-anchor">#</a> 组成约定</h3> <p>一个有效的 mirai 码 (如 <code>[mirai:atall]</code> (无参数), <code>[mirai:at:123]</code> (有参数)) 可分为以下几个组成部分</p> <ul><li><code>[mirai:</code> 固定开头</li> <li>消息类型， 如 <code>at</code></li> <li>消息参数
<ul><li><code>:</code> 固定分隔符</li> <li>参数内容 <strong>(需要进行转义)</strong></li></ul></li> <li><code>]</code> 固定结尾</li></ul> <h4 id="为何需要进行转义"><a href="#为何需要进行转义" class="header-anchor">#</a> 为何需要进行转义</h4> <p>为了 mirai 码的正确解析, 不转义无法正确解析原本意义</p> <p>假如有以下参数</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{&quot;msg&quot;: [1, 2, 3]}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果不进行转义直接进行 mirai 码拼接 (如: <code>[mirai:msg:{&quot;msg&quot;: [1, 2, 3]}]</code>), 那么 mirai 码会被错误解析</p> <blockquote><p>解析结果如下:</p> <ul><li>mirai 码 <code>[mirai:msg:{&quot;msg&quot;: [1, 2, 3]</code></li> <li>纯文本 <code>}]</code></li></ul></blockquote> <h3 id="消息链的-mirai-码"><a href="#消息链的-mirai-码" class="header-anchor">#</a> 消息链的 mirai 码</h3> <p>消息链 <a href="../mirai-core-api/src/commonMain/kotlin/message/data/MessageChain.kt"><code>MessageChain</code></a> 是多个 <a href="../mirai-core-api/src/commonMain/kotlin/message/data/SingleMessage.kt"><code>SingleMessage</code></a> 的集合。<a href="../mirai-core-api/src/commonMain/kotlin/message/data/MessageChain.kt"><code>MessageChain</code></a> 也实现 <a href="../mirai-core-api/src/commonMain/kotlin/message/code/CodableMessage.kt"><code>CodableMessage</code></a>。在转换为 mirai 码时所有 <a href="../mirai-core-api/src/commonMain/kotlin/message/code/CodableMessage.kt"><code>CodableMessage</code></a> 直接相连：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>val chain = messageChainOf(PlainText(&quot;plain&quot;), At(123), AtAll)

chain.serializeToMiraiCode() // &quot;plain[mirai:at:123][mirai:atall]&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="由-codablemessage-取得-mirai-码字符串"><a href="#由-codablemessage-取得-mirai-码字符串" class="header-anchor">#</a> 由 <code>CodableMessage</code> 取得 mirai 码字符串</h3> <p>通过 <code>CodableMessage.serializeToMiraiCode()</code>。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>val at = At(123)

at.serializeToMiraiCode() // 结果为 `[mirai:at:123]`
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><table><thead><tr><th style="text-align:center;">消息类型</th> <th style="text-align:left;"><code>serializeToMiraiCode()</code></th></tr></thead> <tbody><tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/PlainText.kt"><code>PlainText</code></a></td> <td style="text-align:left;"><code>$content</code></td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/Image.kt"><code>Image</code></a></td> <td style="text-align:left;"><code>[mirai:image:$imageId]</code></td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/At.kt"><code>At</code></a></td> <td style="text-align:left;"><code>[mirai:at:$target]</code></td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/AtAll.kt"><code>AtAll</code></a></td> <td style="text-align:left;"><code>[mirai:atall]</code></td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/Face.kt"><code>Face</code></a></td> <td style="text-align:left;"><code>[mirai:face:id]</code></td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/FlashImage.kt"><code>FlashImage</code></a></td> <td style="text-align:left;"><code>[mirai:flash:${image.imageId}]</code></td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/PokeMessage.kt"><code>PokeMessage</code></a></td> <td style="text-align:left;"><code>[mirai:poke:$name,$pokeType,$id]</code></td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/VipFace.kt"><code>VipFace</code></a></td> <td style="text-align:left;"><code>[mirai:vipface:${kind.id},${kind.name},$count]</code></td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/RichMessage.kt"><code>LightApp</code></a></td> <td style="text-align:left;"><code>[mirai:app:$content]</code></td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/RichMessage.kt"><code>SimpleServiceMessage</code></a></td> <td style="text-align:left;"><code>[mirai:service:$serviceId,$content]</code></td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/Dice.kt"><code>Dice</code></a></td> <td style="text-align:left;"><code>[mirai:dice:$value]</code></td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/MusicShare.kt"><code>MusicShare</code></a></td> <td style="text-align:left;"><code>[mirai:musicshare:$args]</code></td></tr> <tr><td style="text-align:center;"><a href="../mirai-core-api/src/commonMain/kotlin/message/data/FileMessage.kt"><code>FileMessage</code></a></td> <td style="text-align:left;"><code>[mirai:file:$id,$internalId,$name,$size]</code></td></tr></tbody></table> <h3 id="由-mirai-码字符串取得-messagechain-实例"><a href="#由-mirai-码字符串取得-messagechain-实例" class="header-anchor">#</a> 由 mirai 码字符串取得 <code>MessageChain</code> 实例</h3> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> chain <span class="token operator">=</span> <span class="token string">&quot;[mirai:atall]&quot;</span><span class="token punctuation">.</span><span class="token function">deserializeMiraiCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">MessageChain</span> chain <span class="token operator">=</span> <span class="token class-name">MiraiCode</span><span class="token punctuation">.</span><span class="token function">deserializeFromMiraiCode</span><span class="token punctuation">(</span><span class="token string">&quot;[mirai:atall]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="转义字符串"><a href="#转义字符串" class="header-anchor">#</a> 转义字符串</h3> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token function">PlainText</span><span class="token punctuation">(</span><span class="token string">&quot;[mirai:atall]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serializeToMiraiCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// \[mirai\:atall\]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">PlainText</span><span class="token punctuation">(</span><span class="token string">&quot;[mirai:atall]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serializeToMiraiCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// \[mirai\:atall\]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><hr> <p>到这里，你已经完成了 Mirai 所有文档的阅读。现在你已经熟悉了 Mirai，并可以开始使用了。</p> <p>你可以首先构造 Bot，登录，然后从监听事件起开始创建你的机器人，或从 Bot 获取到指定群主动发送消息。在使用中遇到问题可以参考 Mirai 源码内注释，该注释会包含更多实践上的帮助。</p> <p>如果你仍然对 Mirai 架构有不明确的地方，欢迎在 <a href="https://github.com/mamoe/mirai/discussions/848" target="_blank" rel="noopener noreferrer">#848<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 提出建议，或者直接在 PR 提交你的修改。</p> <blockquote><p>回到 <a href="#%E7%9B%AE%E5%BD%95">目录</a></p> <p><a href="/CoreAPI.html">回到 Mirai 文档索引</a></p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main> <!----></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.9a24769f.js" defer></script><script src="/assets/js/2.182961f2.js" defer></script><script src="/assets/js/15.587bf681.js" defer></script><script src="/assets/js/3.71802cfc.js" defer></script>
  </body>
</html>