<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.48">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>Mirai - Events | mirai</title><meta name="description" content="Mirai Project">
    <link rel="modulepreload" href="/assets/app.ee53b164.js"><link rel="modulepreload" href="/assets/Events.html.16fbb5af.js"><link rel="modulepreload" href="/assets/Events.html.ff67a963.js"><link rel="prefetch" href="/assets/Bots.html.4e2868d9.js"><link rel="prefetch" href="/assets/ConciseAPI.html.a7d78756.js"><link rel="prefetch" href="/assets/ConfiguringProjects.html.5c8949fa.js"><link rel="prefetch" href="/assets/ConsoleTerminal.html.f3c65212.js"><link rel="prefetch" href="/assets/Contacts.html.2780bb26.js"><link rel="prefetch" href="/assets/CoreAPI.html.8e308f7a.js"><link rel="prefetch" href="/assets/DebuggingNetwork.html.0053a429.js"><link rel="prefetch" href="/assets/EventList.html.40413e00.js"><link rel="prefetch" href="/assets/Evolution.html.7ec2ba1c.js"><link rel="prefetch" href="/assets/KotlinAndJava.html.ea914b75.js"><link rel="prefetch" href="/assets/Messages.html.97e42be7.js"><link rel="prefetch" href="/assets/MigrationFrom1x.html.832d13fd.js"><link rel="prefetch" href="/assets/Preparations.html.51671e23.js"><link rel="prefetch" href="/assets/index.html.d1fd7fad.js"><link rel="prefetch" href="/assets/UserManual.html.70063bd3.js"><link rel="prefetch" href="/assets/UsingSnapshots.html.57cabb94.js"><link rel="prefetch" href="/assets/mirai-ecology.html.37829cd0.js"><link rel="prefetch" href="/assets/Appendix.html.29bccdb2.js"><link rel="prefetch" href="/assets/BuiltInCommands.html.50cbfaf5.js"><link rel="prefetch" href="/assets/Commands.html.044a3aa8.js"><link rel="prefetch" href="/assets/ConfiguringProjects.html.2e1b8301.js"><link rel="prefetch" href="/assets/Contributing.html.d60209a9.js"><link rel="prefetch" href="/assets/Extensions.html.32ddc646.js"><link rel="prefetch" href="/assets/FrontEnd.html.c513236d.js"><link rel="prefetch" href="/assets/Logging.html.a6570352.js"><link rel="prefetch" href="/assets/Permissions.html.e321d525.js"><link rel="prefetch" href="/assets/PluginData.html.a0e22eb9.js"><link rel="prefetch" href="/assets/QA.html.6eeef55b.js"><link rel="prefetch" href="/assets/index.html.c596c4e8.js"><link rel="prefetch" href="/assets/Run.html.3b02c91d.js"><link rel="prefetch" href="/assets/BuildingCore.html.31fe91e2.js"><link rel="prefetch" href="/assets/ImplementingProtocol.html.8d36dd39.js"><link rel="prefetch" href="/assets/index.html.00fc025c.js"><link rel="prefetch" href="/assets/VerifyingABI.html.a6ab27d6.js"><link rel="prefetch" href="/assets/Module.html.30cd0774.js"><link rel="prefetch" href="/assets/Plugin.html.b0e169e3.js"><link rel="prefetch" href="/assets/index.html.d7c9f215.js"><link rel="prefetch" href="/assets/index.html.3c570d43.js"><link rel="prefetch" href="/assets/index.html.b0de09ee.js"><link rel="prefetch" href="/assets/Contacts.mermaid.html.a1ebcdf8.js"><link rel="prefetch" href="/assets/Messages.mermaid.html.1ceae85b.js"><link rel="prefetch" href="/assets/JVMPlugin-Appendix.html.30503fd0.js"><link rel="prefetch" href="/assets/JVMPlugin-DataExchange.html.e3bd96d2.js"><link rel="prefetch" href="/assets/JVMPlugin-Debug.html.1373b734.js"><link rel="prefetch" href="/assets/JVMPlugin.html.00b48355.js"><link rel="prefetch" href="/assets/Plugins.html.f9e73a66.js"><link rel="prefetch" href="/assets/Adapter.html.e3609f9a.js"><link rel="prefetch" href="/assets/CustomizedAdapter.html.d79ece6c.js"><link rel="prefetch" href="/assets/HttpAdapter.html.5d1ccc04.js"><link rel="prefetch" href="/assets/ReverseWebsocketAdapter.html.fd95e5ae.js"><link rel="prefetch" href="/assets/WebhookAdapter.html.043a9c43.js"><link rel="prefetch" href="/assets/WebsocketAdapter.html.6a90e3d7.js"><link rel="prefetch" href="/assets/API.html.ea4addf9.js"><link rel="prefetch" href="/assets/EventType.html.9223bbb6.js"><link rel="prefetch" href="/assets/MessageType.html.97ab6b0a.js"><link rel="prefetch" href="/assets/Migration2.html.d51f268d.js"><link rel="prefetch" href="/assets/404.html.7d858b3d.js"><link rel="prefetch" href="/assets/Bots.html.dce69358.js"><link rel="prefetch" href="/assets/ConciseAPI.html.bd5b89e3.js"><link rel="prefetch" href="/assets/ConfiguringProjects.html.37c770cf.js"><link rel="prefetch" href="/assets/ConsoleTerminal.html.4618cb82.js"><link rel="prefetch" href="/assets/Contacts.html.8c3b803f.js"><link rel="prefetch" href="/assets/CoreAPI.html.bbada0ae.js"><link rel="prefetch" href="/assets/DebuggingNetwork.html.04938270.js"><link rel="prefetch" href="/assets/EventList.html.1181975e.js"><link rel="prefetch" href="/assets/Evolution.html.55a699e7.js"><link rel="prefetch" href="/assets/KotlinAndJava.html.18f6469d.js"><link rel="prefetch" href="/assets/Messages.html.4d1d329b.js"><link rel="prefetch" href="/assets/MigrationFrom1x.html.5941c2b3.js"><link rel="prefetch" href="/assets/Preparations.html.696d71c7.js"><link rel="prefetch" href="/assets/index.html.5b240f9e.js"><link rel="prefetch" href="/assets/UserManual.html.6b014443.js"><link rel="prefetch" href="/assets/UsingSnapshots.html.870af14b.js"><link rel="prefetch" href="/assets/mirai-ecology.html.a85928be.js"><link rel="prefetch" href="/assets/Appendix.html.c0bda3a6.js"><link rel="prefetch" href="/assets/BuiltInCommands.html.bc17f554.js"><link rel="prefetch" href="/assets/Commands.html.91d11e86.js"><link rel="prefetch" href="/assets/ConfiguringProjects.html.b5d71509.js"><link rel="prefetch" href="/assets/Contributing.html.afa8ab78.js"><link rel="prefetch" href="/assets/Extensions.html.19c27861.js"><link rel="prefetch" href="/assets/FrontEnd.html.cae4157f.js"><link rel="prefetch" href="/assets/Logging.html.a63a4ed3.js"><link rel="prefetch" href="/assets/Permissions.html.aa2ea9c9.js"><link rel="prefetch" href="/assets/PluginData.html.4769d30c.js"><link rel="prefetch" href="/assets/QA.html.ded61a3b.js"><link rel="prefetch" href="/assets/index.html.672258ed.js"><link rel="prefetch" href="/assets/Run.html.62d9ba65.js"><link rel="prefetch" href="/assets/BuildingCore.html.8b6df034.js"><link rel="prefetch" href="/assets/ImplementingProtocol.html.9f854387.js"><link rel="prefetch" href="/assets/index.html.951e8dbb.js"><link rel="prefetch" href="/assets/VerifyingABI.html.b7292c5a.js"><link rel="prefetch" href="/assets/Module.html.5eba0c72.js"><link rel="prefetch" href="/assets/Plugin.html.e2dbccdb.js"><link rel="prefetch" href="/assets/index.html.f3ebb67b.js"><link rel="prefetch" href="/assets/index.html.43419090.js"><link rel="prefetch" href="/assets/index.html.5ffd3e54.js"><link rel="prefetch" href="/assets/Contacts.mermaid.html.2bfb0957.js"><link rel="prefetch" href="/assets/Messages.mermaid.html.a0fbd8fc.js"><link rel="prefetch" href="/assets/JVMPlugin-Appendix.html.86c686b5.js"><link rel="prefetch" href="/assets/JVMPlugin-DataExchange.html.b159a07b.js"><link rel="prefetch" href="/assets/JVMPlugin-Debug.html.1056ba84.js"><link rel="prefetch" href="/assets/JVMPlugin.html.6f830ff9.js"><link rel="prefetch" href="/assets/Plugins.html.89d4326a.js"><link rel="prefetch" href="/assets/Adapter.html.d6cdf325.js"><link rel="prefetch" href="/assets/CustomizedAdapter.html.00b9fbdd.js"><link rel="prefetch" href="/assets/HttpAdapter.html.92211dba.js"><link rel="prefetch" href="/assets/ReverseWebsocketAdapter.html.bfd09d42.js"><link rel="prefetch" href="/assets/WebhookAdapter.html.e5646024.js"><link rel="prefetch" href="/assets/WebsocketAdapter.html.6e6e88db.js"><link rel="prefetch" href="/assets/API.html.3b311233.js"><link rel="prefetch" href="/assets/EventType.html.c1ea48e6.js"><link rel="prefetch" href="/assets/MessageType.html.ede8f7df.js"><link rel="prefetch" href="/assets/Migration2.html.3a881eb8.js"><link rel="prefetch" href="/assets/404.html.958044b7.js"><link rel="prefetch" href="/assets/404.896c6139.js"><link rel="prefetch" href="/assets/Layout.1c52f6e5.js">
    <link rel="stylesheet" href="/assets/style.24c55b2e.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><img class="logo" src="/mirai.png" alt="mirai"><span class="site-name can-hide">mirai</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="mirai-core"><span class="title">mirai-core</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="mirai-core"><span class="title">mirai-core</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/" class="" aria-label="Index"><!--[--><!--]--> Index <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mirai-ecology.html" class="" aria-label="Mirai 生态概览"><!--[--><!--]--> Mirai 生态概览 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MigrationFrom1x.html" class="" aria-label="从 1.x 迁移"><!--[--><!--]--> 从 1.x 迁移 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/UserManual.html" class="" aria-label="用户手册"><!--[--><!--]--> 用户手册 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ConsoleTerminal.html" class="" aria-label="用户手册 - 控制台"><!--[--><!--]--> 用户手册 - 控制台 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Preparations.html" class="" aria-label="JVM 环境和开发准备工作"><!--[--><!--]--> JVM 环境和开发准备工作 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ConfiguringProjects.html" class="" aria-label="配置项目"><!--[--><!--]--> 配置项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>CoreAPI</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/CoreAPI.html" class="" aria-label="CoreAPI"><!--[--><!--]--> CoreAPI <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/Bots.html" class="" aria-label="机器人"><!--[--><!--]--> 机器人 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/Contacts.html" class="" aria-label="联系人"><!--[--><!--]--> 联系人 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a aria-current="page" href="/Events.html" class="router-link-active router-link-exact-active router-link-active" aria-label="事件"><!--[--><!--]--> 事件 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/Messages.html" class="" aria-label="消息"><!--[--><!--]--> 消息 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Misc</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/ConciseAPI.html" class="" aria-label="主要API"><!--[--><!--]--> 主要API <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/Evolution.html" class="" aria-label="Mirai - Evolution"><!--[--><!--]--> Mirai - Evolution <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/KotlinAndJava.html" class="" aria-label="Kotlin &amp; Java"><!--[--><!--]--> Kotlin &amp; Java <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/EventList.html" class="" aria-label="事件列表"><!--[--><!--]--> 事件列表 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/DebuggingNetwork.html" class="" aria-label="Debugging Network"><!--[--><!--]--> Debugging Network <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/UsingSnapshots.html" class="" aria-label="Using Dev Snapshots"><!--[--><!--]--> Using Dev Snapshots <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="mirai-console"><span class="title">mirai-console</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="mirai-console"><span class="title">mirai-console</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/console/" class="" aria-label="Index"><!--[--><!--]--> Index <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/console/ConfiguringProjects.html" class="" aria-label="配置项目"><!--[--><!--]--> 配置项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/console/Run.html" class="" aria-label="启动 Console"><!--[--><!--]--> 启动 Console <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>后端插件开发基础</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/console/plugin/Plugins.html" class="" aria-label="插件 - Plugin 模块"><!--[--><!--]--> 插件 - Plugin 模块 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/plugin/JVMPlugin.html" class="" aria-label="插件 - JVM Plugin"><!--[--><!--]--> 插件 - JVM Plugin <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/Commands.html" class="" aria-label="指令 - Command 模块"><!--[--><!--]--> 指令 - Command 模块 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/PluginData.html" class="" aria-label="存储 - PluginData 模块"><!--[--><!--]--> 存储 - PluginData 模块 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/Permissions.html" class="" aria-label="权限 - Permission 模块"><!--[--><!--]--> 权限 - Permission 模块 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>后端插件开发进阶</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/console/Extensions.html" class="" aria-label="扩展 - Extension 模块和扩展点"><!--[--><!--]--> 扩展 - Extension 模块和扩展点 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>实现前端</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/console/FrontEnd.html" class="" aria-label="FrontEnd"><!--[--><!--]--> FrontEnd <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Misc</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/console/QA.html" class="" aria-label="Q &amp; A"><!--[--><!--]--> Q &amp; A <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/Logging.html" class="" aria-label="日志配置"><!--[--><!--]--> 日志配置 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/BuiltInCommands.html" class="" aria-label="内置命令"><!--[--><!--]--> 内置命令 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/Appendix.html" class="" aria-label="Mirai Console 附录"><!--[--><!--]--> Mirai Console 附录 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/plugin/JVMPlugin-Appendix.html" class="" aria-label="插件 - JVM Plugin - 附录"><!--[--><!--]--> 插件 - JVM Plugin - 附录 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/plugin/JVMPlugin-DataExchange.html" class="" aria-label="插件 - JVM Plugin - 多插件数据交换"><!--[--><!--]--> 插件 - JVM Plugin - 多插件数据交换 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/plugin/JVMPlugin-Debug.html" class="" aria-label="插件 - JVM Plugin - 排错"><!--[--><!--]--> 插件 - JVM Plugin - 排错 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><a href="/mirai-login-solver-selenium/" class="" aria-label="mirai-login-solver-selenium"><!--[--><!--]--> mirai-login-solver-selenium <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="mirai-api-http"><span class="title">mirai-api-http</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="mirai-api-http"><span class="title">mirai-api-http</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/mirai-api-http/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mirai-api-http/api/API.html" class="" aria-label="API"><!--[--><!--]--> API <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mirai-api-http/api/EventType.html" class="" aria-label="事件类型"><!--[--><!--]--> 事件类型 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mirai-api-http/api/MessageType.html" class="" aria-label="消息类型"><!--[--><!--]--> 消息类型 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>接口适配器</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/mirai-api-http/adapter/HttpAdapter.html" class="" aria-label="http轮询"><!--[--><!--]--> http轮询 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/mirai-api-http/adapter/WebsocketAdapter.html" class="" aria-label="websocket"><!--[--><!--]--> websocket <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/mirai-api-http/adapter/ReverseWebsocketAdapter.html" class="" aria-label="反向websocket"><!--[--><!--]--> 反向websocket <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/mirai-api-http/adapter/WebhookAdapter.html" class="" aria-label="webhook上报"><!--[--><!--]--> webhook上报 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="mirai-console-loader"><span class="title">mirai-console-loader</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="mirai-console-loader"><span class="title">mirai-console-loader</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/mcl/" class="" aria-label="主页"><!--[--><!--]--> 主页 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mcl/Module.html" class="" aria-label="MCL模块"><!--[--><!--]--> MCL模块 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mcl/Plugin.html" class="" aria-label="MCL插件"><!--[--><!--]--> MCL插件 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/mamoe/mirai" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="mirai-core"><span class="title">mirai-core</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="mirai-core"><span class="title">mirai-core</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/" class="" aria-label="Index"><!--[--><!--]--> Index <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mirai-ecology.html" class="" aria-label="Mirai 生态概览"><!--[--><!--]--> Mirai 生态概览 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MigrationFrom1x.html" class="" aria-label="从 1.x 迁移"><!--[--><!--]--> 从 1.x 迁移 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/UserManual.html" class="" aria-label="用户手册"><!--[--><!--]--> 用户手册 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ConsoleTerminal.html" class="" aria-label="用户手册 - 控制台"><!--[--><!--]--> 用户手册 - 控制台 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Preparations.html" class="" aria-label="JVM 环境和开发准备工作"><!--[--><!--]--> JVM 环境和开发准备工作 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ConfiguringProjects.html" class="" aria-label="配置项目"><!--[--><!--]--> 配置项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>CoreAPI</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/CoreAPI.html" class="" aria-label="CoreAPI"><!--[--><!--]--> CoreAPI <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/Bots.html" class="" aria-label="机器人"><!--[--><!--]--> 机器人 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/Contacts.html" class="" aria-label="联系人"><!--[--><!--]--> 联系人 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a aria-current="page" href="/Events.html" class="router-link-active router-link-exact-active router-link-active" aria-label="事件"><!--[--><!--]--> 事件 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/Messages.html" class="" aria-label="消息"><!--[--><!--]--> 消息 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Misc</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/ConciseAPI.html" class="" aria-label="主要API"><!--[--><!--]--> 主要API <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/Evolution.html" class="" aria-label="Mirai - Evolution"><!--[--><!--]--> Mirai - Evolution <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/KotlinAndJava.html" class="" aria-label="Kotlin &amp; Java"><!--[--><!--]--> Kotlin &amp; Java <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/EventList.html" class="" aria-label="事件列表"><!--[--><!--]--> 事件列表 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/DebuggingNetwork.html" class="" aria-label="Debugging Network"><!--[--><!--]--> Debugging Network <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/UsingSnapshots.html" class="" aria-label="Using Dev Snapshots"><!--[--><!--]--> Using Dev Snapshots <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="mirai-console"><span class="title">mirai-console</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="mirai-console"><span class="title">mirai-console</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/console/" class="" aria-label="Index"><!--[--><!--]--> Index <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/console/ConfiguringProjects.html" class="" aria-label="配置项目"><!--[--><!--]--> 配置项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/console/Run.html" class="" aria-label="启动 Console"><!--[--><!--]--> 启动 Console <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>后端插件开发基础</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/console/plugin/Plugins.html" class="" aria-label="插件 - Plugin 模块"><!--[--><!--]--> 插件 - Plugin 模块 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/plugin/JVMPlugin.html" class="" aria-label="插件 - JVM Plugin"><!--[--><!--]--> 插件 - JVM Plugin <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/Commands.html" class="" aria-label="指令 - Command 模块"><!--[--><!--]--> 指令 - Command 模块 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/PluginData.html" class="" aria-label="存储 - PluginData 模块"><!--[--><!--]--> 存储 - PluginData 模块 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/Permissions.html" class="" aria-label="权限 - Permission 模块"><!--[--><!--]--> 权限 - Permission 模块 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>后端插件开发进阶</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/console/Extensions.html" class="" aria-label="扩展 - Extension 模块和扩展点"><!--[--><!--]--> 扩展 - Extension 模块和扩展点 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>实现前端</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/console/FrontEnd.html" class="" aria-label="FrontEnd"><!--[--><!--]--> FrontEnd <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Misc</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/console/QA.html" class="" aria-label="Q &amp; A"><!--[--><!--]--> Q &amp; A <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/Logging.html" class="" aria-label="日志配置"><!--[--><!--]--> 日志配置 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/BuiltInCommands.html" class="" aria-label="内置命令"><!--[--><!--]--> 内置命令 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/Appendix.html" class="" aria-label="Mirai Console 附录"><!--[--><!--]--> Mirai Console 附录 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/plugin/JVMPlugin-Appendix.html" class="" aria-label="插件 - JVM Plugin - 附录"><!--[--><!--]--> 插件 - JVM Plugin - 附录 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/plugin/JVMPlugin-DataExchange.html" class="" aria-label="插件 - JVM Plugin - 多插件数据交换"><!--[--><!--]--> 插件 - JVM Plugin - 多插件数据交换 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/plugin/JVMPlugin-Debug.html" class="" aria-label="插件 - JVM Plugin - 排错"><!--[--><!--]--> 插件 - JVM Plugin - 排错 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><a href="/mirai-login-solver-selenium/" class="" aria-label="mirai-login-solver-selenium"><!--[--><!--]--> mirai-login-solver-selenium <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="mirai-api-http"><span class="title">mirai-api-http</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="mirai-api-http"><span class="title">mirai-api-http</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/mirai-api-http/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mirai-api-http/api/API.html" class="" aria-label="API"><!--[--><!--]--> API <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mirai-api-http/api/EventType.html" class="" aria-label="事件类型"><!--[--><!--]--> 事件类型 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mirai-api-http/api/MessageType.html" class="" aria-label="消息类型"><!--[--><!--]--> 消息类型 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>接口适配器</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/mirai-api-http/adapter/HttpAdapter.html" class="" aria-label="http轮询"><!--[--><!--]--> http轮询 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/mirai-api-http/adapter/WebsocketAdapter.html" class="" aria-label="websocket"><!--[--><!--]--> websocket <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/mirai-api-http/adapter/ReverseWebsocketAdapter.html" class="" aria-label="反向websocket"><!--[--><!--]--> 反向websocket <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/mirai-api-http/adapter/WebhookAdapter.html" class="" aria-label="webhook上报"><!--[--><!--]--> webhook上报 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="mirai-console-loader"><span class="title">mirai-console-loader</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="mirai-console-loader"><span class="title">mirai-console-loader</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/mcl/" class="" aria-label="主页"><!--[--><!--]--> 主页 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mcl/Module.html" class="" aria-label="MCL模块"><!--[--><!--]--> MCL模块 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mcl/Plugin.html" class="" aria-label="MCL插件"><!--[--><!--]--> MCL插件 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/mamoe/mirai" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">Mirai - Events <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/Events.html#目录" class="router-link-active router-link-exact-active sidebar-item" aria-label="目录"><!--[--><!--]--> 目录 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Events.html#事件系统" class="router-link-active router-link-exact-active sidebar-item" aria-label="事件系统"><!--[--><!--]--> 事件系统 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Events.html#快速指导" class="router-link-active router-link-exact-active sidebar-item" aria-label="快速指导"><!--[--><!--]--> 快速指导 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/Events.html#kotlin" class="router-link-active router-link-exact-active sidebar-item" aria-label="Kotlin"><!--[--><!--]--> Kotlin <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Events.html#java" class="router-link-active router-link-exact-active sidebar-item" aria-label="Java"><!--[--><!--]--> Java <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/Events.html#事件通道" class="router-link-active router-link-exact-active sidebar-item" aria-label="事件通道"><!--[--><!--]--> 事件通道 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/Events.html#获取事件通道" class="router-link-active router-link-exact-active sidebar-item" aria-label="获取事件通道"><!--[--><!--]--> 获取事件通道 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/Events.html#通道操作" class="router-link-active router-link-exact-active sidebar-item" aria-label="通道操作"><!--[--><!--]--> 通道操作 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/Events.html#过滤" class="router-link-active router-link-exact-active sidebar-item" aria-label="过滤"><!--[--><!--]--> 过滤 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Events.html#添加-coroutinecontext" class="router-link-active router-link-exact-active sidebar-item" aria-label="添加 CoroutineContext"><!--[--><!--]--> 添加 CoroutineContext <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Events.html#限制作用域" class="router-link-active router-link-exact-active sidebar-item" aria-label="限制作用域"><!--[--><!--]--> 限制作用域 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Events.html#链式调用" class="router-link-active router-link-exact-active sidebar-item" aria-label="链式调用"><!--[--><!--]--> 链式调用 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/Events.html#在-eventchannel-监听事件" class="router-link-active router-link-exact-active sidebar-item" aria-label="在 EventChannel 监听事件"><!--[--><!--]--> 在 EventChannel 监听事件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Events.html#监听事件的其他方法" class="router-link-active router-link-exact-active sidebar-item" aria-label="监听事件的其他方法"><!--[--><!--]--> 监听事件的其他方法 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/Events.html#使用-eventhandler-注解标注的方法监听事件" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用 @EventHandler 注解标注的方法监听事件"><!--[--><!--]--> 使用 @EventHandler 注解标注的方法监听事件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Events.html#在-kotlin-使用-dsl-监听事件" class="router-link-active router-link-exact-active sidebar-item" aria-label="在 Kotlin 使用 DSL 监听事件"><!--[--><!--]--> 在 Kotlin 使用 DSL 监听事件 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/Events.html#实现事件" class="router-link-active router-link-exact-active sidebar-item" aria-label="实现事件"><!--[--><!--]--> 实现事件 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/Events.html#新建事件" class="router-link-active router-link-exact-active sidebar-item" aria-label="新建事件"><!--[--><!--]--> 新建事件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Events.html#广播自定义事件" class="router-link-active router-link-exact-active sidebar-item" aria-label="广播自定义事件"><!--[--><!--]--> 广播自定义事件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Events.html#监听自定义事件" class="router-link-active router-link-exact-active sidebar-item" aria-label="监听自定义事件"><!--[--><!--]--> 监听自定义事件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Events.html#在-console-中自定义事件" class="router-link-active router-link-exact-active sidebar-item" aria-label="在 Console 中自定义事件"><!--[--><!--]--> 在 Console 中自定义事件 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/Events.html#工具函数-kotlin" class="router-link-active router-link-exact-active sidebar-item" aria-label="工具函数（Kotlin）"><!--[--><!--]--> 工具函数（Kotlin） <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/Events.html#线性同步-syncfromevent" class="router-link-active router-link-exact-active sidebar-item" aria-label="线性同步（syncFromEvent）"><!--[--><!--]--> 线性同步（syncFromEvent） <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Events.html#线性同步-nextevent" class="router-link-active router-link-exact-active sidebar-item" aria-label="线性同步（nextEvent）"><!--[--><!--]--> 线性同步（nextEvent） <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Events.html#条件选择-selectmessages" class="router-link-active router-link-exact-active sidebar-item" aria-label="条件选择（selectMessages）"><!--[--><!--]--> 条件选择（selectMessages） <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/Events.html#循环条件选择-whileselectmessages" class="router-link-active router-link-exact-active sidebar-item" aria-label="循环条件选择（whileSelectMessages）"><!--[--><!--]--> 循环条件选择（whileSelectMessages） <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="mirai-events" tabindex="-1"><a class="header-anchor" href="#mirai-events" aria-hidden="true">#</a> Mirai - Events</h1><h2 id="目录" tabindex="-1"><a class="header-anchor" href="#目录" aria-hidden="true">#</a> 目录</h2><ul><li><a href="#%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F">事件系统</a></li><li><a href="#%E5%BF%AB%E9%80%9F%E6%8C%87%E5%AF%BC">快速指导</a></li><li><a href="#%E4%BA%8B%E4%BB%B6%E9%80%9A%E9%81%93">事件通道</a></li><li><a href="#%E9%80%9A%E9%81%93%E6%93%8D%E4%BD%9C">通道操作</a><ul><li><a href="#%E8%BF%87%E6%BB%A4">过滤</a></li><li><a href="#%E6%B7%BB%E5%8A%A0-coroutinecontext">添加 <code>CoroutineContext</code></a></li><li><a href="#%E9%99%90%E5%88%B6%E4%BD%9C%E7%94%A8%E5%9F%9F">限制作用域</a></li><li><a href="#%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8">链式调用</a></li></ul></li><li><a href="#%E5%9C%A8-eventchannel-%E7%9B%91%E5%90%AC%E4%BA%8B%E4%BB%B6">在 <code>EventChannel</code> 监听事件</a></li><li><a href="#%E7%9B%91%E5%90%AC%E4%BA%8B%E4%BB%B6%E7%9A%84%E5%85%B6%E4%BB%96%E6%96%B9%E6%B3%95">监听事件的其他方法</a><ul><li><a href="#%E4%BD%BF%E7%94%A8-eventhandler-%E6%B3%A8%E8%A7%A3%E6%A0%87%E6%B3%A8%E7%9A%84%E6%96%B9%E6%B3%95%E7%9B%91%E5%90%AC%E4%BA%8B%E4%BB%B6">使用 <code>ListenerHost</code> 监听事件</a></li><li><a href="#%E5%9C%A8-kotlin-%E4%BD%BF%E7%94%A8-dsl-%E7%9B%91%E5%90%AC%E4%BA%8B%E4%BB%B6">在 Kotlin 使用 DSL 监听事件</a></li></ul></li><li><a href="#%E5%AE%9E%E7%8E%B0%E4%BA%8B%E4%BB%B6">实现事件</a><ul><li><a href="#%E6%96%B0%E5%BB%BA%E4%BA%8B%E4%BB%B6">新建事件</a></li><li><a href="#%E5%B9%BF%E6%92%AD%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BA%8B%E4%BB%B6">广播自定义事件</a></li><li><a href="#%E7%9B%91%E5%90%AC%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BA%8B%E4%BB%B6">监听自定义事件</a></li><li><a href="/console/plugin/JVMPlugin-DataExchange.html" class="">在 Console 中自定义事件</a></li></ul></li><li><a href="#%E5%B7%A5%E5%85%B7%E5%87%BD%E6%95%B0kotlin">工具函数（Kotlin）</a><ul><li><a href="#%E7%BA%BF%E6%80%A7%E5%90%8C%E6%AD%A5syncfromevent">线性同步（<code>syncFromEvent</code>）</a></li><li><a href="#%E7%BA%BF%E6%80%A7%E5%90%8C%E6%AD%A5nextevent">线性同步（<code>nextEvent</code>）</a></li><li><a href="#%E6%9D%A1%E4%BB%B6%E9%80%89%E6%8B%A9selectmessages">条件选择（<code>selectMessages</code>）</a></li><li><a href="#%E5%BE%AA%E7%8E%AF%E6%9D%A1%E4%BB%B6%E9%80%89%E6%8B%A9whileselectmessages">循环条件选择（<code>whileSelectMessages</code>）</a></li></ul></li></ul><h2 id="事件系统" tabindex="-1"><a class="header-anchor" href="#事件系统" aria-hidden="true">#</a> 事件系统</h2><p>Mirai 许多功能都依赖事件。</p><p>每个事件都实现接口 <a href="https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/event/Event.kt#L21-L62" target="_blank" rel="noopener noreferrer"><code>Event</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，且继承 <code>AbstractEvent</code>。<br> 实现 <code>CancellableEvent</code> 的事件可以被取消（<code>CancellableEvent.cancel</code>）。</p><p><strong><a href="/EventList.html" class="">事件列表</a></strong></p><blockquote><p>回到 <a href="#%E7%9B%AE%E5%BD%95">目录</a></p></blockquote><h2 id="快速指导" tabindex="-1"><a class="header-anchor" href="#快速指导" aria-hidden="true">#</a> 快速指导</h2><p>如果你了解事件且不希望详细阅读，可以立即仿照下面示例创建事件监听并跳过本章节。</p><p>注意，<strong><code>GlobalEventChannel</code> 会监听到来自所有 <code>Bot</code> 的事件，如果只希望监听某一个 <code>Bot</code> 的事件，请使用 <code>bot.eventChannel</code>。</strong></p><p>有关消息 <code>Message</code>、<code>MessageChain</code> 将会在后文 <em>消息系统</em> 章节解释。</p><h3 id="kotlin" tabindex="-1"><a class="header-anchor" href="#kotlin" aria-hidden="true">#</a> Kotlin</h3><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token comment">// 事件监听器是协程任务。如果你有 CoroutineScope，可从 scope 继承生命周期管理和 coroutineContext</span>
GlobalEventChannel<span class="token punctuation">.</span><span class="token function">parentScope</span><span class="token punctuation">(</span>coroutineScope<span class="token punctuation">)</span><span class="token punctuation">.</span>subscribeAlways<span class="token operator">&lt;</span>GroupMessageEvent<span class="token operator">&gt;</span> <span class="token punctuation">{</span> event <span class="token operator">-&gt;</span>
    <span class="token comment">// this: GroupMessageEvent</span>
    <span class="token comment">// event: GroupMessageEvent</span>
    
    <span class="token comment">// `event.message` 是接收到的消息内容, 可自行处理. 由于 `this` 也是 `GroupMessageEvent`, 可以通过 `message` 直接获取. 详细查阅 `GroupMessageEvent`.</span>
    
    subject<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Hello!&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// `GlobalEventChannel.parentScope(coroutineScope)` 也可以替换为使用扩展 `coroutineScope.globalEventChannel()`, 根据个人习惯选择</span>



<span class="token comment">// 如果不想限制生命周期，可获取 listener 处理</span>
<span class="token keyword">val</span> listener<span class="token operator">:</span> CompletableJob <span class="token operator">=</span>
    GlobalEventChannel<span class="token punctuation">.</span>subscribeAlways<span class="token operator">&lt;</span>GroupMessageEvent<span class="token operator">&gt;</span> <span class="token punctuation">{</span> event <span class="token operator">-&gt;</span> <span class="token punctuation">}</span>

listener<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 停止监听</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>异常默认会被相关 <code>Bot</code> 日志记录。可以在 <code>subscribeAlways</code> 之前添加如下内容来处理异常。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>.exceptionHandler { e -&gt; e.printStackTrace() }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>注意</strong>：如果要在 Mirai Console 插件中监听事件，请不要使用使用无作用域控制的 <code>GlobalEventChannel</code> ，如 <code>GlobalEventChannel.subscribeAlways</code> 。请使用插件主类的扩展函数 <code>globalEventChannel()</code> 或者 <code>GlobalEventChannel.parentScope(scope)</code> 等方式控制监听器协程作用域。</p><h3 id="java" tabindex="-1"><a class="header-anchor" href="#java" aria-hidden="true">#</a> Java</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 创建监听</span>
<span class="token class-name">Listener</span> listener<span class="token operator">=</span><span class="token class-name">GlobalEventChannel</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">parentScope</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribeAlways</span><span class="token punctuation">(</span><span class="token class-name">GroupMessageEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>event<span class="token operator">-&gt;</span><span class="token punctuation">{</span>
        <span class="token class-name">MessageChain</span> chain<span class="token operator">=</span>event<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可获取到消息内容等, 详细查阅 `GroupMessageEvent`</span>

        event<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Hello!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 回复消息</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        listener<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 停止监听 </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>异常默认会被相关 <code>Bot</code> 日志记录。可以在 <code>subscribeAlways</code> 之前添加如下内容来处理异常。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">.</span><span class="token function">exceptionHandler</span><span class="token punctuation">(</span>e<span class="token operator">-&gt;</span>e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>注意</strong>：如果要在 Mirai Console 插件中监听事件，请不要使用使用无作用域控制的 <code>GlobalEventChannel</code> ，如 <code>GlobalEventChannel.subscribeAlways</code> 。请使用 <code>GlobalEventChannel.parentScope(PluginMain.INSTANCE)</code> 等方式控制监听器协程作用域。</p><blockquote><p>你已经了解了基本事件操作。现在你可以继续阅读通道处理和扩展等内容，或：</p><ul><li>跳到下一章 <a href="/Messages.html" class="">Messages</a></li><li><a href="/EventList.html" class="">查看事件列表</a></li><li><a href="#%E7%9B%AE%E5%BD%95">回到事件文档目录</a></li><li><a href="/CoreAPI.html" class="">回到 Mirai 文档索引</a></li></ul></blockquote><h2 id="事件通道" tabindex="-1"><a class="header-anchor" href="#事件通道" aria-hidden="true">#</a> 事件通道</h2><p><a href="https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/event/EventChannel.kt" target="_blank" rel="noopener noreferrer">事件通道<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>是监听事件的入口。 <strong>在不同的事件通道中可以监听到不同类型的事件</strong>。</p><h3 id="获取事件通道" tabindex="-1"><a class="header-anchor" href="#获取事件通道" aria-hidden="true">#</a> 获取事件通道</h3><p><a href="https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/event/GlobalEventChannel.kt" target="_blank" rel="noopener noreferrer"><code>GlobalEventChannel</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 是最大的通道：所有的事件都可以在 <a href="https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/event/GlobalEventChannel.kt" target="_blank" rel="noopener noreferrer"><code>GlobalEventChannel</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 监听到。<strong>因此，<a href="https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/event/GlobalEventChannel.kt" target="_blank" rel="noopener noreferrer"><code>GlobalEventChannel</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 会包含来自所有 <code>Bot</code> 实例的事件。</strong></p><p>通常不会直接使用 <a href="https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/event/GlobalEventChannel.kt" target="_blank" rel="noopener noreferrer"><code>GlobalEventChannel</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，而是使用经过 <a href="#%E9%80%9A%E9%81%93%E6%93%8D%E4%BD%9C">通道操作</a> 操作的子通道。</p><blockquote><p>回到 <a href="#%E7%9B%AE%E5%BD%95">目录</a></p></blockquote><h2 id="通道操作" tabindex="-1"><a class="header-anchor" href="#通道操作" aria-hidden="true">#</a> 通道操作</h2><p><code>EventChannel</code> 可以通过一些操作转换。</p><p><strong>一个通道的属性都是<em>不变的</em>：每个转换操作都会创建一个新的通道而不会修改原通道。</strong></p><h3 id="过滤" tabindex="-1"><a class="header-anchor" href="#过滤" aria-hidden="true">#</a> 过滤</h3><p><code>GlobalEventChannel</code> 包含任何 <code>Event</code>，可以通过 <code>EventChannel.filter</code> 过滤得到一个只包含期望的事件的 <code>EventChannel</code>。</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">var</span> channel <span class="token operator">=</span> GlobalEventChannel<span class="token punctuation">.</span><span class="token function">filter</span> <span class="token punctuation">{</span> it <span class="token keyword">is</span> BotEvent <span class="token operator">&amp;&amp;</span> it<span class="token punctuation">.</span>bot<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token number">123456L</span> <span class="token punctuation">}</span> <span class="token comment">// 筛选来自某一个 Bot 的事件</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">EventChannel</span> channel <span class="token operator">=</span> <span class="token class-name">GlobalEventChannel</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>ev <span class="token operator">-&gt;</span> ev <span class="token keyword">instanceof</span> <span class="token class-name">BotEvent</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BotEvent</span><span class="token punctuation">)</span> ev<span class="token punctuation">)</span><span class="token punctuation">.</span>bot<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token number">123456</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 筛选来自某一个 Bot 的事件</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>回到 <a href="#%E9%80%9A%E9%81%93%E6%93%8D%E4%BD%9C">通道操作</a></p></blockquote><blockquote><p>你可以选择跳过下文介绍的协程属性和作用域，直接阅读 <a href="#%E5%9C%A8-eventchannel-%E7%9B%91%E5%90%AC%E4%BA%8B%E4%BB%B6">在 <code>EventChannel</code> 监听事件</a></p></blockquote><h3 id="添加-coroutinecontext" tabindex="-1"><a class="header-anchor" href="#添加-coroutinecontext" aria-hidden="true">#</a> 添加 <code>CoroutineContext</code></h3><p>一个通道持有属性 <code>defaultCoroutineContext</code>，将会自动添加给每个事件监听器（见后文）。</p><p>可以为通道添加一些 <code>CoroutineContext</code>，如 <code>CoroutineExceptionHandler</code>（用于处理监听时产生的异常）。</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code>channel<span class="token punctuation">.</span><span class="token function">exceptionHandler</span> <span class="token punctuation">{</span> exception <span class="token operator">-&gt;</span>
    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>channel<span class="token punctuation">.</span><span class="token function">exceptionHandler</span><span class="token punctuation">(</span>exception <span class="token operator">-&gt;</span>
    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这本质上是添加了一个 <code>CoroutineExceptionHandler</code>。之后当事件监听器出现异常，异常就会被传递到这个 <code>CoroutineExceptionHandler</code> 处理。</p><blockquote><p>回到 <a href="#%E9%80%9A%E9%81%93%E6%93%8D%E4%BD%9C">通道操作</a></p></blockquote><h3 id="限制作用域" tabindex="-1"><a class="header-anchor" href="#限制作用域" aria-hidden="true">#</a> 限制作用域</h3><p>在监听时会创建一些<em>事件监听器</em>。<em>事件监听器</em>本质上是一个协程 <em><code>Job</code></em>，因此可以有父 <code>Job</code>。</p><p>要指定父 <code>Job</code>，请使用 <code>parentJob</code> 或 <code>parentScope</code> 操作。</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token comment">// parentScope</span>
channel <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">parentScope</span><span class="token punctuation">(</span>MyApplicationScope<span class="token punctuation">)</span>

<span class="token comment">// parentJob</span>
<span class="token keyword">val</span> job <span class="token operator">=</span> <span class="token function">SupervisorJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
channel <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">parentJob</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 Kotlin，可以使用如下扩展快速在 GlobalEventChannel 创建一个指定协程作用域下的事件通道。</p><blockquote><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code> <span class="token keyword">fun</span> CoroutineScope<span class="token punctuation">.</span><span class="token function">globalEventChannel</span><span class="token punctuation">(</span>coroutineContext<span class="token operator">:</span> CoroutineContext <span class="token operator">=</span> EmptyCoroutineContext<span class="token punctuation">)</span><span class="token operator">:</span> EventChannel<span class="token operator">&lt;</span>Event<span class="token operator">&gt;</span> <span class="token operator">=</span> GlobalEventChannel<span class="token punctuation">.</span><span class="token function">parentScope</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> coroutineContext<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></blockquote><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> channel <span class="token operator">=</span> MyApplicationScope<span class="token punctuation">.</span><span class="token function">globalEventChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>作用域限制对于应用生命周期管理会很有用。请看如下 Mirai Console 插件示例。</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">object</span> MyPluginMain <span class="token operator">:</span> <span class="token function">KotlinPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// KotlinPlugin 实现了 CoroutineScope</span>

    <span class="token comment">// 插件被启用时调用</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        <span class="token comment">// `this` 是插件的协程作用域</span>
        <span class="token comment">// 在插件协程作用域里创建事件监听。当插件被停用时，插件的协程作用域也会被关闭，事件监听就会被同步停止。</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">globalEventChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>subscribeAlways<span class="token operator">&lt;</span>MessageEvent<span class="token operator">&gt;</span> <span class="token punctuation">{</span> event <span class="token operator">-&gt;</span>
            <span class="token comment">// 处理事件 </span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>有关限制作用域的实现细节，可在使用时阅读源码内文档。</p></blockquote><h3 id="链式调用" tabindex="-1"><a class="header-anchor" href="#链式调用" aria-hidden="true">#</a> 链式调用</h3><p>对通道的操作都会返回 <code>this</code>，因此可以链式调用。</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> channel <span class="token operator">=</span> GlobalEventChannel
    <span class="token punctuation">.</span>filterIsInstance<span class="token operator">&lt;</span>BotEvent<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span> <span class="token punctuation">{</span> it<span class="token punctuation">.</span>bot<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token number">123456L</span> <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">filter</span> <span class="token punctuation">{</span> <span class="token comment">/* some other conditions */</span> <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">parentScope</span><span class="token punctuation">(</span>MyApplicationScope<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">exceptionHandler</span> <span class="token punctuation">{</span> exception <span class="token operator">-&gt;</span>
        exception<span class="token punctuation">.</span><span class="token function">printStacktrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>回到 <a href="#%E9%80%9A%E9%81%93%E6%93%8D%E4%BD%9C">通道操作</a> 回到 <a href="#%E7%9B%AE%E5%BD%95">目录</a></p></blockquote><h2 id="在-eventchannel-监听事件" tabindex="-1"><a class="header-anchor" href="#在-eventchannel-监听事件" aria-hidden="true">#</a> 在 <code>EventChannel</code> 监听事件</h2><p>使用：</p><ul><li><code>EventChannel.subscribe</code>：监听事件并自行决定何时停止</li><li><code>EventChannel.subscribeAlways</code>：一直监听事件</li><li><code>EventChannel.subscribeOnce</code>：只监听一次事件</li></ul><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code>bot<span class="token punctuation">.</span>eventChannel<span class="token punctuation">.</span>subscribeAlways<span class="token operator">&lt;</span>GroupMessageEvent<span class="token operator">&gt;</span> <span class="token punctuation">{</span> event <span class="token operator">-&gt;</span>
    <span class="token comment">// this: GroupMessageEvent</span>
    <span class="token comment">// event: GroupMessageEvent</span>
    
    subject<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Hello from mirai!&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>bot<span class="token punctuation">.</span>eventChannel<span class="token punctuation">.</span><span class="token function">subscribeAlways</span><span class="token punctuation">(</span><span class="token class-name">GroupMessageEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> event <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Hello from mirai!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>实现细节可查看源码内注释。</p></blockquote><blockquote><p>回到 <a href="#%E7%9B%AE%E5%BD%95">目录</a></p></blockquote><h2 id="监听事件的其他方法" tabindex="-1"><a class="header-anchor" href="#监听事件的其他方法" aria-hidden="true">#</a> 监听事件的其他方法</h2><p>监听都需要在<em>事件通道</em>中进行。如下几种方法都本质上会调用上述 <code>EventChannel.subscribe</code> 等方法。</p><ul><li><a href="#%E4%BD%BF%E7%94%A8-eventhandler-%E6%B3%A8%E8%A7%A3%E6%A0%87%E6%B3%A8%E7%9A%84%E6%96%B9%E6%B3%95%E7%9B%91%E5%90%AC%E4%BA%8B%E4%BB%B6">使用 <code>@EventHandler</code> 注解标注的方法监听事件</a></li><li><a href="#%E5%9C%A8-kotlin-%E4%BD%BF%E7%94%A8-dsl-%E7%9B%91%E5%90%AC%E4%BA%8B%E4%BB%B6">在 Kotlin 使用 DSL 监听事件</a></li></ul><h3 id="使用-eventhandler-注解标注的方法监听事件" tabindex="-1"><a class="header-anchor" href="#使用-eventhandler-注解标注的方法监听事件" aria-hidden="true">#</a> 使用 <code>@EventHandler</code> 注解标注的方法监听事件</h3><p>标注一个函数（方法）为事件监听器。mirai 通过反射获取他们并为之注册事件。</p><ul><li><a href="#kotlin-%E5%87%BD%E6%95%B0">Kotlin 函数</a></li><li><a href="#java-%E6%96%B9%E6%B3%95">Java 方法</a></li></ul><h4 id="kotlin-函数" tabindex="-1"><a class="header-anchor" href="#kotlin-函数" aria-hidden="true">#</a> Kotlin 函数</h4><p>Kotlin 函数要求:</p><ul><li>接收者和函数参数: 所标注的 Kotlin 函数必须至少拥有一个接收者或一个函数参数, 或二者都具有. 接收者和函数参数的类型必须相同 (如果二者都存在) 接收者或函数参数的类型都必须为 <code>Event</code> 或其子类.</li></ul><p>所有 Kotlin 非 <code>suspend</code> 的函数都将会在 <code>Dispatchers.IO</code> 中调用</p><p>支持的函数类型:</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token comment">// 所有函数参数, 函数返回值都不允许标记为可空 (带有 &#39;?&#39; 符号)</span>
<span class="token comment">// T 表示任何 Event 类型.</span>
<span class="token keyword">suspend</span> <span class="token keyword">fun</span> T<span class="token punctuation">.</span><span class="token function">onEvent</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span>
<span class="token keyword">suspend</span> <span class="token keyword">fun</span> T<span class="token punctuation">.</span><span class="token function">onEvent</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token operator">:</span> ListeningStatus
<span class="token keyword">suspend</span> <span class="token keyword">fun</span> T<span class="token punctuation">.</span><span class="token function">onEvent</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token operator">:</span> Nothing
<span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">onEvent</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span>
<span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">onEvent</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token operator">:</span> ListeningStatus
<span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">onEvent</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token operator">:</span> Nothing
<span class="token keyword">suspend</span> <span class="token keyword">fun</span> T<span class="token punctuation">.</span><span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">suspend</span> <span class="token keyword">fun</span> T<span class="token punctuation">.</span><span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ListeningStatus
<span class="token keyword">suspend</span> <span class="token keyword">fun</span> T<span class="token punctuation">.</span><span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Nothing
<span class="token keyword">fun</span> T<span class="token punctuation">.</span><span class="token function">onEvent</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span>
<span class="token keyword">fun</span> T<span class="token punctuation">.</span><span class="token function">onEvent</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token operator">:</span> ListeningStatus
<span class="token keyword">fun</span> T<span class="token punctuation">.</span><span class="token function">onEvent</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token operator">:</span> Nothing
<span class="token keyword">fun</span> <span class="token function">onEvent</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span>
<span class="token keyword">fun</span> <span class="token function">onEvent</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token operator">:</span> ListeningStatus
<span class="token keyword">fun</span> <span class="token function">onEvent</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token operator">:</span> Nothing
<span class="token keyword">fun</span> T<span class="token punctuation">.</span><span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">fun</span> T<span class="token punctuation">.</span><span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ListeningStatus
<span class="token keyword">fun</span> T<span class="token punctuation">.</span><span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Nothing
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Kotlin 使用示例:</p><ul><li>独立 <code>CoroutineScope</code> 和 <code>ListenerHost</code></li></ul><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">object</span> MyEvents <span class="token operator">:</span> ListenerHost <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> coroutineContext <span class="token operator">=</span> <span class="token function">SupervisorJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 可以抛出任何异常, 将在 this.coroutineContext 或 registerEvents 时提供的 CoroutineScope.coroutineContext 中的 CoroutineExceptionHandler 处理.</span>
    <span class="token annotation builtin">@EventHandler</span>
    <span class="token keyword">suspend</span> <span class="token keyword">fun</span> MessageEvent<span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reply</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;received&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
eventChannel<span class="token punctuation">.</span><span class="token function">registerListenerHost</span><span class="token punctuation">(</span>MyEvents<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>onMessage</code> 抛出的异常将会交给 <code>myCoroutineScope</code> 处理</p><ul><li>合并 <code>CoroutineScope</code> 和 <code>ListenerHost</code>: 使用 <code>SimpleListenerHost</code></li></ul><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">object</span> MyEvents <span class="token operator">:</span> <span class="token function">SimpleListenerHost</span><span class="token punctuation">(</span> <span class="token comment">/* override coroutineContext here */</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">handleException</span><span class="token punctuation">(</span>context<span class="token operator">:</span> CoroutineContext<span class="token punctuation">,</span> exception<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 处理 onMessage 中未捕获的异常</span>
    <span class="token punctuation">}</span>
    <span class="token annotation builtin">@EventHandler</span>
    <span class="token keyword">suspend</span> <span class="token keyword">fun</span> MessageEvent<span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 可以抛出任何异常, 将在 handleException 处理</span>
        <span class="token function">reply</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;received&quot;</span></span><span class="token punctuation">)</span>
        <span class="token comment">// 无返回值 (或者返回 Unit), 表示一直监听事件.</span>
    <span class="token punctuation">}</span>
    <span class="token annotation builtin">@EventHandler</span>
    <span class="token keyword">suspend</span> <span class="token keyword">fun</span> MessageEvent<span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ListeningStatus <span class="token punctuation">{</span> <span class="token comment">// 可以抛出任何异常, 将在 handleException 处理</span>
        <span class="token function">reply</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;received&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ListeningStatus<span class="token punctuation">.</span>LISTENING <span class="token comment">// 表示继续监听事件</span>
        <span class="token comment">// return ListeningStatus.STOPPED // 表示停止监听事件</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
eventChannel<span class="token punctuation">.</span><span class="token function">registerListenerHost</span><span class="token punctuation">(</span>MyEvents<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="java-方法" tabindex="-1"><a class="header-anchor" href="#java-方法" aria-hidden="true">#</a> Java 方法</h4><p>所有 Java 方法都会在 <code>Dispatchers.IO</code> 中调用，因此在 Java 也可以调用阻塞方法。</p><p>支持的方法类型：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>// T 表示任何 Event 类型.
void onEvent(T)
Void onEvent(T)
ListeningStatus onEvent(T) // 禁止返回 null
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Java 使用示例:</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyEventHandlers</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleListenerHost</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleException</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NotNull</span> <span class="token class-name">CoroutineContext</span> context<span class="token punctuation">,</span> <span class="token annotation punctuation">@NotNull</span> <span class="token class-name">Throwable</span> exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 处理事件处理时抛出的异常</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@EventHandler</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NotNull</span> <span class="token class-name">MessageEvent</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span> <span class="token comment">// 可以抛出任何异常, 将在 handleException 处理</span>
        event<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string">&quot;received&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 无返回值, 表示一直监听事件.</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@NotNull</span>
    <span class="token annotation punctuation">@EventHandler</span>
    <span class="token keyword">public</span> <span class="token class-name">ListeningStatus</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NotNull</span> <span class="token class-name">MessageEvent</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span> <span class="token comment">// 可以抛出任何异常, 将在 handleException 处理</span>
        event<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string">&quot;received&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ListeningStatus</span><span class="token punctuation">.</span>LISTENING<span class="token punctuation">;</span> <span class="token comment">// 表示继续监听事件</span>
        <span class="token comment">// return ListeningStatus.STOPPED; // 表示停止监听事件</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 注册：</span>
<span class="token comment">// eventChannel.registerListenerHost(new MyEventHandlers())</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>回到 <a href="#%E7%9B%91%E5%90%AC%E4%BA%8B%E4%BB%B6%E7%9A%84%E5%85%B6%E4%BB%96%E6%96%B9%E6%B3%95">监听事件的其他方法</a></p></blockquote><h3 id="在-kotlin-使用-dsl-监听事件" tabindex="-1"><a class="header-anchor" href="#在-kotlin-使用-dsl-监听事件" aria-hidden="true">#</a> 在 Kotlin 使用 DSL 监听事件</h3><blockquote><p><strong>警告：此节内容需要坚实的 Kotlin 技能，盲目使用会导致问题</strong></p></blockquote><p><a href="https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/event/subscribeMessages.kt#L37-L64" target="_blank" rel="noopener noreferrer">subscribeMessages<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>示例：</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code>eventChannel<span class="token punctuation">.</span><span class="token function">subscribeMessages</span> <span class="token punctuation">{</span>
    <span class="token string-literal singleline"><span class="token string">&quot;test&quot;</span></span> <span class="token punctuation">{</span>
        <span class="token comment">// 当消息内容为 &quot;test&quot; 时执行</span>
        <span class="token comment">// this: MessageEvent</span>
        <span class="token function">reply</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;test!&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token string-literal singleline"><span class="token string">&quot;Hello&quot;</span></span> reply <span class="token string-literal singleline"><span class="token string">&quot;Hi&quot;</span></span> <span class="token comment">// 当消息内容为 &quot;Hello&quot; 时回复 &quot;Hi&quot;</span>
    <span class="token string-literal singleline"><span class="token string">&quot;quote me&quot;</span></span> quoteReply <span class="token string-literal singleline"><span class="token string">&quot;ok&quot;</span></span> <span class="token comment">// 当消息内容为 &quot;quote me&quot; 时引用该消息并回复 &quot;ok&quot;</span>
    <span class="token string-literal singleline"><span class="token string">&quot;quote me2&quot;</span></span> quoteReply <span class="token punctuation">{</span>
        <span class="token comment">// lambda 也是允许的：</span>
        <span class="token comment">// 返回值接受 Any? </span>
        <span class="token comment">// 为 Unit 时不发送任何内容；</span>
        <span class="token comment">// 为 Message 时直接发送；</span>
        <span class="token comment">// 为 String 时发送为 PlainText；</span>
        <span class="token comment">// 否则 toString 并发送为 PlainText</span>
        
        <span class="token string-literal singleline"><span class="token string">&quot;ok&quot;</span></span> 
    <span class="token punctuation">}</span> 
    
    <span class="token function">case</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;iGNorECase&quot;</span></span><span class="token punctuation">,</span> ignoreCase<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">)</span> reply <span class="token string-literal singleline"><span class="token string">&quot;OK&quot;</span></span> <span class="token comment">// 忽略大小写</span>
    <span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;-&quot;</span></span><span class="token punctuation">)</span> reply <span class="token punctuation">{</span> cmd <span class="token operator">-&gt;</span>
        <span class="token comment">// 当消息内容以 &quot;-&quot; 开头时执行</span>
        <span class="token comment">// cmd 为消息去除开头 &quot;-&quot; 的内容</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token keyword">val</span> listener<span class="token operator">:</span> Listener<span class="token operator">&lt;</span>MessageEvent<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">&quot;1&quot;</span></span> reply <span class="token string-literal singleline"><span class="token string">&quot;2&quot;</span></span>
    <span class="token comment">// 每个语句都会被注册为事件监听器，可以这样获取监听器</span>
    
    listener<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 停止 &quot;1&quot; reply &quot;2&quot; 这个事件监听</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>回到 <a href="#%E7%9B%AE%E5%BD%95">目录</a></p></blockquote><h2 id="实现事件" tabindex="-1"><a class="header-anchor" href="#实现事件" aria-hidden="true">#</a> 实现事件</h2><p>相信你在使用 mirai 自带的事件时已经感到受益匪浅了，这种机制也可以作用在你的程序上，让其他人的程序也能像监听 mirai 自带的事件一样，对你程序的行为作出反应。</p><h3 id="新建事件" tabindex="-1"><a class="header-anchor" href="#新建事件" aria-hidden="true">#</a> 新建事件</h3><p>新建一个类，让类实现接口 <code>Event</code> 并继承 <code>AbstractEvent</code> 即可。根据内部实现，事件必须继承 <code>AbstractEvent</code>，如下示例。</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token comment">// kotlin:</span>
<span class="token keyword">class</span> <span class="token function">ExampleEvent</span><span class="token punctuation">(</span>
    <span class="token keyword">var</span> action<span class="token operator">:</span> String
<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">AbstractEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// java:</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExampleEvent</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractEvent</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> action<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">ExampleEvent</span><span class="token punctuation">(</span><span class="token class-name">String</span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>action <span class="token operator">=</span> action<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> action<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAction</span><span class="token punctuation">(</span><span class="token class-name">String</span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>action <span class="token operator">=</span> action<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="广播自定义事件" tabindex="-1"><a class="header-anchor" href="#广播自定义事件" aria-hidden="true">#</a> 广播自定义事件</h3><p>事件需要被广播，才会被监听器接收到，使已监听事件的程序作出响应。以上文的 <code>ExampleEvent</code> 为例，</p><p>kotlin：<code>event.broadcast()</code></p><p>java：<code>EventKt.broadcast(Event)</code></p><blockquote><p>注: 在 kotlin 中进行事件的广播需要在协程上下文执行</p></blockquote><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token comment">// kotlin:</span>
<span class="token keyword">var</span> event <span class="token operator">=</span> <span class="token function">ExampleEvent</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;some action&quot;</span></span><span class="token punctuation">)</span>
<span class="token keyword">var</span> finalAction <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>action
<span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;action = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">finalAction</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// java:</span>
<span class="token class-name">ExampleEvent</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExampleEvent</span><span class="token punctuation">(</span><span class="token string">&quot;some action&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> finalAction <span class="token operator">=</span> <span class="token class-name">EventKt</span><span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;action = &quot;</span> <span class="token operator">+</span> finalAction<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="监听自定义事件" tabindex="-1"><a class="header-anchor" href="#监听自定义事件" aria-hidden="true">#</a> 监听自定义事件</h3><p>同上文监听事件的方式几乎一样。不过需要注意的是，从 bot 获取的消息通道 (<code>bot.eventChannel</code>)，只能监听 <code>BotEvent</code>，如果你的事件类没有实现 <code>BotEvent</code>，将无法通过这个通道来监听此事件。因此你可能需要使用 <code>GlobalEventChannel</code> 来代替 <code>bot.eventChannel</code>。</p><p>以下的示例是 监听事件以影响上一个部分 <code>广播自定义事件</code> 中的变量 <code>action</code> 的值。</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token comment">// kotlin:</span>
GlobalEventChannel<span class="token punctuation">.</span>subscribeAlways<span class="token operator">&lt;</span>ExampleEvent<span class="token operator">&gt;</span> <span class="token punctuation">{</span> event <span class="token operator">-&gt;</span>
    <span class="token comment">// 处理事件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>action <span class="token operator">==</span> <span class="token string-literal singleline"><span class="token string">&quot;some action&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">.</span>action <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">&quot;another action&quot;</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// java:</span>
<span class="token class-name">GlobalEventChannel</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">subscribeAlways</span><span class="token punctuation">(</span><span class="token class-name">ExampleEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> event <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 处理事件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;some action&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span><span class="token string">&quot;another action&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="在-console-中自定义事件" tabindex="-1"><a class="header-anchor" href="#在-console-中自定义事件" aria-hidden="true">#</a> 在 Console 中自定义事件</h3><p>请参考 <a href="/console/plugin/JVMPlugin-DataExchange.html" class="">Console - JVMPlugin - Data Exchange</a></p><blockquote><p>回到 <a href="#%E7%9B%AE%E5%BD%95">目录</a></p></blockquote><h2 id="工具函数-kotlin" tabindex="-1"><a class="header-anchor" href="#工具函数-kotlin" aria-hidden="true">#</a> 工具函数（Kotlin）</h2><blockquote><p><em>可能需要较好的 Kotlin 技能才能理解以下内容。</em><strong>可以<a href="#">跳过本节</a></strong></p></blockquote><p>基于 Kotlin 协程特性，mirai 提供 `</p><h3 id="线性同步-syncfromevent" tabindex="-1"><a class="header-anchor" href="#线性同步-syncfromevent" aria-hidden="true">#</a> 线性同步（<code>syncFromEvent</code>）</h3><p><a href="https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/event/syncFromEvent.kt" target="_blank" rel="noopener noreferrer">syncFromEvent.kt<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>挂起协程并获取下一个戳 Bot 的对象：</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> target<span class="token operator">:</span> UserOrBot <span class="token operator">=</span> syncFromEvent<span class="token operator">&lt;</span>BotNudgedEvent<span class="token operator">&gt;</span> <span class="token punctuation">{</span> sender <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>带超时版本：</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> target<span class="token operator">:</span> UserOrBot <span class="token operator">=</span> syncFromEvent<span class="token operator">&lt;</span>BotNudgedEvent<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> sender <span class="token punctuation">}</span> <span class="token comment">// 5000ms</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>异步 <code>async</code> 版本：</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> target<span class="token operator">:</span> Deferred<span class="token operator">&lt;</span>UserOrBot<span class="token operator">&gt;</span> <span class="token operator">=</span> coroutineScope<span class="token punctuation">.</span>asyncFromEvent<span class="token operator">&lt;</span>BotNudgedEvent<span class="token operator">&gt;</span> <span class="token punctuation">{</span> sender <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="线性同步-nextevent" tabindex="-1"><a class="header-anchor" href="#线性同步-nextevent" aria-hidden="true">#</a> 线性同步（<code>nextEvent</code>）</h3><p><a href="https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/event/nextEvent.kt" target="_blank" rel="noopener noreferrer">nextEvent.kt<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>挂起协程并获取下一个指定事件：</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> event<span class="token operator">:</span> BotNudgedEvent <span class="token operator">=</span> nextEvent<span class="token operator">&lt;</span>BotNudgedEvent<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>带超时和过滤器版本：</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">val</span> event<span class="token operator">:</span> BotNudgedEvent <span class="token operator">=</span> nextEvent<span class="token operator">&lt;</span>BotNudgedEvent<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> it<span class="token punctuation">.</span>bot<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token number">123456L</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="条件选择-selectmessages" tabindex="-1"><a class="header-anchor" href="#条件选择-selectmessages" aria-hidden="true">#</a> 条件选择（<code>selectMessages</code>）</h3><blockquote><p><strong>警告：此节内容需要坚实的 Kotlin 技能，盲目使用会导致问题</strong></p></blockquote><p><a href="https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/event/select.kt" target="_blank" rel="noopener noreferrer">select.kt<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>类似于 Kotlin 协程 <code>select</code>，mirai 也提供类似的功能。</p><p><code>selectMessages</code>：挂起当前协程，等待任意一个事件监听器触发后返回其返回值。</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code>MyCoroutineScope<span class="token punctuation">.</span>subscribeAlways<span class="token operator">&lt;</span>GroupMessageEvent<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">contentEquals</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;ocr&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        subject<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;请发送你要进行 OCR 的图片或图片链接&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> image<span class="token operator">:</span> InputStream <span class="token operator">=</span> selectMessages <span class="token punctuation">{</span>
            has<span class="token operator">&lt;</span>Image<span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token function">URL</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">queryUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            has<span class="token operator">&lt;</span>PlainText<span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token function">URL</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            defaultReply <span class="token punctuation">{</span> <span class="token string-literal singleline"><span class="token string">&quot;请发送图片或图片链接&quot;</span></span> <span class="token punctuation">}</span>
            <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">30_000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> event<span class="token punctuation">.</span><span class="token function">quoteReply</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;请在 30 秒内发送图片或图片链接&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">null</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token operator">?:</span> <span class="token keyword">return</span><span class="token label symbol">@subscribeAlways</span>
        
        <span class="token keyword">val</span> result <span class="token operator">=</span> <span class="token function">ocr</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        subject<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">quote</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这种语法就相当于（伪代码）：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>val image = when (下一条消息) {
   包含图片 { 查询图片链接() } 
   包含纯文本URL { 下载图片() }
   其他情况 { 引用回复() }
   超时 { 引用回复() }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="循环条件选择-whileselectmessages" tabindex="-1"><a class="header-anchor" href="#循环条件选择-whileselectmessages" aria-hidden="true">#</a> 循环条件选择（<code>whileSelectMessages</code>）</h3><blockquote><p><strong>警告：此节内容需要坚实的 Kotlin 技能，盲目使用会导致问题</strong></p></blockquote><p><a href="https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/event/select.kt" target="_blank" rel="noopener noreferrer">select.kt<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>类似于 Kotlin 协程 <code>whileSelect</code>，mirai 也提供类似的功能。</p><p><code>whileSelectMessages</code>：挂起当前协程，等待任意一个事件监听器返回 <code>false</code> 后返回。</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code>subject<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;开启复读模式&quot;</span></span><span class="token punctuation">)</span>
whileSelectMessages <span class="token punctuation">{</span>
    <span class="token string-literal singleline"><span class="token string">&quot;stop&quot;</span></span> <span class="token punctuation">{</span>
        subject<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;已关闭复读&quot;</span></span><span class="token punctuation">)</span>
        <span class="token boolean">false</span> <span class="token comment">// 停止循环</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 也可以使用 startsWith(&quot;&quot;) { ... } 等 DSL</span>
    default <span class="token punctuation">{</span>
        subject<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
        <span class="token boolean">true</span> <span class="token comment">// 继续循环</span>
    <span class="token punctuation">}</span>
    <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// on</span>
        <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token comment">// 等待直到 `false`</span>
subject<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;复读模式结束&quot;</span></span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>回到 <a href="#%E7%9B%AE%E5%BD%95">目录</a></p></blockquote><h6 id="" tabindex="-1"><a class="header-anchor" href="#" aria-hidden="true">#</a></h6><hr><blockquote><p>下一步，<a href="/Messages.html" class="">Messages</a></p><p><a href="/CoreAPI.html" class="">回到 Mirai 文档索引</a></p></blockquote></div><!--[--><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.ee53b164.js" defer></script>
  </body>
</html>
