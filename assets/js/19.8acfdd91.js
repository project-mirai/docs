(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{390:function(t,a,e){"use strict";e.r(a);var s=e(49),n=Object(s.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"mirai-messages"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#mirai-messages"}},[t._v("#")]),t._v(" Mirai - Messages")]),t._v(" "),e("h2",{attrs:{id:"目录"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#目录"}},[t._v("#")]),t._v(" 目录")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"#%E6%B6%88%E6%81%AF%E7%B3%BB%E7%BB%9F"}},[t._v("消息系统")])]),t._v(" "),e("li",[e("a",{attrs:{href:"#%E6%B6%88%E6%81%AF%E7%B1%BB%E5%9E%8B"}},[t._v("消息类型")])]),t._v(" "),e("li",[e("a",{attrs:{href:"#%E6%B6%88%E6%81%AF%E5%85%83%E7%B4%A0"}},[t._v("消息元素")])]),t._v(" "),e("li",[e("a",{attrs:{href:"#%E6%B6%88%E6%81%AF%E9%93%BE"}},[t._v("消息链")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"}},[t._v("发送消息")])]),t._v(" "),e("li",[e("a",{attrs:{href:"#%E6%9E%84%E9%80%A0%E6%B6%88%E6%81%AF%E9%93%BE"}},[t._v("构造消息链")])]),t._v(" "),e("li",[e("a",{attrs:{href:"#%E5%85%83%E7%B4%A0%E5%94%AF%E4%B8%80%E6%80%A7"}},[t._v("元素唯一性")])]),t._v(" "),e("li",[e("a",{attrs:{href:"#%E8%8E%B7%E5%8F%96%E6%B6%88%E6%81%AF%E9%93%BE%E4%B8%AD%E7%9A%84%E6%B6%88%E6%81%AF%E5%85%83%E7%B4%A0"}},[t._v("获取消息链中的消息元素")])]),t._v(" "),e("li",[e("a",{attrs:{href:"#%E5%BA%8F%E5%88%97%E5%8C%96"}},[t._v("序列化")])]),t._v(" "),e("li",[e("a",{attrs:{href:"#%E6%B6%88%E6%81%AF%E7%9A%84%E5%85%B6%E4%BB%96%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD"}},[t._v("消息的其他常用功能")])])])]),t._v(" "),e("li",[e("a",{attrs:{href:"#mirai-%E7%A0%81"}},[t._v("Mirai 码")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"#%E8%BD%AC%E4%B9%89%E8%A7%84%E5%88%99"}},[t._v("转义规则")])]),t._v(" "),e("li",[e("a",{attrs:{href:"#%E6%B6%88%E6%81%AF%E9%93%BE%E7%9A%84-mirai-%E7%A0%81"}},[t._v("消息链的 mirai 码")])]),t._v(" "),e("li",[e("a",{attrs:{href:"#%E7%94%B1-codablemessage-%E5%8F%96%E5%BE%97-mirai-%E7%A0%81%E5%AD%97%E7%AC%A6%E4%B8%B2"}},[t._v("由 "),e("code",[t._v("CodableMessage")]),t._v(" 取得 mirai 码字符串")])]),t._v(" "),e("li",[e("a",{attrs:{href:"#%E7%94%B1-mirai-%E7%A0%81%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8F%96%E5%BE%97-messagechain-%E5%AE%9E%E4%BE%8B"}},[t._v("由 mirai 码字符串取得 "),e("code",[t._v("MessageChain")]),t._v(" 实例")])]),t._v(" "),e("li",[e("a",{attrs:{href:"#serializetomiraicode-%E4%B8%8E-tostring-%E7%9A%84%E5%8C%BA%E5%88%AB"}},[e("code",[t._v("serializeToMiraiCode")]),t._v(" 与 "),e("code",[t._v("toString")]),t._v(" 的区别")])])])])]),t._v(" "),e("hr"),t._v(" "),e("h2",{attrs:{id:"消息系统"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#消息系统"}},[t._v("#")]),t._v(" 消息系统")]),t._v(" "),e("p",[t._v("在 Contacts 章节提到，要发送消息，使用 "),e("code",[t._v("Contact.sendMessage(Message)")]),t._v("。"),e("code",[t._v("Message")]),t._v(" 架构如下图所示。")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoiY2xhc3NEaWFncmFtXG5cbmNsYXNzIE1lc3NhZ2VDaGFpblxuTWVzc2FnZUNoYWluIDogTGlzdH5TaW5nbGVNZXNzYWdlflxuXG5NZXNzYWdlPHwtLU1lc3NhZ2VDaGFpblxuTWVzc2FnZTx8LS1TaW5nbGVNZXNzYWdlXG5cbk1lc3NhZ2VDaGFpbiBvLS0gU2luZ2xlTWVzc2FnZVxuXG5TaW5nbGVNZXNzYWdlPHwtLU1lc3NhZ2VDb250ZW50XG5TaW5nbGVNZXNzYWdlPHwtLU1lc3NhZ2VNZXRhZGF0YVxuXG4iLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ",target:"_blank",rel:"noopener noreferrer"}},[e("img",{attrs:{src:"https://mermaid.ink/img/eyJjb2RlIjoiY2xhc3NEaWFncmFtXG5cbmNsYXNzIE1lc3NhZ2VDaGFpblxuTWVzc2FnZUNoYWluIDogTGlzdH5TaW5nbGVNZXNzYWdlflxuXG5NZXNzYWdlPHwtLU1lc3NhZ2VDaGFpblxuTWVzc2FnZTx8LS1TaW5nbGVNZXNzYWdlXG5cbk1lc3NhZ2VDaGFpbiBvLS0gU2luZ2xlTWVzc2FnZVxuXG5TaW5nbGVNZXNzYWdlPHwtLU1lc3NhZ2VDb250ZW50XG5TaW5nbGVNZXNzYWdlPHwtLU1lc3NhZ2VNZXRhZGF0YVxuXG4iLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ",alt:""}}),e("OutboundLink")],1)]),t._v(" "),e("p",[e("code",[t._v("SingleMessage")]),t._v(" 表示单个消息元素。"),e("br"),t._v(" "),e("code",[t._v("MessageChain")]),t._v("（消息链） 是 "),e("code",[t._v("List<SingleMessage>")]),t._v("。主动发送的消息和从服务器接收消息都是 "),e("code",[t._v("MessageChain")]),t._v("。")]),t._v(" "),e("blockquote",[e("p",[t._v("回到 "),e("a",{attrs:{href:"#%E7%9B%AE%E5%BD%95"}},[t._v("目录")])])]),t._v(" "),e("h2",{attrs:{id:"消息类型"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#消息类型"}},[t._v("#")]),t._v(" 消息类型")]),t._v(" "),e("p",[t._v("Mirai 支持富文本消息。")]),t._v(" "),e("p",[e("em",[t._v("单个消息元素（"),e("code",[t._v("SingleMessage")]),t._v("）")]),t._v(" 分为 "),e("em",[t._v("内容（"),e("code",[t._v("MessageContent")]),t._v("）")]),t._v(" 和 "),e("em",[t._v("元数据（"),e("code",[t._v("MessageMetadata")]),t._v("）")]),t._v("。")]),t._v(" "),e("p",[t._v("实践中，消息内容和消息元数据会混合存在于消息链中。")]),t._v(" "),e("h3",{attrs:{id:"内容"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#内容"}},[t._v("#")]),t._v(" 内容")]),t._v(" "),e("p",[e("em",[t._v("内容（"),e("code",[t._v("MessageContent")]),t._v("）")]),t._v(" 即为 "),e("em",[t._v("纯文本")]),t._v("、"),e("em",[t._v("提及某人")]),t._v("、"),e("em",[t._v("图片")]),t._v("、"),e("em",[t._v("语音")]),t._v(" 和 "),e("em",[t._v("音乐分享")]),t._v(" 等"),e("strong",[t._v("有内容")]),t._v("的数据，一条消息中必须包含内容才能发送。")]),t._v(" "),e("h3",{attrs:{id:"元数据"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#元数据"}},[t._v("#")]),t._v(" 元数据")]),t._v(" "),e("p",[e("em",[t._v("元数据（"),e("code",[t._v("MessageMetadata")]),t._v("）")]),t._v(" 包含 "),e("em",[t._v("来源")]),t._v("、"),e("em",[t._v("引用回复")]),t._v(" 和 "),e("em",[t._v("秀图标识")]),t._v(" 等。")]),t._v(" "),e("ul",[e("li",[e("em",[t._v("消息来源")]),t._v("（"),e("code",[t._v("MessageSource")]),t._v("）存在于每条消息中，包含唯一识别信息，用于撤回和引用回复的定位。")]),t._v(" "),e("li",[e("em",[t._v("引用回复")]),t._v("（"),e("code",[t._v("QuoteReply")]),t._v("）若存在，则会在客户端中解析为本条消息引用了另一条消息。")]),t._v(" "),e("li",[e("em",[t._v("秀图标识")]),t._v("（"),e("code",[t._v("ShowImageFlag")]),t._v("）若存在，则表明这条消息中的图片是以秀图发送（QQ 的一个功能）。")])]),t._v(" "),e("p",[t._v("元数据与内容的区分就在于，一条消息没有元数据也能显示，但一条消息不能没有内容。"),e("strong",[t._v("元数据是消息的属性")]),t._v("。")]),t._v(" "),e("p",[t._v("后文会介绍如何获取元数据。")]),t._v(" "),e("blockquote",[e("p",[t._v("回到 "),e("a",{attrs:{href:"#%E7%9B%AE%E5%BD%95"}},[t._v("目录")])])]),t._v(" "),e("hr"),t._v(" "),e("h2",{attrs:{id:"消息元素"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#消息元素"}},[t._v("#")]),t._v(" 消息元素")]),t._v(" "),e("p",[t._v("Mirai 支持多种消息类型。")]),t._v(" "),e("p",[t._v("消息拥有三种转换到字符串的表示方式。")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"left"}},[t._v("方法")]),t._v(" "),e("th",{staticStyle:{"text-align":"left"}},[t._v("解释")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("serializeToMiraiCode()")])]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("对应的 Mirai 码. 消息的一种序列化方式，格式为 "),e("code",[t._v("[mirai:TYPE:PROP]")]),t._v("，其中 "),e("code",[t._v("TYPE")]),t._v(" 为消息类型, "),e("code",[t._v("PROP")]),t._v(" 为属性")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("contentToSting()")])]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("QQ 对话框中以纯文本方式会显示的消息内容。无法用纯文字表示的消息会丢失信息，如任何图片都是 "),e("code",[t._v("[图片]")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("toString()")])]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("Java 对象的 "),e("code",[t._v("toString()")]),t._v("，会尽可能包含多的信息用于调试作用，"),e("strong",[t._v("行为可能不确定")])])])])]),t._v(" "),e("p",[t._v("各类型消息元素及其 "),e("code",[t._v("contentToString()")]),t._v(" 如下表格所示。")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/SingleMessage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("MessageContent")]),e("OutboundLink")],1),t._v(" 类型")]),t._v(" "),e("th",{staticStyle:{"text-align":"left"}},[t._v("解释")]),t._v(" "),e("th",{staticStyle:{"text-align":"left"}},[e("code",[t._v("contentToString()")])]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("最低支持的版本")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/PlainText.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("PlainText")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("纯文本")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("$content")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/Image.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("Image")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("自定义图片")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[图片]")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/At.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("At")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("提及某人")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("@$target")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/AtAll.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("AtAll")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("提及全体成员")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("@全体成员")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/Face.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("Face")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("原生表情")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[表情对应的中文名]")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/FlashImage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("FlashImage")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("闪照")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[闪照]")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/PokeMessage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("PokeMessage")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("戳一戳消息（消息非动作）")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[戳一戳]")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/VipFace.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("VipFace")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("VIP 表情")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[${kind.name}]x$count")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/RichMessage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("LightApp")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("小程序")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("$content")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/Voice.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("Voice")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("语音（已弃用）")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[语音消息]")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.0  "),e("em",[e("sup",[t._v("(3)")])])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/MarketFace.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("MarketFace")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("商城表情")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[表情对应的中文名]")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/ForwardMessage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("ForwardMessage")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("合并转发")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[转发消息]")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.0  "),e("em",[e("sup",[t._v("(1)")])])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/RichMessage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("SimpleServiceMessage")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("（不稳定）服务消息")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("$content")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/MusicShare.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("MusicShare")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("音乐分享")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[分享]曲名")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.1")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/Dice.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("Dice")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("魔法表情骰子")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[骰子:$value]")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.5")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/FileMessage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("FileMessage")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("文件消息")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[文件]文件名称")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.5")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/Audio.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("Audio")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("语音")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[语音消息]")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.7")])])])]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/SingleMessage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("MessageMetadata")]),e("OutboundLink")],1),t._v(" 类型")]),t._v(" "),e("th",{staticStyle:{"text-align":"left"}},[t._v("解释")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("最低支持的版本")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/MessageSource.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("MessageSource")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("消息来源元数据")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/QuoteReply.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("QuoteReply")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("引用回复")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.0")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/ShowImageFlag.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("ShowImageFlag")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("秀图标识")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.2")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/MessageOrigin.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("RichMessageOrigin")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("富文本消息源")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.3 "),e("em",[e("sup",[t._v("(2)")])])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/MessageOrigin.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("MessageOrigin")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("富文本消息源")]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[t._v("2.6")])])])]),t._v(" "),e("blockquote",[e("p",[e("em",[t._v("(1):")]),t._v(" "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/ForwardMessage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("ForwardMessage")]),e("OutboundLink")],1),t._v(" 在 2.0 支持发送, 在 2.3 支持接收"),e("br"),t._v(" "),e("em",[t._v("(2):")]),t._v(" "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/MessageOrigin.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("RichMessageOrigin")]),e("OutboundLink")],1),t._v(" 在 2.3 增加, 在 2.6 弃用并以 "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/MessageOrigin.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("MessageOrigin")]),e("OutboundLink")],1),t._v(" 替换"),e("br"),t._v(" "),e("em",[t._v("(3):")]),t._v(" "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/Voice.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("Voice")]),e("OutboundLink")],1),t._v(" 在 2.0 增加, 在 2.7 弃用并以 "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/Audio.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("Audio")]),e("OutboundLink")],1),t._v(" 替换")])]),t._v(" "),e("h3",{attrs:{id:"用法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#用法"}},[t._v("#")]),t._v(" 用法")]),t._v(" "),e("p",[t._v("只需要得到各种类型 "),e("code",[t._v("Message")]),t._v(" 的实例就可以使用，可以直接发送（"),e("code",[t._v("Contact.sendMessage")]),t._v("）也可以连接到消息链中（"),e("code",[t._v("Message.plus")]),t._v("）。")]),t._v(" "),e("p",[t._v("可在上文表格中找到需要的类型并在源码内文档获取更多实践上的帮助。")]),t._v(" "),e("blockquote",[e("p",[t._v("回到 "),e("a",{attrs:{href:"#%E7%9B%AE%E5%BD%95"}},[t._v("目录")])])]),t._v(" "),e("h2",{attrs:{id:"消息链"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#消息链"}},[t._v("#")]),t._v(" 消息链")]),t._v(" "),e("p",[t._v("前文已经介绍消息链，这里简略介绍消息链的使用。详细的使用请查看源码内注释。")]),t._v(" "),e("h3",{attrs:{id:"发送消息"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#发送消息"}},[t._v("#")]),t._v(" 发送消息")]),t._v(" "),e("p",[t._v("在 "),e("RouterLink",{attrs:{to:"/Contacts.html"}},[t._v("Contacts 章节")]),t._v(" 提到，要发送消息使用 "),e("code",[t._v("Contact.sendMessage")]),t._v("。"),e("code",[t._v("Contact.sendMessage")]),t._v(" 的定义是：")],1),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("suspend")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendMessage")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("message"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Message"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" MessageReceipt"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Contact"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[t._v("要发送字符串消息，使用：（第一部分是 Kotlin，随后是 Java，下同）")]),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[t._v("contact"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendMessage")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hello!"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[t._v("contact"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendMessage")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hello!"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[t._v("发送字符串实际上是在发送纯文本消息。上面的代码相当于：")]),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[t._v("contact"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendMessage")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("PlainText")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hello!"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[t._v("contact"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendMessage")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PlainText")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hello!"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[t._v("要发送多元素消息，可将消息使用 "),e("code",[t._v("plus")]),t._v(" 操作连接：")]),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[t._v("contact"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendMessage")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("PlainText")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"你要的图片是"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("Image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{f8f1ab55-bf8e-4236-b55e-955848d7069f}.png"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 一个纯文本加一个图片")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[t._v("contact"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendMessage")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PlainText")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"你要的图片是："')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("plus")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("fromId")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{f8f1ab55-bf8e-4236-b55e-955848d7069f}.png"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 一个纯文本加一个图片")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[t._v("注: 当需要拼接的消息较多的时候, 建议使用 "),e("a",{attrs:{href:"#%E6%9E%84%E9%80%A0%E6%B6%88%E6%81%AF%E9%93%BE"}},[t._v("构造消息链")]),t._v(" 而不是 "),e("code",[t._v("plus")])]),t._v(" "),e("ul",[e("li",[e("code",[t._v("plus")]),t._v(" 在需要拼接的元素较多的时候运行效率较慢")])]),t._v(" "),e("h3",{attrs:{id:"构造消息链"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#构造消息链"}},[t._v("#")]),t._v(" 构造消息链")]),t._v(" "),e("p",[t._v("更复杂的消息则需要构造为消息链。")]),t._v(" "),e("h4",{attrs:{id:"在-kotlin-构造消息链"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#在-kotlin-构造消息链"}},[t._v("#")]),t._v(" 在 Kotlin 构造消息链")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"left"}},[t._v("定义")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("fun Iterable<Messaged>.toMessageChain(): MessageChain")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("fun Sequence<Messaged>.toMessageChain(): MessageChain")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("fun Array<Message>.toMessageChain(): MessageChain")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("fun Message.toMessageChain(): MessageChain")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("fun messageChainOf(vararg Message): MessageChain")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("fun Message.plus(tail: Message): MessageChain")])])])])]),t._v(" "),e("p",[t._v("可以使用如上表格所示的方法构造，或使用 DSL builder。")]),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" MessageChainBuilder "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" MutableList"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("SingleMessage"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Appendable "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("operator")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" Message"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("unaryPlus")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("operator")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" String"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("unaryPlus")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("vararg")]),t._v(" messages"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Message"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br")])]),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" chain "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" buildMessageChain "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("PlainText")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"a"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("AtAll\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("Image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/f8f1ab55-bf8e-4236-b55e-955848d7069f"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("At")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("123456")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// `+` 和 `add` 作用相同")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// chain 结果是包含 PlainText, AtAll, Image, At 的 MessageChain")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br")])]),e("p",[t._v("该示例中 "),e("code",[t._v("+")]),t._v(" 是位于 "),e("code",[t._v("MessageChainBuilder")]),t._v(" 的 "),e("code",[t._v("Message.unaryPlus")]),t._v(" 扩展。使用 "),e("code",[t._v("+")]),t._v(" 和使用 "),e("code",[t._v("add")]),t._v(" 是相等的。")]),t._v(" "),e("h4",{attrs:{id:"在-java-构造消息链"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#在-java-构造消息链"}},[t._v("#")]),t._v(" 在 Java 构造消息链")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"left"}},[t._v("定义")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("public static MessageChain newChain(Iterable<Message> iterable)")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("public static MessageChain newChain(Message iterable...)")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("public static MessageChain newChain(Iterator<Message> iterable...)")])])])])]),t._v(" "),e("p",[t._v("方法都位于 "),e("code",[t._v("net.mamoe.mirai.message.data.MessageUtils")]),t._v("。")]),t._v(" "),e("p",[t._v("使用 "),e("code",[t._v("newChain")]),t._v("：")]),t._v(" "),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageChain")]),t._v(" chain "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageUtils")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("newChain")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PlainText")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hello"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("fromId")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{f8f1ab55-bf8e-4236-b55e-955848d7069f}.png"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[t._v("使用 "),e("code",[t._v("MessageChainBuilder")]),t._v(":")]),t._v(" "),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageChain")]),t._v(" chain "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageChainBuilder")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PlainText")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"string"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"string"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 会被构造成 PlainText 再添加, 相当于上一行")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AtAll")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("INSTANCE"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("fromId")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{f8f1ab55-bf8e-4236-b55e-955848d7069f}.png"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("build")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])]),e("h3",{attrs:{id:"作为字符串处理消息"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#作为字符串处理消息"}},[t._v("#")]),t._v(" 作为字符串处理消息")]),t._v(" "),e("p",[t._v("通常要把消息作为字符串处理，在 Kotlin 使用 "),e("code",[t._v("message.content")]),t._v(" 或在 Java 使用 "),e("code",[t._v("message.contentToString()")]),t._v("。")]),t._v(" "),e("p",[t._v("获取到的字符串表示只包含各 "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/SingleMessage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("MessageContent")]),e("OutboundLink")],1),t._v(" 以官方风格显示的消息内容。如 "),e("code",[t._v('"你本次测试的成绩是[图片]"')]),t._v("、"),e("code",[t._v("[语音]")]),t._v("、"),e("code",[t._v("[微笑]")]),t._v("。")]),t._v(" "),e("h3",{attrs:{id:"处理富文本消息"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#处理富文本消息"}},[t._v("#")]),t._v(" 处理富文本消息")]),t._v(" "),e("p",[t._v("Mirai 不内置富文本消息的处理工具类。"),e("code",[t._v("MessageChain")]),t._v(" 实现接口 "),e("code",[t._v("List<SingleMessage>")]),t._v("，一个思路是遍历 list 并判断类型处理：")]),t._v(" "),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("element "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" messageChain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("element "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("instanceof")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 处理一个 Image")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br")])]),e("p",[t._v("也可以像数组一样按下标随机访问：")]),t._v(" "),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SingleMessage")]),t._v(" element "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" messageChain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("element "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("instanceof")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 处理一个 Image")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br")])]),e("h3",{attrs:{id:"元素唯一性"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#元素唯一性"}},[t._v("#")]),t._v(" 元素唯一性")]),t._v(" "),e("p",[t._v("部分元素只能单一存在于消息链中。这样的元素实现接口 "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/ConstrainSingle.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("ConstrainSingle")]),e("OutboundLink")],1),t._v("。")]),t._v(" "),e("p",[t._v("唯一的元素例如 "),e("em",[t._v("消息元数据")]),t._v(" "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/MessageSource.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("MessageSource")]),e("OutboundLink")],1),t._v("，在连接时，新的（右侧）元素会替换旧的（左侧）元素。如：")]),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" source1"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" MessageSource\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" source2"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" MessageSource\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" chain"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" MessageChain "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" source1 "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" source2\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 结果 chain 只包含一个元素，即右侧的 source2。")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br")])]),e("p",[t._v("元素唯一性的识别基于 "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/MessageKey.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("MessageKey")]),e("OutboundLink")],1),t._v("。有些 "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/MessageKey.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("MessageKey")]),e("OutboundLink")],1),t._v(" 拥有多态机制。例如 "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/HummerMessage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("HummerMessage")]),e("OutboundLink")],1),t._v(" 的继承关系")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("              MessageContent\n                    ↑\n              HummerMessage\n                    ↑\n       +------------+-------------+------------+\n       |            |             |            |\n PokeMessage     VipFace      FlashImage      ...\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br")])]),e("p",[t._v("当连接一个 "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/VipFace.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("VipFace")]),e("OutboundLink")],1),t._v(" 到一个 "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/MessageChain.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("MessageChain")]),e("OutboundLink")],1),t._v(" 时，由于 "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/VipFace.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("VipFace")]),e("OutboundLink")],1),t._v(" 最远父类为 "),e("code",[t._v("MessageContent")]),t._v("，消息链中第一个 "),e("code",[t._v("MessageContent")]),t._v(" 会被（保留顺序地）替换为 "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/VipFace.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("VipFace")]),e("OutboundLink")],1),t._v("，其他所有 "),e("code",[t._v("MessageContent")]),t._v(" 都会被删除。")]),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Kotlin")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" face "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("VipFace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("VipFace"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AiXin"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// VipFace 是 ConstrainSingle")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" chain "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("messageChainOf")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plainText"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" quoteReply"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" at"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" atAll"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// quoteReply 是 MessageMetadata, 其他三个都是 MessageContent")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" result "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" chain "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" face "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 右侧的 VipFace 替换掉所有的 MessageContent. 它会存在于第一个 MessageContent 位置.")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 结果为 [VipFace, QuoteReply]")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])]),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Java")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("VipFace")]),t._v(" face "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("VipFace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("VipFace"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AiXin")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// VipFace 是 ConstrainSingle")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageChain")]),t._v(" chain "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageChain")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("newChain")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plainText"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" quoteReply"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" at"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" atAll"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// quoteReply 是 MessageMetadata, 其他三个都是 MessageContent")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageChain")]),t._v(" result "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" chain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("plus")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("face"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 右侧的 VipFace 替换掉所有的 MessageContent. 它会存在于第一个 MessageContent 位置.")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 结果为 [VipFace, QuoteReply]")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])]),e("p",[t._v("简单来说，这符合现实的逻辑：一条消息如果包含了语音，就不能同时包含群文件、提及全体成员、文字内容等元素。进行 "),e("code",[t._v("chain.plus(audio)")]),t._v(" 时，如果消息内容冲突则会发生替换，且总是右侧元素替换左侧元素。"),e("br"),t._v("\n而如果消息可以同时存在，比如一个纯文本和一个或多个图片相连 "),e("code",[t._v("plainText.plus(image1).plus(image2)")]),t._v(" 时没有冲突，不会发生替换。结果将会是 "),e("code",[t._v("[PlainText, Image, Image]")]),t._v(" 的 "),e("code",[t._v("MessageChain")]),t._v("。")]),t._v(" "),e("h3",{attrs:{id:"获取消息链中的消息元素"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#获取消息链中的消息元素"}},[t._v("#")]),t._v(" 获取消息链中的消息元素")]),t._v(" "),e("h4",{attrs:{id:"a-筛选-list"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#a-筛选-list"}},[t._v("#")]),t._v(" A. 筛选 List")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/MessageChain.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("MessageChain")]),e("OutboundLink")],1),t._v(" 继承接口 "),e("code",[t._v("List<SingleMessage>")]),t._v("。")]),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" image"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Image"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" chain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("findIsInstance"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Image"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Image")]),t._v(" image "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" chain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("stream")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("filter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("isInstance")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("findFirst")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("orElse")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[t._v("在 Kotlin 要获取第一个指定类型实例还可以使用快捷扩展。")]),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" image"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Image"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" chain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("findIsInstance"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Image"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" image"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Image "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" chain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("firstIsInstance"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Image"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 不存在时 NoSuchElementException")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br")])]),e("h4",{attrs:{id:"b-获取唯一元素"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#b-获取唯一元素"}},[t._v("#")]),t._v(" B. 获取唯一元素")]),t._v(" "),e("p",[t._v("如果要获取 "),e("code",[t._v("ConstrainSingle")]),t._v(" 的消息元素，可以快速通过键获得。")]),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" quote"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" QuoteReply"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" chain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("QuoteReply"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 类似 Map.get")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" quote"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" QuoteReply "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" chain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getOrFail")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("QuoteReply"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 不存在时 NoSuchElementException")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br")])]),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("QuoteReply")]),t._v(" quote "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" chain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("QuoteReply"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Key")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[t._v("一些元数据就可以通过这个方法获得。如上述示例就是在获取引用回复（"),e("code",[t._v("QuoteReply")]),t._v("）。如果获取不为 "),e("code",[t._v("null")]),t._v(" 则表明这条消息包含对其他某条消息的引用。")]),t._v(" "),e("blockquote",[e("p",[t._v("这是因为 "),e("code",[t._v("MessageKey")]),t._v(" 一般都以消息元素的 "),e("code",[t._v("companion object")]),t._v(" 实现")])]),t._v(" "),e("h4",{attrs:{id:"c-使用属性委托"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#c-使用属性委托"}},[t._v("#")]),t._v(" C. 使用属性委托")]),t._v(" "),e("p",[t._v("可在 Kotlin 使用属性委托。这样的方法与上述方法在性能上等价。")]),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" image"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Image "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("by")]),t._v(" chain "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 不存在时 NoSuchElementException")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" image"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Image"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("by")]),t._v(" chain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("orNull")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" image"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Image"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("by")]),t._v(" chain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("orElse")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 返回一个 Image */")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("h4",{attrs:{id:"d-遍历-list"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#d-遍历-list"}},[t._v("#")]),t._v(" D. 遍历 List")]),t._v(" "),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SingleMessage")]),t._v(" message "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" messageChain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...    ")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("p",[t._v("也可以使用 "),e("code",[t._v("messageChain.iterator()")]),t._v("、 "),e("code",[t._v("messageChain.stream()")]),t._v(" 等。")]),t._v(" "),e("h3",{attrs:{id:"序列化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#序列化"}},[t._v("#")]),t._v(" 序列化")]),t._v(" "),e("blockquote",[e("p",[t._v("简单地讲，序列化指的是将内存中的对象转换为其他易于存储等的表示方式。如对象变 JSON 字符串、对象变 MiraiCode 字符串。")])]),t._v(" "),e("p",[t._v("消息可以序列化为 JSON 字符串，使用 "),e("code",[t._v("MessageChain.serializeToJsonString")]),t._v(" 和 "),e("code",[t._v("MessageChain.deserializeFromJsonString")]),t._v("。")]),t._v(" "),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[t._v("\n"),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" json "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageChain")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("serializeToJsonString")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("message"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageChain")]),t._v(" chain "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageChain")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("deserializeFromJsonString")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("message"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br")])]),e("h4",{attrs:{id:"使用-kotlinx-serialization"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用-kotlinx-serialization"}},[t._v("#")]),t._v(" 使用 kotlinx.serialization")]),t._v(" "),e("p",[t._v("若要将消息类型使用在其他类型中，如")]),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("data")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("Foo")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" image"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Image\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("p",[t._v("则需要在序列化时为 format 添加 "),e("code",[t._v("serializersModule")]),t._v("：")]),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" json "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Json "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    serializersModule "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" MessageSerializers"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("serializersModule\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("p",[t._v("如果遇到 "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/issues/1273#issuecomment-850997979",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("Encountered unknown key 'type'.")]),e("OutboundLink")],1),t._v(" 等序列化错误，请添加：")]),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[t._v("Json "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    serializersModule "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" MessageSerializers"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("serializersModule\n    ignoreUnknownKeys "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 添加这一行")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br")])]),e("h4",{attrs:{id:"元素类型不一定被保留"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#元素类型不一定被保留"}},[t._v("#")]),t._v(" 元素类型不一定被保留")]),t._v(" "),e("p",[t._v("如 "),e("em",[t._v("消息源 "),e("code",[t._v("MessageSource")])]),t._v(" 有 "),e("em",[t._v("在线消息源 "),e("code",[t._v("OnlineMessageSource")])]),t._v(" 和 "),e("em",[t._v("离线消息源 "),e("code",[t._v("OfflineMessageSource")])]),t._v(" 之分。"),e("code",[t._v("OnlineMessageSource")]),t._v(" 在序列化并反序列化后会变为 "),e("code",[t._v("OfflineMessageSource")]),t._v("，因为在线消息源只能从消息回执和消息事件中的 "),e("code",[t._v("MessageChain")]),t._v(" 得到。")]),t._v(" "),e("p",[t._v("但在 API 使用上不会有区别（共有属性获取到的值不会变化）。只是可能需要注意 "),e("code",[t._v("equals")]),t._v(" 等方法的使用。")]),t._v(" "),e("p",[t._v("所有 "),e("code",[t._v("Message")]),t._v(" 反序列化的结果都是 "),e("code",[t._v("MessageChain")]),t._v("，即使原消息可能是 "),e("code",[t._v("SingleMessage")]),t._v("。如果原消息是 "),e("code",[t._v("SingleMessage")]),t._v("，可在反序列化后通过 "),e("code",[t._v("chian.get(0)")]),t._v(" 下标访问并强转类型（或者其他更好的方法）。")]),t._v(" "),e("h4",{attrs:{id:"序列化稳定性"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#序列化稳定性"}},[t._v("#")]),t._v(" 序列化稳定性")]),t._v(" "),e("p",[t._v("在旧版本产生的 JSON 字符串在绝大多数情况下可以由新版本 Mirai 读取并反序列化成原 "),e("code",[t._v("MessageChain")]),t._v("。如果更新时放弃了对某个旧版本消息元素的支持，将会在更新日志中说明。")]),t._v(" "),e("p",[t._v("但这个规则不适用于 "),e("em",[t._v("实验性特性")]),t._v("（带有 "),e("code",[t._v("@MiraiExperimentalApi")]),t._v(" 注解）。任何使用了实验性特性的消息元素都随时可变。")]),t._v(" "),e("h3",{attrs:{id:"消息的其他常用功能"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#消息的其他常用功能"}},[t._v("#")]),t._v(" 消息的其他常用功能")]),t._v(" "),e("h4",{attrs:{id:"撤回自己或群员的消息"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#撤回自己或群员的消息"}},[t._v("#")]),t._v(" 撤回自己或群员的消息")]),t._v(" "),e("p",[t._v("撤回的核心操作是 "),e("code",[t._v("MessageSource.recall")]),t._v("。 如果操作目标 "),e("code",[t._v("MessageSource")]),t._v(" 指代的是自己的消息，那么就撤回该消息，操作群员消息同理。")]),t._v(" "),e("p",[t._v("来自 "),e("code",[t._v("GroupMessageEvent")]),t._v(" 等消息事件的属性 "),e("code",[t._v("message")]),t._v(" 的 "),e("code",[t._v("MessageChain")]),t._v(" 都包含 "),e("code",[t._v("MessageSource")]),t._v(" 元素，指代这条消息本身。那么就可以用来撤回这条消息。")]),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Kotlin")]),t._v("\nmessageSource"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("recall")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nmessageChain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("recall")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取其中 MessageSource 元素并操作 recall ")]),t._v("\n\nmessageSource"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("recallIn")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 启动协程, 3 秒后撤回消息. 返回的 AsyncRecallResult 可以获取结果")]),t._v("\nmessageChain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("recallIn")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])]),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Java")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageSource")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("recall")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("messageSource"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageSource")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("recall")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("messageChain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取其中 MessageSource 元素并操作 recall ")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageSource")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("recallIn")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("messageSource"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 启动异步任务, 3 秒后撤回消息. 返回的 AsyncRecallResult 可以获取结果")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageSource")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("recallIn")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("messageChain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])]),e("h4",{attrs:{id:"发送带有引用回复的消息"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#发送带有引用回复的消息"}},[t._v("#")]),t._v(" 发送带有引用回复的消息")]),t._v(" "),e("p",[t._v("引用回复 "),e("code",[t._v("QuoteReply")]),t._v(" 是一个元数据 "),e("code",[t._v("MessageMetadata")]),t._v("。将 "),e("code",[t._v("QuoteReply")]),t._v(" 实例连接到消息链中，发送后的消息就会引用一条其他消息。")]),t._v(" "),e("p",[t._v("例如监听事件并回复一条群消息：")]),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Kotlin")]),t._v("\nbot"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("eventChannel"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("subscribeAlways"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("GroupMessageEvent"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// this: GroupMessageEvent")]),t._v("\n    subject"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendMessage")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("message"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("quote")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hi!"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// 引用收到的消息并回复 "Hi!", 也可以添加图片等更多元素.')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br")])]),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Java")]),t._v("\nbot"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getEventChannel")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("subscribeAlways"),e("span",{pre:!0,attrs:{class:"token generics"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("GroupMessageEvent")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("event "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageChain")]),t._v(" chain "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageChainBuilder")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// 引用收到的消息并回复 "Hi!", 也可以添加图片等更多元素.')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("QuoteReply")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("event"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMessage")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hi!"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("build")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    event"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getSubject")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendMessage")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br")])]),e("h4",{attrs:{id:"更多消息类型"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#更多消息类型"}},[t._v("#")]),t._v(" 更多消息类型")]),t._v(" "),e("p",[t._v("在 "),e("a",{attrs:{href:"#%E6%B6%88%E6%81%AF%E5%85%83%E7%B4%A0"}},[t._v("消息元素")]),t._v(" 表格中找到你需要的消息元素，然后到源码内注释查看相应的用法说明。")]),t._v(" "),e("blockquote",[e("p",[t._v("回到 "),e("a",{attrs:{href:"#%E7%9B%AE%E5%BD%95"}},[t._v("目录")])])]),t._v(" "),e("hr"),t._v(" "),e("h2",{attrs:{id:"mirai-码"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#mirai-码"}},[t._v("#")]),t._v(" Mirai 码")]),t._v(" "),e("p",[t._v("实现了接口 "),e("code",[t._v("CodableMessage")]),t._v(" 的消息类型支持 mirai 码表示。可以在"),e("a",{attrs:{href:"#%E7%94%B1-codablemessage-%E5%8F%96%E5%BE%97-mirai-%E7%A0%81%E5%AD%97%E7%AC%A6%E4%B8%B2"}},[t._v("下文")]),t._v("找到这些消息类型的列表。")]),t._v(" "),e("h3",{attrs:{id:"转义规则"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#转义规则"}},[t._v("#")]),t._v(" 转义规则")]),t._v(" "),e("p",[t._v("mirai 码内的属性字符串会被转义。")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"center"}},[t._v("原字符")]),t._v(" "),e("th",{staticStyle:{"text-align":"center"}},[t._v("转义结果字符")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("[")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("\\[")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("]")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("\\]")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v(":")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("\\:")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v(",")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("\\,")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("\\")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("\\\\")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("em",[t._v("换行符 \\n")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("\\n")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("em",[t._v("换行符 \\r")])]),t._v(" "),e("td",{staticStyle:{"text-align":"center"}},[e("code",[t._v("\\r")])])])])]),t._v(" "),e("h3",{attrs:{id:"组成约定"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#组成约定"}},[t._v("#")]),t._v(" 组成约定")]),t._v(" "),e("p",[t._v("一个有效的 mirai 码 (如 "),e("code",[t._v("[mirai:atall]")]),t._v(" (无参数), "),e("code",[t._v("[mirai:at:123]")]),t._v(" (有参数)) 可分为以下几个组成部分")]),t._v(" "),e("ul",[e("li",[e("code",[t._v("[mirai:")]),t._v(" 固定开头")]),t._v(" "),e("li",[t._v("消息类型， 如 "),e("code",[t._v("at")])]),t._v(" "),e("li",[t._v("消息参数\n"),e("ul",[e("li",[e("code",[t._v(":")]),t._v(" 固定分隔符")]),t._v(" "),e("li",[t._v("参数内容 "),e("strong",[t._v("(需要进行转义)")])])])]),t._v(" "),e("li",[e("code",[t._v("]")]),t._v(" 固定结尾")])]),t._v(" "),e("h4",{attrs:{id:"为何需要进行转义"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#为何需要进行转义"}},[t._v("#")]),t._v(" 为何需要进行转义")]),t._v(" "),e("p",[t._v("为了 mirai 码的正确解析, 不转义无法正确解析原本意义")]),t._v(" "),e("p",[t._v("假如有以下参数")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('{"msg": [1, 2, 3]}\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[t._v("如果不进行转义直接进行 mirai 码拼接 (如: "),e("code",[t._v('[mirai:msg:{"msg": [1, 2, 3]}]')]),t._v("), 那么 mirai 码会被错误解析")]),t._v(" "),e("blockquote",[e("p",[t._v("解析结果如下:")]),t._v(" "),e("ul",[e("li",[t._v("mirai 码 "),e("code",[t._v('[mirai:msg:{"msg": [1, 2, 3]')])]),t._v(" "),e("li",[t._v("纯文本 "),e("code",[t._v("}]")])])])]),t._v(" "),e("h3",{attrs:{id:"消息链的-mirai-码"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#消息链的-mirai-码"}},[t._v("#")]),t._v(" 消息链的 mirai 码")]),t._v(" "),e("p",[t._v("消息链 "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/MessageChain.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("MessageChain")]),e("OutboundLink")],1),t._v(" 是多个 "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/SingleMessage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("SingleMessage")]),e("OutboundLink")],1),t._v(" 的集合。"),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/MessageChain.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("MessageChain")]),e("OutboundLink")],1),t._v(" 也实现 "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/code/CodableMessage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("CodableMessage")]),e("OutboundLink")],1),t._v("。在转换为 mirai 码时所有 "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/code/CodableMessage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("CodableMessage")]),e("OutboundLink")],1),t._v(" 直接相连：")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('val chain = messageChainOf(PlainText("plain"), At(123), AtAll)\n\nchain.serializeToMiraiCode() // "plain[mirai:at:123][mirai:atall]"\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("h3",{attrs:{id:"由-codablemessage-取得-mirai-码字符串"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#由-codablemessage-取得-mirai-码字符串"}},[t._v("#")]),t._v(" 由 "),e("code",[t._v("CodableMessage")]),t._v(" 取得 mirai 码字符串")]),t._v(" "),e("p",[t._v("通过 "),e("code",[t._v("CodableMessage.serializeToMiraiCode()")]),t._v("。")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("val at = At(123)\n\nat.serializeToMiraiCode() // 结果为 `[mirai:at:123]`\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"center"}},[t._v("消息类型")]),t._v(" "),e("th",{staticStyle:{"text-align":"left"}},[e("code",[t._v("serializeToMiraiCode()")])])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/PlainText.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("PlainText")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("$content")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/Image.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("Image")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[mirai:image:$imageId]")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/At.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("At")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[mirai:at:$target]")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/AtAll.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("AtAll")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[mirai:atall]")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/Face.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("Face")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[mirai:face:id]")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/FlashImage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("FlashImage")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[mirai:flash:${image.imageId}]")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/PokeMessage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("PokeMessage")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[mirai:poke:$name,$pokeType,$id]")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/VipFace.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("VipFace")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[mirai:vipface:${kind.id},${kind.name},$count]")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/RichMessage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("LightApp")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[mirai:app:$content]")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/RichMessage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("SimpleServiceMessage")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[mirai:service:$serviceId,$content]")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/Dice.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("Dice")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[mirai:dice:$value]")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/MusicShare.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("MusicShare")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[mirai:musicshare:$args]")])])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[e("a",{attrs:{href:"https://github.com/mamoe/mirai/blob/dev/mirai-core-api/src/commonMain/kotlin/message/data/FileMessage.kt",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("FileMessage")]),e("OutboundLink")],1)]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[e("code",[t._v("[mirai:file:$id,$internalId,$name,$size]")])])])])]),t._v(" "),e("h3",{attrs:{id:"由-mirai-码字符串取得-messagechain-实例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#由-mirai-码字符串取得-messagechain-实例"}},[t._v("#")]),t._v(" 由 mirai 码字符串取得 "),e("code",[t._v("MessageChain")]),t._v(" 实例")]),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" chain "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"[mirai:atall]"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("deserializeMiraiCode")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageChain")]),t._v(" chain "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MiraiCode")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("deserializeFromMiraiCode")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"[mirai:atall]"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("h3",{attrs:{id:"转义字符串"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#转义字符串"}},[t._v("#")]),t._v(" 转义字符串")]),t._v(" "),e("p",[t._v("若要执行转义（一般没有必要手动这么做）：")]),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("PlainText")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"[mirai:atall]"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("serializeToMiraiCode")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// \\[mirai\\:atall\\]")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MiraiCode")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("serializeToMiraiCode")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PlainText")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"[mirai:atall]"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// \\[mirai\\:atall\\]")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("h3",{attrs:{id:"serializetomiraicode-与-tostring-的区别"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#serializetomiraicode-与-tostring-的区别"}},[t._v("#")]),t._v(" "),e("code",[t._v("serializeToMiraiCode")]),t._v(" 与 "),e("code",[t._v("toString")]),t._v(" 的区别")]),t._v(" "),e("ul",[e("li",[t._v("如 "),e("a",{attrs:{href:"#%E6%B6%88%E6%81%AF%E5%85%83%E7%B4%A0"}},[t._v("消息元素")]),t._v(" 所示, "),e("code",[t._v("toString()")]),t._v(" 会尽可能包含多的信息用于调试作用，"),e("strong",[t._v("行为可能不确定")])]),t._v(" "),e("li",[e("code",[t._v("toString()")]),t._v(" 偏人类可读, "),e("code",[t._v("serializeToMiraiCode()")]),t._v(" 偏机器可读")]),t._v(" "),e("li",[e("code",[t._v("toString()")]),t._v(" "),e("strong",[t._v("没有转义")]),t._v(", "),e("code",[t._v("serializeToMiraiCode()")]),t._v(" 有正确转义")]),t._v(" "),e("li",[e("code",[t._v("serializeToMiraiCode()")]),t._v(" 会跳过 "),e("code",[t._v("不支持 mirai 码处理")]),t._v(" 的元素")]),t._v(" "),e("li",[e("code",[t._v("toString()")]),t._v(" 基本不可用于 "),e("code",[t._v("deserializeMiraiCode")]),t._v("/"),e("code",[t._v("MiraiCode.deserializeFromMiraiCode")])])]),t._v(" "),e("hr"),t._v(" "),e("p",[t._v("到这里，你已经完成了 Mirai 所有文档的阅读。现在你已经熟悉了 Mirai，并可以开始使用了。")]),t._v(" "),e("p",[t._v("你可以首先构造 Bot，登录，然后从监听事件起开始创建你的机器人，或从 Bot 获取到指定群主动发送消息。在使用中遇到问题可以参考 Mirai 源码内注释，该注释会包含更多实践上的帮助。")]),t._v(" "),e("p",[t._v("如果你仍然对 Mirai 架构有不明确的地方，欢迎在 "),e("a",{attrs:{href:"https://github.com/mamoe/mirai/discussions/848",target:"_blank",rel:"noopener noreferrer"}},[t._v("#848"),e("OutboundLink")],1),t._v(" 提出建议，或者直接在 PR 提交你的修改。")]),t._v(" "),e("blockquote",[e("p",[t._v("回到 "),e("a",{attrs:{href:"#%E7%9B%AE%E5%BD%95"}},[t._v("目录")])]),t._v(" "),e("p",[e("RouterLink",{attrs:{to:"/CoreAPI.html"}},[t._v("回到 Mirai 文档索引")])],1)])])}),[],!1,null,null,null);a.default=n.exports}}]);