<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.48">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>实现协议 | mirai</title><meta name="description" content="Mirai Project">
    <link rel="modulepreload" href="/assets/app.cc1a7d3c.js"><link rel="modulepreload" href="/assets/ImplementingProtocol.html.bb82f070.js"><link rel="modulepreload" href="/assets/ImplementingProtocol.html.8d36dd39.js"><link rel="prefetch" href="/assets/Bots.html.4e2868d9.js"><link rel="prefetch" href="/assets/ConciseAPI.html.a7d78756.js"><link rel="prefetch" href="/assets/ConfiguringProjects.html.5c8949fa.js"><link rel="prefetch" href="/assets/ConsoleTerminal.html.f3c65212.js"><link rel="prefetch" href="/assets/Contacts.html.2780bb26.js"><link rel="prefetch" href="/assets/CoreAPI.html.8e308f7a.js"><link rel="prefetch" href="/assets/DebuggingNetwork.html.0053a429.js"><link rel="prefetch" href="/assets/EventList.html.40413e00.js"><link rel="prefetch" href="/assets/Events.html.ff67a963.js"><link rel="prefetch" href="/assets/Evolution.html.7ec2ba1c.js"><link rel="prefetch" href="/assets/KotlinAndJava.html.ea914b75.js"><link rel="prefetch" href="/assets/Messages.html.97e42be7.js"><link rel="prefetch" href="/assets/MigrationFrom1x.html.832d13fd.js"><link rel="prefetch" href="/assets/Preparations.html.51671e23.js"><link rel="prefetch" href="/assets/index.html.d1fd7fad.js"><link rel="prefetch" href="/assets/UserManual.html.70063bd3.js"><link rel="prefetch" href="/assets/UsingSnapshots.html.57cabb94.js"><link rel="prefetch" href="/assets/mirai-ecology.html.37829cd0.js"><link rel="prefetch" href="/assets/Appendix.html.29bccdb2.js"><link rel="prefetch" href="/assets/BuiltInCommands.html.50cbfaf5.js"><link rel="prefetch" href="/assets/Commands.html.044a3aa8.js"><link rel="prefetch" href="/assets/ConfiguringProjects.html.2e1b8301.js"><link rel="prefetch" href="/assets/Contributing.html.d60209a9.js"><link rel="prefetch" href="/assets/Extensions.html.32ddc646.js"><link rel="prefetch" href="/assets/FrontEnd.html.c513236d.js"><link rel="prefetch" href="/assets/Logging.html.a6570352.js"><link rel="prefetch" href="/assets/Permissions.html.e321d525.js"><link rel="prefetch" href="/assets/PluginData.html.a0e22eb9.js"><link rel="prefetch" href="/assets/QA.html.6eeef55b.js"><link rel="prefetch" href="/assets/index.html.c596c4e8.js"><link rel="prefetch" href="/assets/Run.html.3b02c91d.js"><link rel="prefetch" href="/assets/BuildingCore.html.31fe91e2.js"><link rel="prefetch" href="/assets/index.html.00fc025c.js"><link rel="prefetch" href="/assets/VerifyingABI.html.a6ab27d6.js"><link rel="prefetch" href="/assets/Module.html.30cd0774.js"><link rel="prefetch" href="/assets/Plugin.html.b0e169e3.js"><link rel="prefetch" href="/assets/index.html.d7c9f215.js"><link rel="prefetch" href="/assets/index.html.3c570d43.js"><link rel="prefetch" href="/assets/index.html.b0de09ee.js"><link rel="prefetch" href="/assets/Contacts.mermaid.html.a1ebcdf8.js"><link rel="prefetch" href="/assets/Messages.mermaid.html.1ceae85b.js"><link rel="prefetch" href="/assets/JVMPlugin-Appendix.html.30503fd0.js"><link rel="prefetch" href="/assets/JVMPlugin-DataExchange.html.e3bd96d2.js"><link rel="prefetch" href="/assets/JVMPlugin-Debug.html.1373b734.js"><link rel="prefetch" href="/assets/JVMPlugin.html.00b48355.js"><link rel="prefetch" href="/assets/Plugins.html.f9e73a66.js"><link rel="prefetch" href="/assets/Adapter.html.e3609f9a.js"><link rel="prefetch" href="/assets/CustomizedAdapter.html.d79ece6c.js"><link rel="prefetch" href="/assets/HttpAdapter.html.5d1ccc04.js"><link rel="prefetch" href="/assets/ReverseWebsocketAdapter.html.fd95e5ae.js"><link rel="prefetch" href="/assets/WebhookAdapter.html.043a9c43.js"><link rel="prefetch" href="/assets/WebsocketAdapter.html.6a90e3d7.js"><link rel="prefetch" href="/assets/API.html.ea4addf9.js"><link rel="prefetch" href="/assets/EventType.html.9223bbb6.js"><link rel="prefetch" href="/assets/MessageType.html.97ab6b0a.js"><link rel="prefetch" href="/assets/Migration2.html.d51f268d.js"><link rel="prefetch" href="/assets/404.html.7d858b3d.js"><link rel="prefetch" href="/assets/Bots.html.11c88d91.js"><link rel="prefetch" href="/assets/ConciseAPI.html.fe62f0fe.js"><link rel="prefetch" href="/assets/ConfiguringProjects.html.d84e557b.js"><link rel="prefetch" href="/assets/ConsoleTerminal.html.06d921d2.js"><link rel="prefetch" href="/assets/Contacts.html.a406b007.js"><link rel="prefetch" href="/assets/CoreAPI.html.126aed9b.js"><link rel="prefetch" href="/assets/DebuggingNetwork.html.80aed9f3.js"><link rel="prefetch" href="/assets/EventList.html.f117b9c4.js"><link rel="prefetch" href="/assets/Events.html.56007ce4.js"><link rel="prefetch" href="/assets/Evolution.html.8f2acbdf.js"><link rel="prefetch" href="/assets/KotlinAndJava.html.b0b4c785.js"><link rel="prefetch" href="/assets/Messages.html.8be5109a.js"><link rel="prefetch" href="/assets/MigrationFrom1x.html.560a7d07.js"><link rel="prefetch" href="/assets/Preparations.html.2b503372.js"><link rel="prefetch" href="/assets/index.html.9024a3bf.js"><link rel="prefetch" href="/assets/UserManual.html.d103bad0.js"><link rel="prefetch" href="/assets/UsingSnapshots.html.4dc248bb.js"><link rel="prefetch" href="/assets/mirai-ecology.html.6854f336.js"><link rel="prefetch" href="/assets/Appendix.html.17e9ffb5.js"><link rel="prefetch" href="/assets/BuiltInCommands.html.0331bebe.js"><link rel="prefetch" href="/assets/Commands.html.61fb1ede.js"><link rel="prefetch" href="/assets/ConfiguringProjects.html.0914b893.js"><link rel="prefetch" href="/assets/Contributing.html.13e6f5d3.js"><link rel="prefetch" href="/assets/Extensions.html.fcc625cc.js"><link rel="prefetch" href="/assets/FrontEnd.html.5d1db4b2.js"><link rel="prefetch" href="/assets/Logging.html.c27d6b38.js"><link rel="prefetch" href="/assets/Permissions.html.1835fc6c.js"><link rel="prefetch" href="/assets/PluginData.html.476d880a.js"><link rel="prefetch" href="/assets/QA.html.a920bc26.js"><link rel="prefetch" href="/assets/index.html.3526d4e6.js"><link rel="prefetch" href="/assets/Run.html.28689408.js"><link rel="prefetch" href="/assets/BuildingCore.html.95700344.js"><link rel="prefetch" href="/assets/index.html.d0ec394e.js"><link rel="prefetch" href="/assets/VerifyingABI.html.d3a067b9.js"><link rel="prefetch" href="/assets/Module.html.02573405.js"><link rel="prefetch" href="/assets/Plugin.html.1cce13eb.js"><link rel="prefetch" href="/assets/index.html.397793e9.js"><link rel="prefetch" href="/assets/index.html.b4a9046c.js"><link rel="prefetch" href="/assets/index.html.4a91458f.js"><link rel="prefetch" href="/assets/Contacts.mermaid.html.002849fc.js"><link rel="prefetch" href="/assets/Messages.mermaid.html.2653a6d7.js"><link rel="prefetch" href="/assets/JVMPlugin-Appendix.html.4429009c.js"><link rel="prefetch" href="/assets/JVMPlugin-DataExchange.html.68052be3.js"><link rel="prefetch" href="/assets/JVMPlugin-Debug.html.3a3d1d97.js"><link rel="prefetch" href="/assets/JVMPlugin.html.d1be3df0.js"><link rel="prefetch" href="/assets/Plugins.html.5f518bb9.js"><link rel="prefetch" href="/assets/Adapter.html.116f1636.js"><link rel="prefetch" href="/assets/CustomizedAdapter.html.974898f6.js"><link rel="prefetch" href="/assets/HttpAdapter.html.e6418540.js"><link rel="prefetch" href="/assets/ReverseWebsocketAdapter.html.a366d934.js"><link rel="prefetch" href="/assets/WebhookAdapter.html.dc1cef1f.js"><link rel="prefetch" href="/assets/WebsocketAdapter.html.cc79b1b2.js"><link rel="prefetch" href="/assets/API.html.0937ed6c.js"><link rel="prefetch" href="/assets/EventType.html.bc7e45c7.js"><link rel="prefetch" href="/assets/MessageType.html.eedc2d1e.js"><link rel="prefetch" href="/assets/Migration2.html.74497d00.js"><link rel="prefetch" href="/assets/404.html.298a57f8.js"><link rel="prefetch" href="/assets/404.b602ba30.js"><link rel="prefetch" href="/assets/Layout.3ee02db6.js">
    <link rel="stylesheet" href="/assets/style.24c55b2e.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><img class="logo" src="/mirai.png" alt="mirai"><span class="site-name can-hide">mirai</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="mirai-core"><span class="title">mirai-core</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="mirai-core"><span class="title">mirai-core</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/" class="" aria-label="Index"><!--[--><!--]--> Index <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mirai-ecology.html" class="" aria-label="Mirai 生态概览"><!--[--><!--]--> Mirai 生态概览 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MigrationFrom1x.html" class="" aria-label="从 1.x 迁移"><!--[--><!--]--> 从 1.x 迁移 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/UserManual.html" class="" aria-label="用户手册"><!--[--><!--]--> 用户手册 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ConsoleTerminal.html" class="" aria-label="用户手册 - 控制台"><!--[--><!--]--> 用户手册 - 控制台 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Preparations.html" class="" aria-label="JVM 环境和开发准备工作"><!--[--><!--]--> JVM 环境和开发准备工作 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ConfiguringProjects.html" class="" aria-label="配置项目"><!--[--><!--]--> 配置项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>CoreAPI</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/CoreAPI.html" class="" aria-label="CoreAPI"><!--[--><!--]--> CoreAPI <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/Bots.html" class="" aria-label="机器人"><!--[--><!--]--> 机器人 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/Contacts.html" class="" aria-label="联系人"><!--[--><!--]--> 联系人 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/Events.html" class="" aria-label="事件"><!--[--><!--]--> 事件 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/Messages.html" class="" aria-label="消息"><!--[--><!--]--> 消息 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Misc</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/ConciseAPI.html" class="" aria-label="主要API"><!--[--><!--]--> 主要API <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/Evolution.html" class="" aria-label="Mirai - Evolution"><!--[--><!--]--> Mirai - Evolution <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/KotlinAndJava.html" class="" aria-label="Kotlin &amp; Java"><!--[--><!--]--> Kotlin &amp; Java <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/EventList.html" class="" aria-label="事件列表"><!--[--><!--]--> 事件列表 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/DebuggingNetwork.html" class="" aria-label="Debugging Network"><!--[--><!--]--> Debugging Network <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/UsingSnapshots.html" class="" aria-label="Using Dev Snapshots"><!--[--><!--]--> Using Dev Snapshots <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="mirai-console"><span class="title">mirai-console</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="mirai-console"><span class="title">mirai-console</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/console/" class="" aria-label="Index"><!--[--><!--]--> Index <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/console/ConfiguringProjects.html" class="" aria-label="配置项目"><!--[--><!--]--> 配置项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/console/Run.html" class="" aria-label="启动 Console"><!--[--><!--]--> 启动 Console <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>后端插件开发基础</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/console/plugin/Plugins.html" class="" aria-label="插件 - Plugin 模块"><!--[--><!--]--> 插件 - Plugin 模块 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/plugin/JVMPlugin.html" class="" aria-label="插件 - JVM Plugin"><!--[--><!--]--> 插件 - JVM Plugin <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/Commands.html" class="" aria-label="指令 - Command 模块"><!--[--><!--]--> 指令 - Command 模块 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/PluginData.html" class="" aria-label="存储 - PluginData 模块"><!--[--><!--]--> 存储 - PluginData 模块 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/Permissions.html" class="" aria-label="权限 - Permission 模块"><!--[--><!--]--> 权限 - Permission 模块 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>后端插件开发进阶</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/console/Extensions.html" class="" aria-label="扩展 - Extension 模块和扩展点"><!--[--><!--]--> 扩展 - Extension 模块和扩展点 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>实现前端</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/console/FrontEnd.html" class="" aria-label="FrontEnd"><!--[--><!--]--> FrontEnd <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Misc</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/console/QA.html" class="" aria-label="Q &amp; A"><!--[--><!--]--> Q &amp; A <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/Logging.html" class="" aria-label="日志配置"><!--[--><!--]--> 日志配置 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/BuiltInCommands.html" class="" aria-label="内置命令"><!--[--><!--]--> 内置命令 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/Appendix.html" class="" aria-label="Mirai Console 附录"><!--[--><!--]--> Mirai Console 附录 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/plugin/JVMPlugin-Appendix.html" class="" aria-label="插件 - JVM Plugin - 附录"><!--[--><!--]--> 插件 - JVM Plugin - 附录 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/plugin/JVMPlugin-DataExchange.html" class="" aria-label="插件 - JVM Plugin - 多插件数据交换"><!--[--><!--]--> 插件 - JVM Plugin - 多插件数据交换 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/plugin/JVMPlugin-Debug.html" class="" aria-label="插件 - JVM Plugin - 排错"><!--[--><!--]--> 插件 - JVM Plugin - 排错 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><a href="/mirai-login-solver-selenium/" class="" aria-label="mirai-login-solver-selenium"><!--[--><!--]--> mirai-login-solver-selenium <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="mirai-api-http"><span class="title">mirai-api-http</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="mirai-api-http"><span class="title">mirai-api-http</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/mirai-api-http/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mirai-api-http/api/API.html" class="" aria-label="API"><!--[--><!--]--> API <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mirai-api-http/api/EventType.html" class="" aria-label="事件类型"><!--[--><!--]--> 事件类型 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mirai-api-http/api/MessageType.html" class="" aria-label="消息类型"><!--[--><!--]--> 消息类型 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>接口适配器</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/mirai-api-http/adapter/HttpAdapter.html" class="" aria-label="http轮询"><!--[--><!--]--> http轮询 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/mirai-api-http/adapter/WebsocketAdapter.html" class="" aria-label="websocket"><!--[--><!--]--> websocket <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/mirai-api-http/adapter/ReverseWebsocketAdapter.html" class="" aria-label="反向websocket"><!--[--><!--]--> 反向websocket <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/mirai-api-http/adapter/WebhookAdapter.html" class="" aria-label="webhook上报"><!--[--><!--]--> webhook上报 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="mirai-console-loader"><span class="title">mirai-console-loader</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="mirai-console-loader"><span class="title">mirai-console-loader</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/mcl/" class="" aria-label="主页"><!--[--><!--]--> 主页 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mcl/Module.html" class="" aria-label="MCL模块"><!--[--><!--]--> MCL模块 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mcl/Plugin.html" class="" aria-label="MCL插件"><!--[--><!--]--> MCL插件 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/mamoe/mirai" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="mirai-core"><span class="title">mirai-core</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="mirai-core"><span class="title">mirai-core</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/" class="" aria-label="Index"><!--[--><!--]--> Index <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mirai-ecology.html" class="" aria-label="Mirai 生态概览"><!--[--><!--]--> Mirai 生态概览 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MigrationFrom1x.html" class="" aria-label="从 1.x 迁移"><!--[--><!--]--> 从 1.x 迁移 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/UserManual.html" class="" aria-label="用户手册"><!--[--><!--]--> 用户手册 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ConsoleTerminal.html" class="" aria-label="用户手册 - 控制台"><!--[--><!--]--> 用户手册 - 控制台 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/Preparations.html" class="" aria-label="JVM 环境和开发准备工作"><!--[--><!--]--> JVM 环境和开发准备工作 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ConfiguringProjects.html" class="" aria-label="配置项目"><!--[--><!--]--> 配置项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>CoreAPI</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/CoreAPI.html" class="" aria-label="CoreAPI"><!--[--><!--]--> CoreAPI <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/Bots.html" class="" aria-label="机器人"><!--[--><!--]--> 机器人 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/Contacts.html" class="" aria-label="联系人"><!--[--><!--]--> 联系人 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/Events.html" class="" aria-label="事件"><!--[--><!--]--> 事件 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/Messages.html" class="" aria-label="消息"><!--[--><!--]--> 消息 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Misc</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/ConciseAPI.html" class="" aria-label="主要API"><!--[--><!--]--> 主要API <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/Evolution.html" class="" aria-label="Mirai - Evolution"><!--[--><!--]--> Mirai - Evolution <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/KotlinAndJava.html" class="" aria-label="Kotlin &amp; Java"><!--[--><!--]--> Kotlin &amp; Java <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/EventList.html" class="" aria-label="事件列表"><!--[--><!--]--> 事件列表 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/DebuggingNetwork.html" class="" aria-label="Debugging Network"><!--[--><!--]--> Debugging Network <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/UsingSnapshots.html" class="" aria-label="Using Dev Snapshots"><!--[--><!--]--> Using Dev Snapshots <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="mirai-console"><span class="title">mirai-console</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="mirai-console"><span class="title">mirai-console</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/console/" class="" aria-label="Index"><!--[--><!--]--> Index <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/console/ConfiguringProjects.html" class="" aria-label="配置项目"><!--[--><!--]--> 配置项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/console/Run.html" class="" aria-label="启动 Console"><!--[--><!--]--> 启动 Console <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>后端插件开发基础</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/console/plugin/Plugins.html" class="" aria-label="插件 - Plugin 模块"><!--[--><!--]--> 插件 - Plugin 模块 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/plugin/JVMPlugin.html" class="" aria-label="插件 - JVM Plugin"><!--[--><!--]--> 插件 - JVM Plugin <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/Commands.html" class="" aria-label="指令 - Command 模块"><!--[--><!--]--> 指令 - Command 模块 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/PluginData.html" class="" aria-label="存储 - PluginData 模块"><!--[--><!--]--> 存储 - PluginData 模块 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/Permissions.html" class="" aria-label="权限 - Permission 模块"><!--[--><!--]--> 权限 - Permission 模块 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>后端插件开发进阶</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/console/Extensions.html" class="" aria-label="扩展 - Extension 模块和扩展点"><!--[--><!--]--> 扩展 - Extension 模块和扩展点 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>实现前端</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/console/FrontEnd.html" class="" aria-label="FrontEnd"><!--[--><!--]--> FrontEnd <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Misc</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/console/QA.html" class="" aria-label="Q &amp; A"><!--[--><!--]--> Q &amp; A <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/Logging.html" class="" aria-label="日志配置"><!--[--><!--]--> 日志配置 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/BuiltInCommands.html" class="" aria-label="内置命令"><!--[--><!--]--> 内置命令 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/Appendix.html" class="" aria-label="Mirai Console 附录"><!--[--><!--]--> Mirai Console 附录 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/plugin/JVMPlugin-Appendix.html" class="" aria-label="插件 - JVM Plugin - 附录"><!--[--><!--]--> 插件 - JVM Plugin - 附录 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/plugin/JVMPlugin-DataExchange.html" class="" aria-label="插件 - JVM Plugin - 多插件数据交换"><!--[--><!--]--> 插件 - JVM Plugin - 多插件数据交换 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/console/plugin/JVMPlugin-Debug.html" class="" aria-label="插件 - JVM Plugin - 排错"><!--[--><!--]--> 插件 - JVM Plugin - 排错 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><a href="/mirai-login-solver-selenium/" class="" aria-label="mirai-login-solver-selenium"><!--[--><!--]--> mirai-login-solver-selenium <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="mirai-api-http"><span class="title">mirai-api-http</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="mirai-api-http"><span class="title">mirai-api-http</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/mirai-api-http/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mirai-api-http/api/API.html" class="" aria-label="API"><!--[--><!--]--> API <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mirai-api-http/api/EventType.html" class="" aria-label="事件类型"><!--[--><!--]--> 事件类型 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mirai-api-http/api/MessageType.html" class="" aria-label="消息类型"><!--[--><!--]--> 消息类型 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>接口适配器</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/mirai-api-http/adapter/HttpAdapter.html" class="" aria-label="http轮询"><!--[--><!--]--> http轮询 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/mirai-api-http/adapter/WebsocketAdapter.html" class="" aria-label="websocket"><!--[--><!--]--> websocket <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/mirai-api-http/adapter/ReverseWebsocketAdapter.html" class="" aria-label="反向websocket"><!--[--><!--]--> 反向websocket <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/mirai-api-http/adapter/WebhookAdapter.html" class="" aria-label="webhook上报"><!--[--><!--]--> webhook上报 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="mirai-console-loader"><span class="title">mirai-console-loader</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="mirai-console-loader"><span class="title">mirai-console-loader</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/mcl/" class="" aria-label="主页"><!--[--><!--]--> 主页 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mcl/Module.html" class="" aria-label="MCL模块"><!--[--><!--]--> MCL模块 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/mcl/Plugin.html" class="" aria-label="MCL插件"><!--[--><!--]--> MCL插件 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/mamoe/mirai" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">实现协议 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/contributing/ImplementingProtocol.html#添加一个消息类型" class="router-link-active router-link-exact-active sidebar-item" aria-label="添加一个消息类型"><!--[--><!--]--> 添加一个消息类型 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/contributing/ImplementingProtocol.html#_1-抽象接口" class="router-link-active router-link-exact-active sidebar-item" aria-label="1. 抽象接口"><!--[--><!--]--> 1. 抽象接口 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/contributing/ImplementingProtocol.html#_2-提供工厂或构建器" class="router-link-active router-link-exact-active sidebar-item" aria-label="2. 提供工厂或构建器"><!--[--><!--]--> 2. 提供工厂或构建器 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/contributing/ImplementingProtocol.html#_3-实现接口" class="router-link-active router-link-exact-active sidebar-item" aria-label="3. 实现接口"><!--[--><!--]--> 3. 实现接口 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/contributing/ImplementingProtocol.html#_4-实现工厂" class="router-link-active router-link-exact-active sidebar-item" aria-label="4. 实现工厂"><!--[--><!--]--> 4. 实现工厂 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/contributing/ImplementingProtocol.html#_5-测试接口和实现" class="router-link-active router-link-exact-active sidebar-item" aria-label="5. 测试接口和实现"><!--[--><!--]--> 5. 测试接口和实现 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/contributing/ImplementingProtocol.html#_6-实现收发协议" class="router-link-active router-link-exact-active sidebar-item" aria-label="6. 实现收发协议"><!--[--><!--]--> 6. 实现收发协议 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/contributing/ImplementingProtocol.html#_7-添加收发消息测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="7. 添加收发消息测试"><!--[--><!--]--> 7. 添加收发消息测试 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/contributing/ImplementingProtocol.html#_8-实现序列化" class="router-link-active router-link-exact-active sidebar-item" aria-label="8. 实现序列化"><!--[--><!--]--> 8. 实现序列化 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/contributing/ImplementingProtocol.html#_9-添加序列化测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="9. 添加序列化测试"><!--[--><!--]--> 9. 添加序列化测试 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/contributing/ImplementingProtocol.html#_10-提交-pr" class="router-link-active router-link-exact-active sidebar-item" aria-label="10. 提交 PR"><!--[--><!--]--> 10. 提交 PR <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="实现协议" tabindex="-1"><a class="header-anchor" href="#实现协议" aria-hidden="true">#</a> 实现协议</h1><p>本文将说明实现一些协议的通常步骤，并以示例逐步演示。本文还将介绍 mirai 的消息处理流程。</p><p>通常请于 <code>commonMain</code> 编写代码。<code>commonMain</code> 的 Kotlin 代码将可以用于全平台，即同时（自动）支持 JVM 和 Native 目标。</p><h2 id="添加一个消息类型" tabindex="-1"><a class="header-anchor" href="#添加一个消息类型" aria-hidden="true">#</a> 添加一个消息类型</h2><h3 id="_1-抽象接口" tabindex="-1"><a class="header-anchor" href="#_1-抽象接口" aria-hidden="true">#</a> 1. 抽象接口</h3><p>在 <code>mirai-core-api</code> 的 <code>message.data</code> 中添加新类型接口（消息元素），如 <code>Audio</code> ，<code>FileMessage</code>。</p><p>在设计消息元素时应使其继承 <code>MessageMetadata</code>（元数据） 或 <code>MessageContent</code> （内容）。若该消息在官方客户端中只能单独出现，那么还应该让它继承 <code>ConstrainSingle</code> 来维持这一性质。</p><p>消息元素应是不可变的，即不允许出现 <code>var</code> 或可变类型。</p><p>作为示例，假设现在要支持视频消息，在 <code>mirai-core-api</code> 定义接口 <code>Video</code>：</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> Video <span class="token operator">:</span> MessageContent<span class="token punctuation">,</span> ConstrainSingle <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> key<span class="token operator">:</span> Key <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> Key

    <span class="token keyword">public</span> <span class="token keyword">companion</span> <span class="token keyword">object</span> Key <span class="token operator">:</span>
        AbstractPolymorphicMessageKey<span class="token operator">&lt;</span>MessageContent<span class="token punctuation">,</span> Video<span class="token operator">&gt;</span><span class="token punctuation">(</span>
            MessageContent<span class="token punctuation">,</span>
            <span class="token punctuation">{</span> it<span class="token punctuation">.</span><span class="token function">safeCast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * 文件名
     */</span>
    <span class="token keyword">val</span> filename<span class="token operator">:</span> String

    <span class="token comment">/**
     * 长度, 单位为秒.
     */</span>
    <span class="token keyword">val</span> length<span class="token operator">:</span> Long
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于视频不可与文字等其他消息内容元素同时出现，<code>Video</code> 需要实现 <code>ConstrainSingle</code> ，并提供 <code>companion object Key</code>。</p><p>为了实现最好的协议支持，我们将 <code>Video</code> 分为 <code>OnlineVideo</code> 和 <code>OfflineVideo</code>。<code>OnlineVideo</code> 表示从服务器接收的，而 <code>OfflineVideo</code> 本地构造的。之后在实现时 <code>OnlineVideo</code> 可以存储来自服务器的原数据，以实现快速转发等优化。</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">interface</span> Video <span class="token operator">:</span> MessageContent<span class="token punctuation">,</span> ConstrainSingle <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> key<span class="token operator">:</span> Key <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> Key

    <span class="token keyword">public</span> <span class="token keyword">companion</span> <span class="token keyword">object</span> Key <span class="token operator">:</span>
        AbstractPolymorphicMessageKey<span class="token operator">&lt;</span>MessageContent<span class="token punctuation">,</span> Video<span class="token operator">&gt;</span><span class="token punctuation">(</span>
            MessageContent<span class="token punctuation">,</span>
            <span class="token punctuation">{</span> it<span class="token punctuation">.</span><span class="token function">safeCast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * 文件名
     */</span>
    <span class="token keyword">val</span> filename<span class="token operator">:</span> String

    <span class="token comment">/**
     * 长度, 单位为秒.
     */</span>
    <span class="token keyword">val</span> length<span class="token operator">:</span> Long
<span class="token punctuation">}</span>

<span class="token annotation builtin">@NotStableForInheritance</span> <span class="token comment">// 表示此 API 不可由用户自行实现</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> OnlineVideo <span class="token operator">:</span> Video <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> key<span class="token operator">:</span> Key <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> Key

    <span class="token comment">/**
     * 获取下载链接 URL
     */</span>
    <span class="token keyword">val</span> urlForDownload<span class="token operator">:</span> String

    <span class="token comment">// 需要覆盖 Key</span>
    <span class="token keyword">public</span> <span class="token keyword">companion</span> <span class="token keyword">object</span> Key <span class="token operator">:</span>
        AbstractPolymorphicMessageKey<span class="token operator">&lt;</span>Video<span class="token punctuation">,</span> OnlineVideo<span class="token operator">&gt;</span><span class="token punctuation">(</span>
            Video<span class="token punctuation">,</span> <span class="token punctuation">{</span> it<span class="token punctuation">.</span><span class="token function">safeCast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// SERIAL_NAME为之后支持序列化做准备</span>
        <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token keyword">val</span> SERIAL_NAME<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">&quot;OnlineVideo&quot;</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation builtin">@NotStableForInheritance</span> <span class="token comment">// 表示此 API 不可由用户自行实现</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> OfflineVideo <span class="token operator">:</span> Video <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> key<span class="token operator">:</span> Key <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> Key

    <span class="token comment">// 需要覆盖 Key</span>
    <span class="token keyword">public</span> <span class="token keyword">companion</span> <span class="token keyword">object</span> Key <span class="token operator">:</span>
        AbstractPolymorphicMessageKey<span class="token operator">&lt;</span>Video<span class="token punctuation">,</span> OfflineVideo<span class="token operator">&gt;</span><span class="token punctuation">(</span>
            Video<span class="token punctuation">,</span> <span class="token punctuation">{</span> it<span class="token punctuation">.</span><span class="token function">safeCast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// SERIAL_NAME为之后支持序列化做准备</span>
        <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token keyword">val</span> SERIAL_NAME<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">&quot;OfflineVideo&quot;</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样设计接口的好处包括未来很容易修改。例如 mirai 2.0 设计的 <code>Image</code> 接口一直维护到现在（2.13）也没有遇到问题，其内部结构也变更了多次，但用户的使用方法没有改变。</p><h3 id="_2-提供工厂或构建器" tabindex="-1"><a class="header-anchor" href="#_2-提供工厂或构建器" aria-hidden="true">#</a> 2. 提供工厂或构建器</h3><p>考虑添加相应的 <code>Factory</code>（抽象工厂）或 <code>Builder</code>（生成器）来提供构造消息实例的方式，而避免直接提供构造器。 直接提供公开构造器是一种沉重的承诺，将增加维护难度（现在已有的部分公开构造器是历史遗留）。</p><p>在 <code>Video</code> 示例中，由于 <code>OnlineVideo</code> 是来自服务器的，我们无序提供构造方式。可为 <code>OfflineVideo</code> 增加构建工厂：</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token comment">// ...</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> OfflineVideo <span class="token operator">:</span> Video <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">public</span> <span class="token keyword">interface</span> Factory <span class="token punctuation">{</span>
        <span class="token comment">/** 构建一个 [OfflineVideo] 实例 */</span>
        <span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token function">create</span><span class="token punctuation">(</span>filename<span class="token operator">:</span> String<span class="token punctuation">,</span> length<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> OfflineVideo

        <span class="token keyword">companion</span> <span class="token keyword">object</span> INSTANCE <span class="token operator">:</span> Factory <span class="token keyword">by</span> <span class="token function">loadService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// `loadService` 是 mirai 实现的全平台服务加载方式，类似于 JDK `ServiceLoader`。</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用户在 Kotlin 可通过 <code>OfflineVideo.Factory.create(filename, length)</code>，或在 Java 通过 <code>OfflineVideo.Factory.INSTANCE.create(filename, length)</code> 取得 <code>OfflineVideo</code> 实例。</p><p>注意，示例中 <code>OnlineVideo</code> 用的属性并不多（只有两个），使用工厂会比使用生成器（<code>Builder</code>）方便。但对于 <code>Image</code> 等拥有众多属性的类型，建议提供 <code>Builder</code>。一种实现方式可参见 <code>Image.Builder</code>。</p><h3 id="_3-实现接口" tabindex="-1"><a class="header-anchor" href="#_3-实现接口" aria-hidden="true">#</a> 3. 实现接口</h3><p>接口和工厂准备就绪，现在在 <code>mirai-core</code> 的 <code>net.mamoe.mirai.internal.message.data.</code> 包下实现接口。</p><p>请一般使用 <code>...Impl</code> 的命名方式，并为抽象类（<code>abstract class</code>）增加 <code>Abstract</code> 前缀。 如本示例中我们将实现：</p><ul><li><code>abstract class AbstractVideo : Video</code> — 实现基本的 <code>Video</code> 类</li><li><code>class OnlineVideoImpl : OnlineVideo</code> — 实现 <code>OnlineVideo</code> 的特殊内容</li><li><code>class OfflineVideoImpl : OfflineVideo</code> — 实现 <code>OfflineVideo</code> 的特殊内容</li></ul><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token function">AbstractVideo</span><span class="token punctuation">(</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> filename<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> length<span class="token operator">:</span> Long<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> Video <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> toStringTemp <span class="token keyword">by</span> lazy <span class="token punctuation">{</span> <span class="token string-literal singleline"><span class="token string">&quot;[mirai:video:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">filename</span></span><span class="token string">, length=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">length</span></span><span class="token string">]&quot;</span></span> <span class="token punctuation">}</span> <span class="token comment">// 这不是标准 mirai code，只是为了提供易读的表示方式</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span> toStringTemp

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">contentToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">&quot;[视频]&quot;</span></span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">equals</span><span class="token punctuation">(</span>other<span class="token operator">:</span> Any<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>other <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token comment">// isSameType 是适用于全平台的类型判断方式</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSameType</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filename <span class="token operator">!=</span> other<span class="token punctuation">.</span>filename<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">!=</span> other<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">{</span>
        <span class="token keyword">var</span> result <span class="token operator">=</span> filename<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        result <span class="token operator">=</span> <span class="token number">31</span> <span class="token operator">*</span> result <span class="token operator">+</span> length<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> result
    <span class="token punctuation">}</span>

    <span class="token keyword">abstract</span> <span class="token keyword">fun</span> <span class="token function">toVideoFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ImMsgBody<span class="token punctuation">.</span>VideoFile
<span class="token punctuation">}</span>

<span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token function">OnlineVideoImpl</span><span class="token punctuation">(</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> filename<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> length<span class="token operator">:</span> Long<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> original<span class="token operator">:</span> ImMsgBody<span class="token punctuation">.</span>VideoFile<span class="token operator">?</span> <span class="token comment">// 协议数据结构</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> OnlineVideo<span class="token punctuation">,</span> <span class="token function">AbstractVideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">toVideoFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ImMsgBody<span class="token punctuation">.</span>VideoFile <span class="token operator">=</span> original
<span class="token punctuation">}</span>

<span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token function">OfflineVideoImpl</span><span class="token punctuation">(</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> filename<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> length<span class="token operator">:</span> Long<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> OfflineVideo<span class="token punctuation">,</span> <span class="token function">AbstractVideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">toVideoFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ImMsgBody<span class="token punctuation">.</span>VideoFile <span class="token operator">=</span> <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-实现工厂" tabindex="-1"><a class="header-anchor" href="#_4-实现工厂" aria-hidden="true">#</a> 4. 实现工厂</h3><p>因为 mirai 在 JVM 使用 <code>ServiceLoader</code>，需要定义工厂实现类为 <code>class</code> 而不是 <code>object</code>。</p><p>对于 <code>Video</code> 示例：</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">internal</span> <span class="token keyword">class</span> OfflineVideoFactoryImpl <span class="token operator">:</span> OfflineVideo<span class="token punctuation">.</span><span class="token function">Factory</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">create</span><span class="token punctuation">(</span>filename<span class="token operator">:</span> String<span class="token punctuation">,</span> length<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> OfflineVideo <span class="token operator">=</span>
        <span class="token function">OfflineVideoImpl</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> length<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现后需要同时为 JVM 和 Native 注册工厂：</p><ul><li><p>JVM：在 jvmBaseMain/resources/META-INF/services/ 新建一个文件名为 <code>net.mamoe.mirai.message.data.OfflineVideo$Factory</code> ，文件内容为 <code>net.mamoe.mirai.internal.message.data.OfflineVideoFactoryImpl</code> ；</p></li><li><p>Native： 在 <code>net.mamoe.mirai.internal.utils.MiraiCoreServices.registerAll</code> 末尾增加。如对于 <code>Video</code> 示例：</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code>Services<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>
    <span class="token string-literal singleline"><span class="token string">&quot;net.mamoe.mirai.message.data.OfflineVideo.Factory&quot;</span></span><span class="token punctuation">,</span>
    <span class="token string-literal singleline"><span class="token string">&quot;net.mamoe.mirai.internal.message.data.OfflineVideoFactoryImpl&quot;</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span> net<span class="token punctuation">.</span>mamoe<span class="token punctuation">.</span>mirai<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>message<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">OfflineVideoFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="_5-测试接口和实现" tabindex="-1"><a class="header-anchor" href="#_5-测试接口和实现" aria-hidden="true">#</a> 5. 测试接口和实现</h3><p>请在 <code>commonTest/kotlin/message/data</code> 添加新增消息类型的测试。 需要测试的内容可能包含：</p><ul><li><code>equals</code>、<code>hashCode</code></li><li><code>toString</code>、<code>contentToString</code></li><li>检验参数有效性</li></ul><p>语音消息的测试 <code>net.mamoe.mirai.internal.message.data.AudioTest</code> 可供参考。</p><h3 id="_6-实现收发协议" tabindex="-1"><a class="header-anchor" href="#_6-实现收发协议" aria-hidden="true">#</a> 6. 实现收发协议</h3><h4 id="多流水线系统" tabindex="-1"><a class="header-anchor" href="#多流水线系统" aria-hidden="true">#</a> 多流水线系统</h4><p>mirai 的多套系统都使用了&quot;流水线&quot;（pipeline）设计模式。</p><p>服务器消息实际上是数种通知中的一种（mirai 称之为 <code>notice</code>）。 加密的通知经过<em>网络层</em>解密处理后成为二进制数据包 <code>IncomingPacket</code>，网络层会分类该 <code>IncomingPacket</code>给合适的* 数据包工厂*（<code>PacketFactory</code>）处理。 数据包工厂会解析二进制数据包，产生结构数据类型。 结构数据类型将被发送至<em>通知流水线</em>（<code>NoticeProcessorPipeline</code>），经由负责的<em>流水线处理员</em> （<code>NoticeProcessor</code>）处理后最终成为一个 mirai 事件。而负责处理消息事件的处理员会将消息原数据发送至消息流水线处理得到 <code>MessageChain</code>。</p><h4 id="群消息处理流程" tabindex="-1"><a class="header-anchor" href="#群消息处理流程" aria-hidden="true">#</a> 群消息处理流程</h4><p>一条群消息的完整处理流程如下图所示：</p><p><a href="https://mermaid-js.github.io/mermaid-live-editor/edit#pako:eNpVkctKw0AUQH9lmFWEth8QqNCmqbgoFnSZzZjcJoPJTEkmgjQFK_hYaNGFIiK6kOLOVvABivg1mehfOElTxdUdzj1zuY8BtrkDWMduSPoe2mhZDKGGlk4P5MWhPJ_Jk4f0eH8pp03NwqvM5gFlbpfYWyA0eTn-r-HCNJTZidw15lMG3Tjyat3NPCimMS6oDQuzpcyVkMf9DkQRccHcBibKnDmvYvAgqKlY0nZO57LhEcpK3EDV6nKSfZxl79fp497X_Z0aIUHNovEi99tl-jpJx7khb04TZBQNF8b37lV2O5HPIzl7yt4-E7NeV99ejuRo-gfbykRqS7iCAwgDQh21vEFexMLCgwAsrKunAz0S-2oUiw2VGvcdIsB0qOAh1nvEj6CCSSz4-g6zsS7CGBZSixJ1i6C0hj_Pm6rs" target="_blank" rel="noopener noreferrer"><img src="https://mermaid.ink/img/pako:eNpVkctKw0AUQH9lmFWEth8QqNCmqbgoFnSZzZjcJoPJTEkmgjQFK_hYaNGFIiK6kOLOVvABivg1mehfOElTxdUdzj1zuY8BtrkDWMduSPoe2mhZDKGGlk4P5MWhPJ_Jk4f0eH8pp03NwqvM5gFlbpfYWyA0eTn-r-HCNJTZidw15lMG3Tjyat3NPCimMS6oDQuzpcyVkMf9DkQRccHcBibKnDmvYvAgqKlY0nZO57LhEcpK3EDV6nKSfZxl79fp497X_Z0aIUHNovEi99tl-jpJx7khb04TZBQNF8b37lV2O5HPIzl7yt4-E7NeV99ejuRo-gfbykRqS7iCAwgDQh21vEFexMLCgwAsrKunAz0S-2oUiw2VGvcdIsB0qOAh1nvEj6CCSSz4-g6zsS7CGBZSixJ1i6C0hj_Pm6rs" alt=""><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h4 id="消息流水线" tabindex="-1"><a class="header-anchor" href="#消息流水线" aria-hidden="true">#</a> 消息流水线</h4><p><strong>要增加新的消息类型支持，我们需要扩展 <em>消息流水线</em>（<code>MessagePipeline</code>）</strong>。</p><p>事实上为了支持复杂的富文本消息以及多样的消息类型，消息流水线也分有多个子部门。</p><ul><li><code>MessageEncoderPipeline</code>：包含一系列消息编码器（<code>MessageEncoder</code>），将 mirai-core-api 的结构编码为协议数据；</li><li><code>MessageDecoderPipeline</code>：包含一系列消息解码器（<code>MessageDecoder</code>），将协议数据解码为 mirai-core-api 的结构；</li><li><code>OutgoingMessagePipeline</code>：包含一系列消息预处理器（<code>OutgoingMessagePreprocessor</code> ）、转换器（<code>OutgoingMessageTransformer</code>）、发送器（<code>OutgoingMessageSender</code> ）和后处理器（<code>OutgoingMessagePostprocessor</code> ）。预处理器可校验消息长度等、转换器可根据情况把普通消息转为长消息或分片消息、发送器则处理非常规类型的消息（如音乐分享）。</li></ul><p>通常来说，一个协议上就是&quot;消息&quot;的消息元素，如 mirai <code>PlainText</code> 和 <code>At</code> 对应协议 <code>Elem.Text</code> 、mirai <code>Face</code> 对应协议 <code>Elem.Face</code>。要支持这样的消息元素，只需要增加一个 <code>MessageEncoder</code> 用于编码和一个 <code>MessageDecoder</code> 用于解码即可。</p><p>而对于协议上有独立通道，而 mirai 为了易用性将他们设计为消息的消息元素，需要实现 <code>MessageSender</code> 并以高于一般消息发送器 <code>GeneralMessageSender</code> 的优先级注册。 如（<code>MusicShare</code> ）实际上通过独立的音乐分享通道发送；又如文件消息（<code>FileMessage</code>）需要通过 <code>FileManagement.Feed</code> 通道发送。</p><h4 id="messageprotocol" tabindex="-1"><a class="header-anchor" href="#messageprotocol" aria-hidden="true">#</a> <code>MessageProtocol</code></h4><p>无论是协议上就是消息的消息元素，还是协议上有独立通道的消息元素，它们的实现的方式都是类似的 —— 通过 <code>MessageProtocol.collectProcessors</code>。 <code>MessageProtocol</code> 是对<em>协议实现</em>的抽象。一个 <code>MessageProtocol</code> 包含了它负责的消息类型的所有处理器。</p><p>继续使用 <code>Video</code> 示例，我们假设 <code>Video</code> 功能在协议上就是&quot;消息&quot;，因此只需要增加 <code>MessageEncoder</code> 与 <code>MessageDecoder</code>：</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">package</span> net<span class="token punctuation">.</span>mamoe<span class="token punctuation">.</span>mirai<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>message<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span>impl

<span class="token keyword">internal</span> <span class="token keyword">class</span> VideoProtocol <span class="token operator">:</span> <span class="token function">MessageProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> ProcessorCollector<span class="token punctuation">.</span><span class="token function">collectProcessorsImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">add</span><span class="token punctuation">(</span><span class="token function">Encoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 添加 Encoder 到消息流水线</span>
        <span class="token function">add</span><span class="token punctuation">(</span><span class="token function">Decoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> Encoder <span class="token operator">:</span> MessageEncoder<span class="token operator">&lt;</span>Video<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">override</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> MessageEncoderContext<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token operator">:</span> Video<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">markAsConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 表示本 `MessageEncoder` 将会完成对输入的 `Video` 的全部处理</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">data</span> <span class="token keyword">is</span> AbstractVideo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// `collect` 收集一个协议结构</span>
                <span class="token function">collect</span><span class="token punctuation">(</span>ImMsgBody<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span>videoFile <span class="token operator">=</span> <span class="token keyword">data</span><span class="token punctuation">.</span><span class="token function">toVideoFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> Decoder <span class="token operator">:</span> MessageDecoder <span class="token punctuation">{</span>
        <span class="token keyword">override</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> MessageDecoderContext<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token operator">:</span> ImMsgBody<span class="token punctuation">.</span>Elem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">.</span>videoFile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
            <span class="token function">markAsConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 表示本 `MessageDecoder` 将完成对输入的 `ImMsgBody.Elem` 的全部处理</span>

            <span class="token function">collect</span><span class="token punctuation">(</span>
                <span class="token function">OnlineVideoImpl</span><span class="token punctuation">(</span>
                    <span class="token keyword">data</span><span class="token punctuation">.</span>videoFile<span class="token punctuation">.</span>fileName<span class="token punctuation">,</span>
                    <span class="token keyword">data</span><span class="token punctuation">.</span>videoFile<span class="token punctuation">.</span>fileTime<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">data</span><span class="token punctuation">.</span>videoFile
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>假如 <code>Video</code> 功能在协议上不是&quot;消息&quot;，就需要实现 <code>MessageSender</code>。<code>MessageSender</code> 将直接涉及发送合适的数据包，可参考 <code>net.mamoe.mirai.internal.message.protocol.impl.MusicShareProtocol.Sender</code> 实现。</p><p>最后需要注册 <code>VideoProtocol</code>，这与之前注册 <code>Factory</code> 的方式一样，只是需要基于 <code>net.mamoe.mirai.internal.message.protocol.MessageProtocol</code> ：</p><ul><li><p>JVM：在 jvmBaseMain/resources/META-INF/services/ 新建一个文件名为 <code>net.mamoe.mirai.internal.message.protocol.MessageProtocol</code> ，文件内容为 <code>net.mamoe.mirai.internal.message.protocol.impl.VideoProtocol</code></p></li><li><p>Native： 在 <code>net.mamoe.mirai.internal.utils.MiraiCoreServices.registerAll</code> 末尾增加：</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code>Services<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>
    <span class="token string-literal singleline"><span class="token string">&quot;net.mamoe.mirai.internal.message.protocol.MessageProtocol&quot;</span></span><span class="token punctuation">,</span>
    <span class="token string-literal singleline"><span class="token string">&quot;net.mamoe.mirai.internal.message.protocol.impl.VideoProtocol&quot;</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span> net<span class="token punctuation">.</span>mamoe<span class="token punctuation">.</span>mirai<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>message<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span>impl<span class="token punctuation">.</span><span class="token function">VideoProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="_7-添加收发消息测试" tabindex="-1"><a class="header-anchor" href="#_7-添加收发消息测试" aria-hidden="true">#</a> 7. 添加收发消息测试</h3><p>mirai 拥有对消息流水线的测试框架，位于 <code>commonTest/kotlin/message/protocol/impl/AbstractMessageProtocolTest</code> 。</p><p>请为你的 <code>...Protocol</code> 在 <code>commonTest/kotlin/message/protocol/impl</code> 增加一个 <code>...ProtocolTest</code>。可以参考 <code>TextProtocolTest</code> （协议上的消息）和 <code>MusicShareProtocolTest</code>（独立通道）。</p><p>在单元测试通过之后，也请登录测试账号在本地环境进行收发消息测试。 提示：要运行 <code>main</code> 函数，可在 <code>jvmTest/kotlin/local</code> 中编写。该目录已被忽略 Git 跟踪。</p><h3 id="_8-实现序列化" tabindex="-1"><a class="header-anchor" href="#_8-实现序列化" aria-hidden="true">#</a> 8. 实现序列化</h3><p>mirai 使用 <a href="https://github.com/Kotlin/kotlinx.serialization" target="_blank" rel="noopener noreferrer">kotlinx.serialization<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 。 mirai 提供 <code>MessageSerializers</code> 来支持消息元素的多态序列化。</p><p>序列化器（<code>KSerializer</code>）在 <code>MessageProtocol</code> 中收集。</p><p>对于 <code>Video</code> 示例，我们首先为 <code>OnlineVideoImpl</code> 和 <code>OfflineVideoImpl</code> 实现序列化。</p><p><code>OfflineVideoImpl</code> 的序列化很简单，只需要添加两个注解：</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@SerialName</span><span class="token punctuation">(</span>OfflineVideo<span class="token punctuation">.</span>SERIAL_NAME<span class="token punctuation">)</span>
<span class="token annotation builtin">@Serializable</span> <span class="token comment">// 编译器将会自动生成序列化器</span>
<span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token function">OfflineVideoImpl</span><span class="token punctuation">(</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> filename<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> length<span class="token operator">:</span> Long<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> OfflineVideo<span class="token punctuation">,</span> <span class="token function">AbstractVideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">internal</span> <span class="token keyword">class</span> VideoProtocol <span class="token operator">:</span> <span class="token function">MessageProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> ProcessorCollector<span class="token punctuation">.</span><span class="token function">collectProcessorsImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>

        <span class="token comment">// `superclassesScope` 的参数为 `OfflineVideo` 的父类。</span>
        <span class="token comment">// 这么做是因为反射在 Native 平台不可用。</span>
        MessageSerializer<span class="token punctuation">.</span><span class="token function">superclassesScope</span><span class="token punctuation">(</span>
            MessageContent<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span>
            SingleMessage<span class="token operator">::</span><span class="token keyword">class</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">add</span><span class="token punctuation">(</span>
                <span class="token function">MessageSerializer</span><span class="token punctuation">(</span>
                    OfflineVideoImpl<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                    OfflineVideoImpl<span class="token punctuation">.</span><span class="token function">serializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span> <span class="token comment">// 绑定序列化器</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于 <code>OnlineVideoImpl</code> 拥有 <code>ImMsgBody.VideoFile?</code> 属性，</p><div class="language-kotlin ext-kt line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@SerialName</span><span class="token punctuation">(</span>OnlineVideo<span class="token punctuation">.</span>SERIAL_NAME<span class="token punctuation">)</span>
<span class="token annotation builtin">@Serializable</span> <span class="token comment">// 编译器将会自动生成序列化器</span>
<span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token function">OnlineVideoImpl</span><span class="token punctuation">(</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> filename<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> length<span class="token operator">:</span> Long<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> original<span class="token operator">:</span> <span class="token annotation builtin">@Serializable</span><span class="token punctuation">(</span>VideoFileAsByteArraySerializer<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span> ImMsgBody<span class="token punctuation">.</span>VideoFile<span class="token operator">?</span> <span class="token comment">// 协议数据结构</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> OnlineVideo<span class="token punctuation">,</span> <span class="token function">AbstractVideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">toVideoFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ImMsgBody<span class="token punctuation">.</span>VideoFile <span class="token operator">=</span> original
<span class="token punctuation">}</span>

<span class="token comment">// 将 `VideoFile` 作为十六进制字符串序列化，这样输出的 JSON 字符串更易读。</span>
<span class="token keyword">internal</span> <span class="token keyword">object</span> VideoFileAsHexSerializer <span class="token operator">:</span>
    KSerializer<span class="token operator">&lt;</span>ImMsgBody<span class="token punctuation">.</span>VideoFile<span class="token operator">&gt;</span> <span class="token keyword">by</span> String<span class="token punctuation">.</span><span class="token function">serializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> <span class="token comment">// 使用 String.serializer() 作为代理序列化器</span>
            resultantDescriptor <span class="token operator">=</span> ImMsgBody<span class="token punctuation">.</span>VideoFile<span class="token punctuation">.</span><span class="token function">serializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>descriptor<span class="token punctuation">,</span>
            deserialize <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">// 反序列化：即字符串到 ImMsgBody.VideoFile</span>
                it<span class="token punctuation">.</span><span class="token function">hexToBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 转换为字符串</span>
                    <span class="token punctuation">.</span><span class="token function">loadAs</span><span class="token punctuation">(</span>ImMsgBody<span class="token punctuation">.</span>VideoFile<span class="token punctuation">.</span><span class="token function">serializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 解析 ByteArray 到结构</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            serialize <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">// 序列化：即 ImMsgBody.VideoFile 到字符串</span>
                it<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span>ImMsgBody<span class="token punctuation">.</span>VideoFile<span class="token punctuation">.</span><span class="token function">serializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 导出结构数据为 ByteArray</span>
                    <span class="token punctuation">.</span><span class="token function">toUHexString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 转换为十六进制字符串表示</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>

<span class="token keyword">internal</span> <span class="token keyword">class</span> VideoProtocol <span class="token operator">:</span> <span class="token function">MessageProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> ProcessorCollector<span class="token punctuation">.</span><span class="token function">collectProcessorsImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        MessageSerializer<span class="token punctuation">.</span><span class="token function">superclassesScope</span><span class="token punctuation">(</span>
            MessageContent<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span>
            SingleMessage<span class="token operator">::</span><span class="token keyword">class</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
            <span class="token function">add</span><span class="token punctuation">(</span>
                <span class="token function">MessageSerializer</span><span class="token punctuation">(</span>
                    OnlineVideoImpl<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                    OnlineVideoImpl<span class="token punctuation">.</span><span class="token function">serializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span> <span class="token comment">// 绑定序列化器</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-添加序列化测试" tabindex="-1"><a class="header-anchor" href="#_9-添加序列化测试" aria-hidden="true">#</a> 9. 添加序列化测试</h3><p>请在第 7 步实现的你的 <code>MessageProtocolTest</code> 中添加 添加序列化测试。</p><p>你可以仿照已有的测试如 <code>TextProtocolTest</code> 等编写你的序列化测试。通常只需要添加一个类似于 <code>TextProtocolTest</code> 的 <code>test serialization for AtAll</code> 的函数即可。</p><h3 id="_10-提交-pr" tabindex="-1"><a class="header-anchor" href="#_10-提交-pr" aria-hidden="true">#</a> 10. 提交 PR</h3><p>恭喜，到这一步你已经实现了高质量的新消息类型的支持。请在 <code>https://github.com/mamoe/mirai/compare</code> 提交 PR，让你的修改能进入 mirai 主分支。感谢你对 mirai 的贡献。</p></div><!--[--><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.cc1a7d3c.js" defer></script>
  </body>
</html>
